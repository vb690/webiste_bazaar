<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2026-11-12">

<title>Hail Risk Estimation and Classification – Bazaar</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-5732d83e2b6a4d0ea9313647c5a03cb2.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner h1,
      .quarto-title-block .quarto-title-banner h2,
      .quarto-title-block .quarto-title-banner h3,
      .quarto-title-block .quarto-title-banner h4,
      .quarto-title-block .quarto-title-banner h5,
      .quarto-title-block .quarto-title-banner h6
      {
        color: #5465ff;
      }

      .quarto-title-block .quarto-title-banner {
        color: #5465ff;
background: #E2FFFF;
      }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Bazaar</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../../posts/tutorials/index.html" aria-current="page"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts/blog_posts/index.html"> 
<span class="menu-text">Blog Posts</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Hail Risk Estimation and Classification</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Hail Risk Estimation and Classification</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">JAX</div>
                <div class="quarto-category">Numpyro</div>
                <div class="quarto-category">Bayesian Statistics</div>
                <div class="quarto-category">Quantile Regression</div>
                <div class="quarto-category">Zero-inflated Regression</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Valerio Bonometti </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 12, 2026</p>
      </div>
    </div>
    
      
    </div>
    
  <div>
    <div class="abstract">
      <div class="block-title">Abstract</div>
      This analysis illustrates how to estimate hourly hail risk in the US with county-level granularity. The analysis poses particular attention to the mitigation of issues arising from small samples.
    </div>
  </div>
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/tutorials/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tutorials</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/blog_posts/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Blog</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="4">
    <h2 id="toc-title">Table of Contents</h2>
   
  <ul>
  <li><a href="#request-description" id="toc-request-description" class="nav-link active" data-scroll-target="#request-description"><span class="header-section-number">0.1</span> Request Description</a></li>
  <li><a href="#sec-hypotheses_investigated" id="toc-sec-hypotheses_investigated" class="nav-link" data-scroll-target="#sec-hypotheses_investigated"><span class="header-section-number">0.2</span> Hypotheses to be investigated</a></li>
  <li><a href="#methodology" id="toc-methodology" class="nav-link" data-scroll-target="#methodology"><span class="header-section-number">1</span> Methodology</a>
  <ul>
  <li><a href="#data-gathering-and-data-description" id="toc-data-gathering-and-data-description" class="nav-link" data-scroll-target="#data-gathering-and-data-description"><span class="header-section-number">1.1</span> Data Gathering and Data Description</a>
  <ul class="collapse">
  <li><a href="#noaa-dataset" id="toc-noaa-dataset" class="nav-link" data-scroll-target="#noaa-dataset"><span class="header-section-number">1.1.1</span> NOAA Dataset</a></li>
  <li><a href="#counties-geometry-dataset" id="toc-counties-geometry-dataset" class="nav-link" data-scroll-target="#counties-geometry-dataset"><span class="header-section-number">1.1.2</span> Counties Geometry Dataset</a></li>
  </ul></li>
  <li><a href="#data-exploration" id="toc-data-exploration" class="nav-link" data-scroll-target="#data-exploration"><span class="header-section-number">1.2</span> Data Exploration</a>
  <ul class="collapse">
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation"><span class="header-section-number">1.2.1</span> Data Preparation</a></li>
  <li><a href="#visualizing-hail-events" id="toc-visualizing-hail-events" class="nav-link" data-scroll-target="#visualizing-hail-events"><span class="header-section-number">1.2.2</span> Visualizing Hail Events</a></li>
  <li><a href="#visualizing-the-characteristics-of-extreme-hail-events" id="toc-visualizing-the-characteristics-of-extreme-hail-events" class="nav-link" data-scroll-target="#visualizing-the-characteristics-of-extreme-hail-events"><span class="header-section-number">1.2.3</span> Visualizing The characteristics of Extreme Hail Events</a></li>
  </ul></li>
  <li><a href="#analyses-conducted" id="toc-analyses-conducted" class="nav-link" data-scroll-target="#analyses-conducted"><span class="header-section-number">1.3</span> Analyses Conducted</a></li>
  <li><a href="#estimating-return-periods-using-extreme-value-analysis" id="toc-estimating-return-periods-using-extreme-value-analysis" class="nav-link" data-scroll-target="#estimating-return-periods-using-extreme-value-analysis"><span class="header-section-number">1.4</span> Estimating Return Periods using Extreme Value Analysis</a>
  <ul class="collapse">
  <li><a href="#individuating-the-extremes" id="toc-individuating-the-extremes" class="nav-link" data-scroll-target="#individuating-the-extremes"><span class="header-section-number">1.4.1</span> Individuating the “Extremes”</a></li>
  <li><a href="#fitting-the-appropriated-distribution" id="toc-fitting-the-appropriated-distribution" class="nav-link" data-scroll-target="#fitting-the-appropriated-distribution"><span class="header-section-number">1.4.2</span> Fitting the Appropriated Distribution</a></li>
  <li><a href="#estimating-the-probability-and-return-period-for-any-extreme-value" id="toc-estimating-the-probability-and-return-period-for-any-extreme-value" class="nav-link" data-scroll-target="#estimating-the-probability-and-return-period-for-any-extreme-value"><span class="header-section-number">1.4.3</span> Estimating the probability and return period for any extreme value</a></li>
  </ul></li>
  <li><a href="#sec-bayesian_regression" id="toc-sec-bayesian_regression" class="nav-link" data-scroll-target="#sec-bayesian_regression"><span class="header-section-number">1.5</span> Estimating Expected Extreme Values and Hail Events using Bayesian Regression</a>
  <ul class="collapse">
  <li><a href="#sec-quantile_regression" id="toc-sec-quantile_regression" class="nav-link" data-scroll-target="#sec-quantile_regression"><span class="header-section-number">1.5.1</span> Estimating Expected Extreme Values Using Quantile Regression</a></li>
  <li><a href="#estimating-the-likelyhood-of-hail-events-using-zero-inflated-negative-binomial-regression" id="toc-estimating-the-likelyhood-of-hail-events-using-zero-inflated-negative-binomial-regression" class="nav-link" data-scroll-target="#estimating-the-likelyhood-of-hail-events-using-zero-inflated-negative-binomial-regression"><span class="header-section-number">1.5.2</span> Estimating the Likelyhood of Hail Events Using Zero-Inflated Negative Binomial Regression</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="results/gif_images/hail_events.gif" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Observed Hail Events</figcaption>
</figure>
</div>
<section id="request-description" class="level2" data-number="0.1">
<h2 data-number="0.1" class="anchored" data-anchor-id="request-description"><span class="header-section-number">0.1</span> Request Description</h2>
<p>This analysis was conducted following a request from DevCo Americas team, in particular Environmental Affairs and Project controls. The stakeholder wanted to know if it was possible to leverage a publicly available dataset from the <a href="https://www.noaa.gov">National Oceanic and Atmospheric Administration</a> (i.e., NOAA) for creating risk categories for Hail Extreme events in the U.S. The request was to perform this classification exercise on the entire U.S. territory with county-level granularity.</p>
</section>
<section id="sec-hypotheses_investigated" class="level2" data-number="0.2">
<h2 data-number="0.2" class="anchored" data-anchor-id="sec-hypotheses_investigated"><span class="header-section-number">0.2</span> Hypotheses to be investigated</h2>
<p>The analysis does not have specific hypotheses to investigate but rather poses some challenges that needs to be overcome while trying to perform the estimation tasks. Here an overview of said challenges:</p>
<ol type="1">
<li><p>In order to estimate the level of risk for a certain county in the U.S. we first needed to obtain a reliable estimate of the probability of an extreme hail event to occur in a given county.</p></li>
<li><p>Due to the nature of extreme hail events, calculating their probability cannot be done by simply evaluating the observed frequency of such events but requires to leverage specific statistical frameworks (e.g., <a href="https://en.wikipedia.org/wiki/Extreme_value_theory">Extreme Value Theory</a>) (i.e., EVA) than can provide long term likelihood for such events (e.g., 100s of years.)</p></li>
<li><p>In order to obtain reliable estimates, EVA usually requires that a sufficiently large number of events have been observed. Unfortunately increasing the level of granularity (i.e., looking at county level) forces to work with small samples. Moreover, this challenge is even more pronounced in those states where the Extreme Hail Events are more rare which are also states where a correct risk assessment is more critical.</p></li>
</ol>
</section>
<section id="methodology" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Methodology</h1>
<p>In this section we will outline our methodology with a particular focus on the data used and the analyses conducted for overcoming the challenges outlined in section <a href="#sec-hypotheses_investigated" class="quarto-xref">Section&nbsp;0.2</a>.</p>
<div id="6b78bf9e" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Show supplementary code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>load_ext watermark</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpyro</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>numpyro.set_host_device_count(os.cpu_count())</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Image</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> product</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> joblib <span class="im">import</span> Parallel, delayed</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jax <span class="im">import</span> vmap</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple, Any, Callable, Dict</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy.typing <span class="im">import</span> ArrayLike</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.axes <span class="im">import</span> Axes</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>SMALL_FONT_SIZE <span class="op">=</span> <span class="dv">12</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>MEDIUM_FONT_SIZE <span class="op">=</span> <span class="dv">15</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>BIGGER_FONT_SIZE <span class="op">=</span> <span class="dv">18</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>SINGLE_STATE <span class="op">=</span> [<span class="st">"florida"</span>]</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co"># hail alley</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>MULTIPLE_STATES <span class="op">=</span> [</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"texas"</span>,</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"oklahoma"</span>,</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kansas"</span>,</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nebraska"</span>,</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"colorado"</span>,</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"missouri"</span>,</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">"iowa"</span>,</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># medium states</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"louisiana"</span>,</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mississippi"</span>,</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alabama"</span>,</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">"florida"</span>,</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dry states</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">"california"</span>,</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">"new mexico"</span>,</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"arizona"</span>,</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>LOWER_CUT_OFF_YEAR <span class="op">=</span> <span class="dv">1999</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>UPPER_CUT_OFF_YEAR <span class="op">=</span> <span class="dv">2024</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>SELECTED_ANALYSIS_STATES <span class="op">=</span> SINGLE_STATE</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>FLOAT_PRECISION <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>DEGREES_PRECISION <span class="op">=</span> <span class="fl">1e-2</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>TIME_COLUMN <span class="op">=</span> <span class="st">"begin_date_time"</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>CONTINUOUS_MODELLING_COLUMNS <span class="op">=</span> [</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>    <span class="st">"year"</span>,</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">"month"</span>,</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hour"</span>,</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">"begin_lat"</span>,</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">"begin_lon"</span>,</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">"state"</span>,</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">"countyfp"</span>,</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">"magnitude"</span>,</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>COUNT_MODELLING_COLUMNS <span class="op">=</span> [</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">"year"</span>,</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>    <span class="st">"month"</span>,</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hour"</span>,</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    <span class="st">"state"</span>,</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>    <span class="st">"countyfp"</span>,</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>NUMBER_ITERATIONS <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>NUMBER_PARTICLES <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>CONTINUOUS_TARGET <span class="op">=</span> <span class="st">"magnitude"</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>COUNT_TARGET <span class="op">=</span> <span class="st">"number_events"</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>LAT_COVARIATES <span class="op">=</span> <span class="st">"begin_lat"</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>LON_COVARIATES <span class="op">=</span> <span class="st">"begin_lon"</span></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>YEAR_COVARIATES <span class="op">=</span> <span class="st">"year"</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>MONTH_COVARIATE <span class="op">=</span> <span class="st">"month"</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>HOUR_COVARIATE <span class="op">=</span> <span class="st">"hour"</span></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>COUNTIES_INDEX <span class="op">=</span> <span class="st">"countyfp"</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>STATE_INDEX <span class="op">=</span> <span class="st">"state"</span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>CRITICAL_VALUE_CONTINUOUS_TARGET <span class="op">=</span> <span class="fl">1.77</span></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>CRITICAL_VALUE_COUNT_TARGET <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>CRITICAL_QUANTILE <span class="op">=</span> <span class="fl">0.95</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>COLORMAP_NAME <span class="op">=</span> <span class="st">"Blues"</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>COLORMAP <span class="op">=</span> mpl.colormaps[COLORMAP_NAME].resampled(<span class="dv">5</span>)</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>DATA_PATH <span class="op">=</span> Path(<span class="st">"local_data"</span>)</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>RESULTS_PATH <span class="op">=</span> Path(<span class="st">"results"</span>)</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>GIFS_PATH <span class="op">=</span> Path(RESULTS_PATH, <span class="st">"gif_images"</span>)</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>IMAGES_PATH <span class="op">=</span> Path(RESULTS_PATH, <span class="st">"images"</span>)</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>plt.rc(<span class="st">'font'</span>, size<span class="op">=</span>SMALL_FONT_SIZE) </span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>plt.rc(<span class="st">'axes'</span>, titlesize<span class="op">=</span>MEDIUM_FONT_SIZE)</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>plt.rc(<span class="st">'axes'</span>, labelsize<span class="op">=</span>SMALL_FONT_SIZE)</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>plt.rc(<span class="st">'xtick'</span>, labelsize<span class="op">=</span>SMALL_FONT_SIZE)</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>plt.rc(<span class="st">'ytick'</span>, labelsize<span class="op">=</span>SMALL_FONT_SIZE)</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>plt.rc(<span class="st">'legend'</span>, fontsize<span class="op">=</span>SMALL_FONT_SIZE)    </span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>plt.rc(<span class="st">'figure'</span>, titlesize<span class="op">=</span>BIGGER_FONT_SIZE)</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>plt.rc(<span class="st">'figure'</span>, dpi<span class="op">=</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="data-gathering-and-data-description" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="data-gathering-and-data-description"><span class="header-section-number">1.1</span> Data Gathering and Data Description</h2>
<p>In this paragraph we will provide an overview of the data employed in this analysis:</p>
<ol type="1">
<li>The dataset from NOAA containing records of hail events.</li>
<li>The <a href="https://geopandas.org/en/stable/gallery/create_geopandas_from_pandas.html">geo-dataframe</a> used for mapping hail events onto U.S. counties.</li>
</ol>
<section id="noaa-dataset" class="level3" data-number="1.1.1">
<h3 data-number="1.1.1" class="anchored" data-anchor-id="noaa-dataset"><span class="header-section-number">1.1.1</span> NOAA Dataset</h3>
<p>The dataset we used for conducting this analysis is the <a href="https://www.ncdc.noaa.gov/stormevents/">Storm Event Database</a>. This dataset contains records that documents:</p>
<ol type="1">
<li>The occurrence of storms and other significant weather phenomena.</li>
<li>Rare, unusual, weather phenomena</li>
<li>Other significant meteorological events</li>
</ol>
<p>A common characteristic of these events is being so intense or exceptional so to cause potential damage to people, structure and causing disruption to commerce. The database contains data from 1950 until 2024. However due to changes in the record, measurement and collection strategy the portion containing detailed and reliable information is limited to the interval 1996 - 2024. This is also the portion of the dataset that we have used for our analyses.</p>
</section>
<section id="counties-geometry-dataset" class="level3" data-number="1.1.2">
<h3 data-number="1.1.2" class="anchored" data-anchor-id="counties-geometry-dataset"><span class="header-section-number">1.1.2</span> Counties Geometry Dataset</h3>
<p>In order to to map and visualize our analysis onto the U.S. territory (and counties in particular) we obtained a geo-dataframe containing geometry files for each state in the U.S. This dataset was not used just for visualization purposes but it also played an important role in the estimation of extreme hail events at county level (more details will be given in section <a href="#sec-quantile_regression" class="quarto-xref">Section&nbsp;1.5.1</a>.)</p>
</section>
</section>
<section id="data-exploration" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="data-exploration"><span class="header-section-number">1.2</span> Data Exploration</h2>
<p>In this section we will outline a few key characteristics of hail events as a phenomena, putting particular attention on those characteristics that makes necessary the use of particular statistical framework for addressing the challenges we have outlined in <a href="#sec-hypotheses_investigated" class="quarto-xref">Section&nbsp;0.2</a>. Due to space constrains we will report here only the results for the state of Florida.</p>
<p>The state of Florida perfectly illustrates the challenges of estimating extreme hail events in liminal situations: in states like California and Texas the risk assessment becomes easier due to either the complete absence or the abundance of hail events. Florida on the other end seems to have a much more nuanced risk profile.</p>
<section id="data-preparation" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1" class="anchored" data-anchor-id="data-preparation"><span class="header-section-number">1.2.1</span> Data Preparation</h3>
<p>In this section we will prepare the data for further analysis, mostly focusing on creating datasets that are suitable for the different types of statistical approaches we want to try.</p>
<div id="6e6d4c23" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Show supplementary code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyextremes <span class="im">import</span> get_extremes</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pad_dataset(</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    df: pd.DataFrame,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    categorical_columns: List[<span class="bu">str</span>],</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    fill_value: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.0</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Pad a dataset over all the dimensions defined by indexing columns filling the missing</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">    entries with fill_value.</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    new_index <span class="op">=</span> <span class="bu">list</span>([df[column].unique() <span class="cf">for</span> column <span class="kw">in</span> categorical_columns])</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    new_index <span class="op">=</span> product(<span class="op">*</span>new_index)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.set_index(keys<span class="op">=</span>categorical_columns)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.reindex(new_index).fillna(fill_value).reset_index()</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_grid(polygon: Any, edge_size: <span class="bu">float</span>) <span class="op">-&gt;</span> gpd.GeoSeries:</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create a grid of the size of polygon made of squares of size edge_size"""</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    bounds <span class="op">=</span> polygon.bounds</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    x_coords <span class="op">=</span> np.arange(bounds[<span class="dv">0</span>] <span class="op">+</span> edge_size <span class="op">/</span> <span class="dv">2</span>, bounds[<span class="dv">2</span>], edge_size)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    y_coords <span class="op">=</span> np.arange(bounds[<span class="dv">1</span>] <span class="op">+</span> edge_size <span class="op">/</span> <span class="dv">2</span>, bounds[<span class="dv">3</span>], edge_size)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    combinations <span class="op">=</span> np.array(<span class="bu">list</span>(product(x_coords, y_coords)))</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    squares <span class="op">=</span> gpd.points_from_xy(combinations[:, <span class="dv">0</span>], combinations[:, <span class="dv">1</span>]).<span class="bu">buffer</span>(</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>        edge_size <span class="op">/</span> <span class="dv">1</span>, cap_style<span class="op">=</span><span class="dv">3</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gpd.GeoSeries(squares[squares.intersects(polygon)])</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_grid_df(</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    geometries_df: gpd.GeoDataFrame,</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    edge_size: <span class="bu">float</span>,</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    state: List[<span class="bu">str</span>] <span class="op">=</span> SELECTED_ANALYSIS_STATES,</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> gpd.GeoDataFrame:</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generate a geod-dataframe made of giddified polygons"""</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    state_geometries_df <span class="op">=</span> geometries_df[</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>        geometries_df[STATE_INDEX].<span class="bu">str</span>.lower().isin([s <span class="cf">for</span> s <span class="kw">in</span> state])</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    grid_df <span class="op">=</span> []</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    list_counties_fp <span class="op">=</span> state_geometries_df[COUNTIES_INDEX].values</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    list_states_fp <span class="op">=</span> state_geometries_df[STATE_INDEX].values</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    list_geometries <span class="op">=</span> state_geometries_df[<span class="st">"geometry"</span>].values</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> countyfp, state, geometry <span class="kw">in</span> <span class="bu">zip</span>(</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>        list_counties_fp, list_states_fp, list_geometries</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>        generated_grid <span class="op">=</span> make_grid(geometry, edge_size<span class="op">=</span>edge_size)</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>        grid_df.append(</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>            pd.DataFrame(</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>                    COUNTIES_INDEX: countyfp,</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>                    STATE_INDEX: state,</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"geometry"</span>: generated_grid,</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>    grid_df <span class="op">=</span> gpd.GeoDataFrame(pd.concat(grid_df))</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>    grid_df[<span class="st">"begin_lat"</span>] <span class="op">=</span> grid_df[<span class="st">"geometry"</span>].centroid.y.<span class="bu">round</span>(FLOAT_PRECISION)</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>    grid_df[<span class="st">"begin_lon"</span>] <span class="op">=</span> grid_df[<span class="st">"geometry"</span>].centroid.x.<span class="bu">round</span>(FLOAT_PRECISION)</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> grid_df</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> split_dataset(</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>    df: pd.DataFrame,</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>    ordering_columns: List[<span class="bu">str</span>],</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>    split_fraction: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.33</span>,</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[pd.DataFrame, pd.DataFrame]:</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Split dataset in two portions"""</span></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values(ordering_columns)</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    cut_off <span class="op">=</span> <span class="bu">int</span>(<span class="bu">len</span>(df) <span class="op">*</span> split_fraction)</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df[:<span class="op">-</span>cut_off].copy(), df[<span class="op">-</span>cut_off:].copy()</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> perform_dithering(</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    magnitudes: ArrayLike,</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>    cap: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>    dithering_coefficient: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.147</span>,</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>    dithering_bias: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.0279</span>,</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> ArrayLike:</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Perform dithering following the procedure in</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a><span class="co">    https://www.columbia.edu/~mkt14/publications/MWR-final-hailsize.pdf</span></span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>    dithering_amounts <span class="op">=</span> dithering_bias <span class="op">+</span> dithering_coefficient <span class="op">*</span> magnitudes</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>    dithering_amounts <span class="op">=</span> np.clip(dithering_amounts, a_min<span class="op">=</span><span class="fl">0.0</span>, a_max<span class="op">=</span>cap)</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>    dithering_noise <span class="op">=</span> np.random.uniform(<span class="op">-</span>dithering_amounts, dithering_amounts)</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>    dithered_magnitudes <span class="op">=</span> np.clip(magnitudes <span class="op">+</span> dithering_noise, <span class="dv">0</span>, <span class="va">None</span>)</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dithered_magnitudes</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_time_series_continuous(</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>    series: pd.Series, start: <span class="bu">str</span>, end: <span class="bu">str</span>, frequency: <span class="bu">str</span></span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Make a time series continuous and pad the missing values with zeros"""</span></span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>    new_index <span class="op">=</span> pd.date_range(start<span class="op">=</span>start, end<span class="op">=</span>end, freq<span class="op">=</span>frequency)</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> series.reindex(new_index, fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> downscale_coordinates(</span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>    values: ArrayLike, precision: <span class="bu">int</span>, degree_resolution: <span class="bu">float</span></span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> ArrayLike:</span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Downscale latitude and longitude coordinate to a certain degree resolution."""</span></span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.<span class="bu">round</span>(degree_resolution <span class="op">*</span> np.<span class="bu">round</span>(values <span class="op">/</span> degree_resolution), precision)</span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_covariates_df(</span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>    geometries_df: gpd.GeoDataFrame,</span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>    edge_size: <span class="bu">float</span>,</span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>    state: List[<span class="bu">str</span>],</span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>    months: List[<span class="bu">int</span>],</span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>    hours: List[<span class="bu">int</span>],</span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>    years: List[<span class="bu">int</span>],</span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> gpd.GeoDataFrame:</span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create a dataframe of covariates for inference"""</span></span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>    covariates_df <span class="op">=</span> []</span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>    grid_df <span class="op">=</span> generate_grid_df(</span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a>        geometries_df<span class="op">=</span>geometries_df,</span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a>        edge_size<span class="op">=</span>edge_size,</span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>        state<span class="op">=</span>state,</span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> year, month, hour <span class="kw">in</span> <span class="bu">list</span>(product(years, months, hours)):</span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>        timed_grid_df <span class="op">=</span> grid_df.copy()</span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a>        timed_grid_df[<span class="st">"year"</span>] <span class="op">=</span> year</span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>        timed_grid_df[<span class="st">"month"</span>] <span class="op">=</span> month</span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a>        timed_grid_df[<span class="st">"hour"</span>] <span class="op">=</span> hour</span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>        covariates_df.append(timed_grid_df)</span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>    covariates_df <span class="op">=</span> pd.concat(covariates_df)</span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>    covariates_df <span class="op">=</span> gpd.GeoDataFrame(covariates_df)</span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> covariates_df</span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_maxima_dataset(</span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a>    df: pd.DataFrame, grouping_columns: List[<span class="bu">str</span>], value_column: <span class="bu">str</span></span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create the dataset for fitting gen-extreme data"""</span></span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a>    maxima_df <span class="op">=</span> df[grouping_columns <span class="op">+</span> [value_column]].copy()</span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a>    maxima_df <span class="op">=</span> maxima_df.groupby(grouping_columns)[value_column].<span class="bu">max</span>().reset_index()</span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> maxima_df</span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_extremes_in_blocks(</span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>    maxima_df: pd.Series,</span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a>    county_fp: <span class="bu">str</span>,</span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a>    state_fp,</span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a>    start: <span class="bu">str</span>,</span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a>    end: <span class="bu">str</span>,</span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Extract the extreme values using either Point of Threshold or Block Maxima"""</span></span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a>    maxima_df <span class="op">=</span> make_time_series_continuous(</span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a>        series<span class="op">=</span>maxima_df,</span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a>        start<span class="op">=</span>start,</span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a>        end<span class="op">=</span>end,</span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a>        frequency<span class="op">=</span><span class="st">"1h"</span>,</span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a>    extremes <span class="op">=</span> get_extremes(</span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a>        ts<span class="op">=</span>maxima_df,</span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a>        method<span class="op">=</span><span class="st">"BM"</span>,</span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a>    extremes <span class="op">=</span> extremes.reset_index()</span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a>    extremes[COUNTIES_INDEX] <span class="op">=</span> county_fp</span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a>    extremes[STATE_INDEX] <span class="op">=</span> state_fp</span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> extremes</span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_eva_dataset(</span>
<span id="cb2-174"><a href="#cb2-174" aria-hidden="true" tabindex="-1"></a>    modelling_df: pd.DataFrame, geometries_df: gpd.GeoDataFrame</span>
<span id="cb2-175"><a href="#cb2-175" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb2-176"><a href="#cb2-176" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create a dataset used for Extreme Value Analysis"""</span></span>
<span id="cb2-177"><a href="#cb2-177" aria-hidden="true" tabindex="-1"></a>    maxima_data <span class="op">=</span> create_maxima_dataset(</span>
<span id="cb2-178"><a href="#cb2-178" aria-hidden="true" tabindex="-1"></a>        df<span class="op">=</span>modelling_df,</span>
<span id="cb2-179"><a href="#cb2-179" aria-hidden="true" tabindex="-1"></a>        grouping_columns<span class="op">=</span>[TIME_COLUMN, STATE_INDEX, COUNTIES_INDEX],</span>
<span id="cb2-180"><a href="#cb2-180" aria-hidden="true" tabindex="-1"></a>        value_column<span class="op">=</span>CONTINUOUS_TARGET,</span>
<span id="cb2-181"><a href="#cb2-181" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-182"><a href="#cb2-182" aria-hidden="true" tabindex="-1"></a>    grouped <span class="op">=</span> maxima_data.groupby([COUNTIES_INDEX, STATE_INDEX])</span>
<span id="cb2-183"><a href="#cb2-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-184"><a href="#cb2-184" aria-hidden="true" tabindex="-1"></a>    list_df <span class="op">=</span> [group.set_index(TIME_COLUMN)[CONTINUOUS_TARGET] <span class="cf">for</span> _, group <span class="kw">in</span> grouped]</span>
<span id="cb2-185"><a href="#cb2-185" aria-hidden="true" tabindex="-1"></a>    list_category_names <span class="op">=</span> grouped.groups.keys()</span>
<span id="cb2-186"><a href="#cb2-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-187"><a href="#cb2-187" aria-hidden="true" tabindex="-1"></a>    partialized_get_extremes_df <span class="op">=</span> partial(</span>
<span id="cb2-188"><a href="#cb2-188" aria-hidden="true" tabindex="-1"></a>        get_extremes_in_blocks,</span>
<span id="cb2-189"><a href="#cb2-189" aria-hidden="true" tabindex="-1"></a>        start<span class="op">=</span>maxima_data[TIME_COLUMN].<span class="bu">min</span>(),</span>
<span id="cb2-190"><a href="#cb2-190" aria-hidden="true" tabindex="-1"></a>        end<span class="op">=</span>maxima_data[TIME_COLUMN].<span class="bu">max</span>(),</span>
<span id="cb2-191"><a href="#cb2-191" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-192"><a href="#cb2-192" aria-hidden="true" tabindex="-1"></a>    eva_df <span class="op">=</span> Parallel(n_jobs<span class="op">=-</span><span class="dv">1</span>)(</span>
<span id="cb2-193"><a href="#cb2-193" aria-hidden="true" tabindex="-1"></a>        delayed(partialized_get_extremes_df)(data, county_fp, state_fp)</span>
<span id="cb2-194"><a href="#cb2-194" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> data, (county_fp, state_fp) <span class="kw">in</span> <span class="bu">zip</span>(list_df, list_category_names)</span>
<span id="cb2-195"><a href="#cb2-195" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-196"><a href="#cb2-196" aria-hidden="true" tabindex="-1"></a>    eva_df: pd.DataFrame <span class="op">=</span> pd.concat(eva_df)</span>
<span id="cb2-197"><a href="#cb2-197" aria-hidden="true" tabindex="-1"></a>    eva_df[CONTINUOUS_TARGET] <span class="op">=</span> eva_df[CONTINUOUS_TARGET].replace(</span>
<span id="cb2-198"><a href="#cb2-198" aria-hidden="true" tabindex="-1"></a>        to_replace<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb2-199"><a href="#cb2-199" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>eva_df[CONTINUOUS_TARGET].mean(),</span>
<span id="cb2-200"><a href="#cb2-200" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-201"><a href="#cb2-201" aria-hidden="true" tabindex="-1"></a>    eva_df <span class="op">=</span> eva_df.rename({<span class="st">"date-time"</span>: TIME_COLUMN}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb2-202"><a href="#cb2-202" aria-hidden="true" tabindex="-1"></a>    eva_df <span class="op">=</span> pd.merge(</span>
<span id="cb2-203"><a href="#cb2-203" aria-hidden="true" tabindex="-1"></a>        eva_df,</span>
<span id="cb2-204"><a href="#cb2-204" aria-hidden="true" tabindex="-1"></a>        geometries_df[[COUNTIES_INDEX, STATE_INDEX, <span class="st">"geometry"</span>]].drop_duplicates(),</span>
<span id="cb2-205"><a href="#cb2-205" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[COUNTIES_INDEX, STATE_INDEX],</span>
<span id="cb2-206"><a href="#cb2-206" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"inner"</span>,</span>
<span id="cb2-207"><a href="#cb2-207" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-208"><a href="#cb2-208" aria-hidden="true" tabindex="-1"></a>    eva_df <span class="op">=</span> pd.merge(</span>
<span id="cb2-209"><a href="#cb2-209" aria-hidden="true" tabindex="-1"></a>        eva_df,</span>
<span id="cb2-210"><a href="#cb2-210" aria-hidden="true" tabindex="-1"></a>        modelling_df[[<span class="st">"county"</span>, COUNTIES_INDEX, STATE_INDEX]].drop_duplicates(),</span>
<span id="cb2-211"><a href="#cb2-211" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[COUNTIES_INDEX, STATE_INDEX],</span>
<span id="cb2-212"><a href="#cb2-212" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"inner"</span>,</span>
<span id="cb2-213"><a href="#cb2-213" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-214"><a href="#cb2-214" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> eva_df</span>
<span id="cb2-215"><a href="#cb2-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-216"><a href="#cb2-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-217"><a href="#cb2-217" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_continuous_dataset(</span>
<span id="cb2-218"><a href="#cb2-218" aria-hidden="true" tabindex="-1"></a>    modelling_df: pd.DataFrame, geometries_df: gpd.GeoDataFrame</span>
<span id="cb2-219"><a href="#cb2-219" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb2-220"><a href="#cb2-220" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create a dataset for continuous modelling"""</span></span>
<span id="cb2-221"><a href="#cb2-221" aria-hidden="true" tabindex="-1"></a>    continuous_modelling_df <span class="op">=</span> modelling_df[CONTINUOUS_MODELLING_COLUMNS <span class="op">+</span> [<span class="st">"begin_date_time"</span>]].copy()</span>
<span id="cb2-222"><a href="#cb2-222" aria-hidden="true" tabindex="-1"></a>    continuous_modelling_df <span class="op">=</span> (</span>
<span id="cb2-223"><a href="#cb2-223" aria-hidden="true" tabindex="-1"></a>        continuous_modelling_df.groupby(</span>
<span id="cb2-224"><a href="#cb2-224" aria-hidden="true" tabindex="-1"></a>            <span class="bu">list</span>(continuous_modelling_df.drop(CONTINUOUS_TARGET, axis<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb2-225"><a href="#cb2-225" aria-hidden="true" tabindex="-1"></a>        )[CONTINUOUS_TARGET]</span>
<span id="cb2-226"><a href="#cb2-226" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">max</span>()</span>
<span id="cb2-227"><a href="#cb2-227" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb2-228"><a href="#cb2-228" aria-hidden="true" tabindex="-1"></a>        .drop(<span class="st">"begin_date_time"</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb2-229"><a href="#cb2-229" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-230"><a href="#cb2-230" aria-hidden="true" tabindex="-1"></a>    continuous_modelling_df <span class="op">=</span> pd.merge(</span>
<span id="cb2-231"><a href="#cb2-231" aria-hidden="true" tabindex="-1"></a>        continuous_modelling_df,</span>
<span id="cb2-232"><a href="#cb2-232" aria-hidden="true" tabindex="-1"></a>        geometries_df[[COUNTIES_INDEX, STATE_INDEX, <span class="st">"geometry"</span>]],</span>
<span id="cb2-233"><a href="#cb2-233" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[COUNTIES_INDEX, STATE_INDEX],</span>
<span id="cb2-234"><a href="#cb2-234" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"inner"</span>,</span>
<span id="cb2-235"><a href="#cb2-235" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-236"><a href="#cb2-236" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> continuous_modelling_df</span>
<span id="cb2-237"><a href="#cb2-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-238"><a href="#cb2-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-239"><a href="#cb2-239" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_count_dataset(</span>
<span id="cb2-240"><a href="#cb2-240" aria-hidden="true" tabindex="-1"></a>    modelling_df: pd.DataFrame, geometries_df: gpd.GeoDataFrame</span>
<span id="cb2-241"><a href="#cb2-241" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> gpd.GeoDataFrame:</span>
<span id="cb2-242"><a href="#cb2-242" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create a dataset for count modelling"""</span></span>
<span id="cb2-243"><a href="#cb2-243" aria-hidden="true" tabindex="-1"></a>    count_modelling_df <span class="op">=</span> modelling_df[</span>
<span id="cb2-244"><a href="#cb2-244" aria-hidden="true" tabindex="-1"></a>        [</span>
<span id="cb2-245"><a href="#cb2-245" aria-hidden="true" tabindex="-1"></a>            <span class="st">"county"</span>,</span>
<span id="cb2-246"><a href="#cb2-246" aria-hidden="true" tabindex="-1"></a>            <span class="st">"begin_date_time"</span>,</span>
<span id="cb2-247"><a href="#cb2-247" aria-hidden="true" tabindex="-1"></a>            <span class="st">"year"</span>,</span>
<span id="cb2-248"><a href="#cb2-248" aria-hidden="true" tabindex="-1"></a>            <span class="st">"month"</span>,</span>
<span id="cb2-249"><a href="#cb2-249" aria-hidden="true" tabindex="-1"></a>            <span class="st">"hour"</span>,</span>
<span id="cb2-250"><a href="#cb2-250" aria-hidden="true" tabindex="-1"></a>            <span class="st">"state"</span>,</span>
<span id="cb2-251"><a href="#cb2-251" aria-hidden="true" tabindex="-1"></a>            COUNTIES_INDEX,</span>
<span id="cb2-252"><a href="#cb2-252" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb2-253"><a href="#cb2-253" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb2-254"><a href="#cb2-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-255"><a href="#cb2-255" aria-hidden="true" tabindex="-1"></a>    count_modelling_df <span class="op">=</span> (</span>
<span id="cb2-256"><a href="#cb2-256" aria-hidden="true" tabindex="-1"></a>        count_modelling_df.groupby(</span>
<span id="cb2-257"><a href="#cb2-257" aria-hidden="true" tabindex="-1"></a>            [</span>
<span id="cb2-258"><a href="#cb2-258" aria-hidden="true" tabindex="-1"></a>                <span class="st">"county"</span>,</span>
<span id="cb2-259"><a href="#cb2-259" aria-hidden="true" tabindex="-1"></a>                <span class="st">"begin_date_time"</span>,</span>
<span id="cb2-260"><a href="#cb2-260" aria-hidden="true" tabindex="-1"></a>                <span class="st">"year"</span>,</span>
<span id="cb2-261"><a href="#cb2-261" aria-hidden="true" tabindex="-1"></a>                <span class="st">"month"</span>,</span>
<span id="cb2-262"><a href="#cb2-262" aria-hidden="true" tabindex="-1"></a>                <span class="st">"hour"</span>,</span>
<span id="cb2-263"><a href="#cb2-263" aria-hidden="true" tabindex="-1"></a>                <span class="st">"state"</span>,</span>
<span id="cb2-264"><a href="#cb2-264" aria-hidden="true" tabindex="-1"></a>                COUNTIES_INDEX,</span>
<span id="cb2-265"><a href="#cb2-265" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb2-266"><a href="#cb2-266" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-267"><a href="#cb2-267" aria-hidden="true" tabindex="-1"></a>        .size()</span>
<span id="cb2-268"><a href="#cb2-268" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb2-269"><a href="#cb2-269" aria-hidden="true" tabindex="-1"></a>        .rename({<span class="dv">0</span>: COUNT_TARGET}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb2-270"><a href="#cb2-270" aria-hidden="true" tabindex="-1"></a>        .groupby(COUNT_MODELLING_COLUMNS)[COUNT_TARGET]</span>
<span id="cb2-271"><a href="#cb2-271" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">max</span>()</span>
<span id="cb2-272"><a href="#cb2-272" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb2-273"><a href="#cb2-273" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-274"><a href="#cb2-274" aria-hidden="true" tabindex="-1"></a>    count_modelling_df <span class="op">=</span> pad_dataset(</span>
<span id="cb2-275"><a href="#cb2-275" aria-hidden="true" tabindex="-1"></a>        df<span class="op">=</span>count_modelling_df,</span>
<span id="cb2-276"><a href="#cb2-276" aria-hidden="true" tabindex="-1"></a>        categorical_columns<span class="op">=</span>COUNT_MODELLING_COLUMNS,</span>
<span id="cb2-277"><a href="#cb2-277" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-278"><a href="#cb2-278" aria-hidden="true" tabindex="-1"></a>    count_modelling_df <span class="op">=</span> pd.merge(</span>
<span id="cb2-279"><a href="#cb2-279" aria-hidden="true" tabindex="-1"></a>        count_modelling_df,</span>
<span id="cb2-280"><a href="#cb2-280" aria-hidden="true" tabindex="-1"></a>        geometries_df[[COUNTIES_INDEX, STATE_INDEX, <span class="st">"geometry"</span>]],</span>
<span id="cb2-281"><a href="#cb2-281" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[COUNTIES_INDEX, STATE_INDEX],</span>
<span id="cb2-282"><a href="#cb2-282" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"inner"</span>,</span>
<span id="cb2-283"><a href="#cb2-283" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-284"><a href="#cb2-284" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> count_modelling_df</span>
<span id="cb2-285"><a href="#cb2-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-286"><a href="#cb2-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-287"><a href="#cb2-287" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_all_datasets(</span>
<span id="cb2-288"><a href="#cb2-288" aria-hidden="true" tabindex="-1"></a>    modelling_df: pd.DataFrame,</span>
<span id="cb2-289"><a href="#cb2-289" aria-hidden="true" tabindex="-1"></a>    geometries_df: gpd.GeoDataFrame,</span>
<span id="cb2-290"><a href="#cb2-290" aria-hidden="true" tabindex="-1"></a>    state: List[<span class="bu">str</span>] <span class="op">=</span> SELECTED_ANALYSIS_STATES,</span>
<span id="cb2-291"><a href="#cb2-291" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[pd.DataFrame, pd.DataFrame, pd.DataFrame]:</span>
<span id="cb2-292"><a href="#cb2-292" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create all dataset required for the notebook"""</span></span>
<span id="cb2-293"><a href="#cb2-293" aria-hidden="true" tabindex="-1"></a>    state_modelling_df <span class="op">=</span> modelling_df[modelling_df[<span class="st">"state"</span>].isin(state)].copy()</span>
<span id="cb2-294"><a href="#cb2-294" aria-hidden="true" tabindex="-1"></a>    continuous_state_modelling_df <span class="op">=</span> create_continuous_dataset(</span>
<span id="cb2-295"><a href="#cb2-295" aria-hidden="true" tabindex="-1"></a>        modelling_df<span class="op">=</span>state_modelling_df,</span>
<span id="cb2-296"><a href="#cb2-296" aria-hidden="true" tabindex="-1"></a>        geometries_df<span class="op">=</span>geometries_df,</span>
<span id="cb2-297"><a href="#cb2-297" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-298"><a href="#cb2-298" aria-hidden="true" tabindex="-1"></a>    count_state_modelling_df <span class="op">=</span> create_count_dataset(</span>
<span id="cb2-299"><a href="#cb2-299" aria-hidden="true" tabindex="-1"></a>        modelling_df<span class="op">=</span>state_modelling_df,</span>
<span id="cb2-300"><a href="#cb2-300" aria-hidden="true" tabindex="-1"></a>        geometries_df<span class="op">=</span>geometries_df,</span>
<span id="cb2-301"><a href="#cb2-301" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-302"><a href="#cb2-302" aria-hidden="true" tabindex="-1"></a>    eva_state_modelling_df <span class="op">=</span> create_eva_dataset(</span>
<span id="cb2-303"><a href="#cb2-303" aria-hidden="true" tabindex="-1"></a>        modelling_df<span class="op">=</span>state_modelling_df,</span>
<span id="cb2-304"><a href="#cb2-304" aria-hidden="true" tabindex="-1"></a>        geometries_df<span class="op">=</span>geometries_df,</span>
<span id="cb2-305"><a href="#cb2-305" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-306"><a href="#cb2-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-307"><a href="#cb2-307" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb2-308"><a href="#cb2-308" aria-hidden="true" tabindex="-1"></a>        continuous_state_modelling_df,</span>
<span id="cb2-309"><a href="#cb2-309" aria-hidden="true" tabindex="-1"></a>        count_state_modelling_df,</span>
<span id="cb2-310"><a href="#cb2-310" aria-hidden="true" tabindex="-1"></a>        eva_state_modelling_df,</span>
<span id="cb2-311"><a href="#cb2-311" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>As a first step we read and pre-process the data used for modelling in general</p>
<div id="f5703a8f" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>modelling_df <span class="op">=</span> pd.read_parquet(Path(DATA_PATH, <span class="st">"modelling_df.parquet"</span>))</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>modelling_df[<span class="st">"state"</span>] <span class="op">=</span> modelling_df[<span class="st">"state"</span>].<span class="bu">apply</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: [i.lower() <span class="cf">for</span> i <span class="kw">in</span> x.split(<span class="st">" "</span>)]</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>modelling_df[<span class="st">"state"</span>] <span class="op">=</span> modelling_df[<span class="st">"state"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="st">"_"</span>.join(x))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>modelling_df <span class="op">=</span> modelling_df.rename({<span class="st">"yearly"</span>: <span class="st">"year"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>modelling_df[<span class="st">"begin_lat"</span>] <span class="op">=</span> modelling_df[<span class="st">"begin_lat"</span>].values.<span class="bu">round</span>(FLOAT_PRECISION)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>modelling_df[<span class="st">"begin_lon"</span>] <span class="op">=</span> modelling_df[<span class="st">"begin_lon"</span>].values.<span class="bu">round</span>(FLOAT_PRECISION)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>modelling_df[<span class="st">"magnitude"</span>] <span class="op">=</span> perform_dithering(</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    magnitudes<span class="op">=</span>modelling_df[<span class="st">"magnitude"</span>].values</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>modelling_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">county</th>
<th data-quarto-table-cell-role="th">begin_lat</th>
<th data-quarto-table-cell-role="th">begin_lon</th>
<th data-quarto-table-cell-role="th">begin_date_time</th>
<th data-quarto-table-cell-role="th">countyfp</th>
<th data-quarto-table-cell-role="th">statefp</th>
<th data-quarto-table-cell-role="th">countyfp_nozero</th>
<th data-quarto-table-cell-role="th">magnitude</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">monthly</th>
<th data-quarto-table-cell-role="th">daily</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">time_index</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>abbeville</td>
<td>34.09</td>
<td>-82.60</td>
<td>2009-04-10 19:00:00</td>
<td>001</td>
<td>45</td>
<td>1</td>
<td>1.491996</td>
<td>south_carolina</td>
<td>2009-04-06</td>
<td>2009-04-10</td>
<td>2009</td>
<td>4</td>
<td>19</td>
<td>116353</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>abbeville</td>
<td>34.09</td>
<td>-82.59</td>
<td>2010-03-28 19:00:00</td>
<td>001</td>
<td>45</td>
<td>1</td>
<td>0.933026</td>
<td>south_carolina</td>
<td>2010-03-02</td>
<td>2010-03-28</td>
<td>2010</td>
<td>3</td>
<td>19</td>
<td>124801</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>abbeville</td>
<td>34.09</td>
<td>-82.59</td>
<td>2010-04-25 01:00:00</td>
<td>001</td>
<td>45</td>
<td>1</td>
<td>2.002821</td>
<td>south_carolina</td>
<td>2010-04-01</td>
<td>2010-04-25</td>
<td>2010</td>
<td>4</td>
<td>1</td>
<td>125455</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>abbeville</td>
<td>34.10</td>
<td>-82.62</td>
<td>1998-06-09 16:00:00</td>
<td>001</td>
<td>45</td>
<td>1</td>
<td>1.143295</td>
<td>south_carolina</td>
<td>1998-06-03</td>
<td>1998-06-09</td>
<td>1998</td>
<td>6</td>
<td>16</td>
<td>21358</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>abbeville</td>
<td>34.10</td>
<td>-82.60</td>
<td>1997-04-22 14:00:00</td>
<td>001</td>
<td>45</td>
<td>1</td>
<td>0.810593</td>
<td>south_carolina</td>
<td>1997-04-09</td>
<td>1997-04-22</td>
<td>1997</td>
<td>4</td>
<td>14</td>
<td>11444</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">310393</td>
<td>ziebach</td>
<td>45.40</td>
<td>-101.86</td>
<td>2013-07-23 18:00:00</td>
<td>137</td>
<td>46</td>
<td>137</td>
<td>1.811021</td>
<td>south_dakota</td>
<td>2013-07-14</td>
<td>2013-07-23</td>
<td>2013</td>
<td>7</td>
<td>18</td>
<td>153912</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">310394</td>
<td>ziebach</td>
<td>45.42</td>
<td>-101.81</td>
<td>2019-09-29 22:00:00</td>
<td>137</td>
<td>46</td>
<td>137</td>
<td>0.906396</td>
<td>south_dakota</td>
<td>2019-09-11</td>
<td>2019-09-29</td>
<td>2019</td>
<td>9</td>
<td>22</td>
<td>208132</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">310395</td>
<td>ziebach</td>
<td>45.47</td>
<td>-101.65</td>
<td>2003-07-03 22:00:00</td>
<td>137</td>
<td>46</td>
<td>137</td>
<td>0.675737</td>
<td>south_dakota</td>
<td>2003-06-07</td>
<td>2003-07-03</td>
<td>2003</td>
<td>7</td>
<td>22</td>
<td>65764</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">310396</td>
<td>ziebach</td>
<td>45.47</td>
<td>-101.65</td>
<td>2008-07-18 18:00:00</td>
<td>137</td>
<td>46</td>
<td>137</td>
<td>1.624055</td>
<td>south_dakota</td>
<td>2008-07-10</td>
<td>2008-07-18</td>
<td>2008</td>
<td>7</td>
<td>18</td>
<td>109968</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">310397</td>
<td>ziebach</td>
<td>45.47</td>
<td>-101.65</td>
<td>2008-07-23 15:00:00</td>
<td>137</td>
<td>46</td>
<td>137</td>
<td>1.665959</td>
<td>south_dakota</td>
<td>2008-07-10</td>
<td>2008-07-23</td>
<td>2008</td>
<td>7</td>
<td>15</td>
<td>110085</td>
</tr>
</tbody>
</table>

<p>310398 rows × 15 columns</p>
</div>
</div>
</div>
<div id="294cc547" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>modelling_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 310398 entries, 0 to 310397
Data columns (total 15 columns):
 #   Column           Non-Null Count   Dtype         
---  ------           --------------   -----         
 0   county           310398 non-null  object        
 1   begin_lat        310398 non-null  float64       
 2   begin_lon        310398 non-null  float64       
 3   begin_date_time  310398 non-null  datetime64[ns]
 4   countyfp         310398 non-null  object        
 5   statefp          310398 non-null  object        
 6   countyfp_nozero  310398 non-null  object        
 7   magnitude        310398 non-null  float64       
 8   state            310398 non-null  object        
 9   monthly          310398 non-null  datetime64[ns]
 10  daily            310398 non-null  datetime64[ns]
 11  year             310398 non-null  int32         
 12  month            310398 non-null  int32         
 13  hour             310398 non-null  int32         
 14  time_index       310398 non-null  int64         
dtypes: datetime64[ns](3), float64(3), int32(3), int64(1), object(5)
memory usage: 32.0+ MB</code></pre>
</div>
</div>
<p>As well as the geo-data used for visualizing our results spatially</p>
<div id="61e69552" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>geometries_df <span class="op">=</span> gpd.read_file(filename<span class="op">=</span>Path(DATA_PATH, <span class="st">"us_counties_df.geojson"</span>))</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>geometries_df <span class="op">=</span> geometries_df.rename({<span class="st">"state_name"</span>: <span class="st">"state"</span>}, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>geometries_df[<span class="st">"state"</span>] <span class="op">=</span> geometries_df[<span class="st">"state"</span>].<span class="bu">apply</span>(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: [i.lower() <span class="cf">for</span> i <span class="kw">in</span> x.split(<span class="st">" "</span>)]</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>geometries_df[<span class="st">"state"</span>] <span class="op">=</span> geometries_df[<span class="st">"state"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="st">"_"</span>.join(x))</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>geometries_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">geo_point_2d</th>
<th data-quarto-table-cell-role="th">statefp</th>
<th data-quarto-table-cell-role="th">countyfp</th>
<th data-quarto-table-cell-role="th">countyns</th>
<th data-quarto-table-cell-role="th">geoid</th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">namelsad</th>
<th data-quarto-table-cell-role="th">stusab</th>
<th data-quarto-table-cell-role="th">lsad</th>
<th data-quarto-table-cell-role="th">classfp</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">cbsafp</th>
<th data-quarto-table-cell-role="th">metdivfp</th>
<th data-quarto-table-cell-role="th">funcstat</th>
<th data-quarto-table-cell-role="th">aland</th>
<th data-quarto-table-cell-role="th">awater</th>
<th data-quarto-table-cell-role="th">intptlat</th>
<th data-quarto-table-cell-role="th">intptlon</th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">countyfp_nozero</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>{ "lon": -96.615073673300003, "lat": 28.439109...</td>
<td>48</td>
<td>057</td>
<td>01383814</td>
<td>48057</td>
<td>Calhoun</td>
<td>Calhoun County</td>
<td>TX</td>
<td>06</td>
<td>H1</td>
<td>...</td>
<td>38920</td>
<td>None</td>
<td>A</td>
<td>1312707005</td>
<td>1361884774</td>
<td>+28.4417191</td>
<td>-096.5795739</td>
<td>texas</td>
<td>57</td>
<td>POLYGON ((-96.87329 28.62291, -96.87148 28.624...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>{ "lon": -86.190418669300001, "lat": 36.751316...</td>
<td>21</td>
<td>003</td>
<td>00516848</td>
<td>21003</td>
<td>Allen</td>
<td>Allen County</td>
<td>KY</td>
<td>06</td>
<td>H1</td>
<td>...</td>
<td>14540</td>
<td>None</td>
<td>A</td>
<td>891838779</td>
<td>19482100</td>
<td>+36.7507703</td>
<td>-086.1924580</td>
<td>kentucky</td>
<td>3</td>
<td>POLYGON ((-86.2958 36.85107, -86.29347 36.8526...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>{ "lon": -97.721324086699994, "lat": 48.369456...</td>
<td>38</td>
<td>099</td>
<td>01034214</td>
<td>38099</td>
<td>Walsh</td>
<td>Walsh County</td>
<td>ND</td>
<td>06</td>
<td>H1</td>
<td>...</td>
<td>None</td>
<td>None</td>
<td>A</td>
<td>3319346396</td>
<td>32181391</td>
<td>+48.3769789</td>
<td>-097.7222304</td>
<td>north_dakota</td>
<td>99</td>
<td>POLYGON ((-98.29185 48.36969, -98.29211 48.369...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>{ "lon": -84.649203742099999, "lat": 36.135024...</td>
<td>47</td>
<td>129</td>
<td>01639778</td>
<td>47129</td>
<td>Morgan</td>
<td>Morgan County</td>
<td>TN</td>
<td>06</td>
<td>H1</td>
<td>...</td>
<td>28940</td>
<td>None</td>
<td>A</td>
<td>1352439675</td>
<td>823018</td>
<td>+36.1386970</td>
<td>-084.6392616</td>
<td>tennessee</td>
<td>129</td>
<td>POLYGON ((-84.79101 36.05853, -84.79184 36.059...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>{ "lon": -105.367471778, "lat": 38.10867790150...</td>
<td>08</td>
<td>027</td>
<td>00198129</td>
<td>08027</td>
<td>Custer</td>
<td>Custer County</td>
<td>CO</td>
<td>06</td>
<td>H1</td>
<td>...</td>
<td>None</td>
<td>None</td>
<td>A</td>
<td>1913031921</td>
<td>3364150</td>
<td>+38.1019955</td>
<td>-105.3735123</td>
<td>colorado</td>
<td>27</td>
<td>POLYGON ((-105.7969 38.26505, -105.78341 38.26...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3228</td>
<td>{ "lon": -89.823002441400007, "lat": 31.569641...</td>
<td>28</td>
<td>065</td>
<td>00695756</td>
<td>28065</td>
<td>Jefferson Davis</td>
<td>Jefferson Davis County</td>
<td>MS</td>
<td>06</td>
<td>H1</td>
<td>...</td>
<td>None</td>
<td>None</td>
<td>A</td>
<td>1057871313</td>
<td>1791496</td>
<td>+31.5648075</td>
<td>-089.8270863</td>
<td>mississippi</td>
<td>65</td>
<td>POLYGON ((-89.97537 31.59155, -89.97535 31.592...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3229</td>
<td>{ "lon": -89.414372033899994, "lat": 35.197080...</td>
<td>47</td>
<td>047</td>
<td>01639742</td>
<td>47047</td>
<td>Fayette</td>
<td>Fayette County</td>
<td>TN</td>
<td>06</td>
<td>H1</td>
<td>...</td>
<td>32820</td>
<td>None</td>
<td>A</td>
<td>1825359642</td>
<td>3774635</td>
<td>+35.1969933</td>
<td>-089.4138027</td>
<td>tennessee</td>
<td>47</td>
<td>POLYGON ((-89.63773 35.17934, -89.63768 35.181...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3230</td>
<td>{ "lon": -97.891896839799998, "lat": 42.636781...</td>
<td>31</td>
<td>107</td>
<td>00835875</td>
<td>31107</td>
<td>Knox</td>
<td>Knox County</td>
<td>NE</td>
<td>06</td>
<td>H1</td>
<td>...</td>
<td>None</td>
<td>None</td>
<td>A</td>
<td>2870854403</td>
<td>81011709</td>
<td>+42.6344045</td>
<td>-097.8913492</td>
<td>nebraska</td>
<td>107</td>
<td>POLYGON ((-97.60303 42.85796, -97.60294 42.857...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3231</td>
<td>{ "lon": -123.098321728, "lat": 45.56009084080...</td>
<td>41</td>
<td>067</td>
<td>01155137</td>
<td>41067</td>
<td>Washington</td>
<td>Washington County</td>
<td>OR</td>
<td>06</td>
<td>H1</td>
<td>...</td>
<td>38900</td>
<td>None</td>
<td>A</td>
<td>1875859540</td>
<td>6114246</td>
<td>+45.5535419</td>
<td>-123.0976146</td>
<td>oregon</td>
<td>67</td>
<td>POLYGON ((-123.20926 45.43371, -123.20976 45.4...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3232</td>
<td>{ "lon": -72.713798537399995, "lat": 42.990603...</td>
<td>50</td>
<td>025</td>
<td>01461769</td>
<td>50025</td>
<td>Windham</td>
<td>Windham County</td>
<td>VT</td>
<td>06</td>
<td>H1</td>
<td>...</td>
<td>None</td>
<td>None</td>
<td>A</td>
<td>2034457838</td>
<td>32920750</td>
<td>+42.9953348</td>
<td>-072.7219550</td>
<td>vermont</td>
<td>25</td>
<td>POLYGON ((-72.86874 43.11317, -72.86803 43.125...</td>
</tr>
</tbody>
</table>

<p>3233 rows × 22 columns</p>
</div>
</div>
</div>
<div id="1213d7eb" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>geometries_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'geopandas.geodataframe.GeoDataFrame'&gt;
RangeIndex: 3233 entries, 0 to 3232
Data columns (total 22 columns):
 #   Column           Non-Null Count  Dtype   
---  ------           --------------  -----   
 0   geo_point_2d     3233 non-null   object  
 1   statefp          3233 non-null   object  
 2   countyfp         3233 non-null   object  
 3   countyns         3233 non-null   object  
 4   geoid            3233 non-null   object  
 5   name             3233 non-null   object  
 6   namelsad         3233 non-null   object  
 7   stusab           3233 non-null   object  
 8   lsad             3233 non-null   object  
 9   classfp          3233 non-null   object  
 10  mtfcc            3233 non-null   object  
 11  csafp            1255 non-null   object  
 12  cbsafp           1915 non-null   object  
 13  metdivfp         110 non-null    object  
 14  funcstat         3233 non-null   object  
 15  aland            3233 non-null   int64   
 16  awater           3233 non-null   int64   
 17  intptlat         3233 non-null   object  
 18  intptlon         3233 non-null   object  
 19  state            3233 non-null   object  
 20  countyfp_nozero  3233 non-null   object  
 21  geometry         3233 non-null   geometry
dtypes: geometry(1), int64(2), object(19)
memory usage: 555.8+ KB</code></pre>
</div>
</div>
<p>We then proceed at creating 3 datasets to be used by the 3 different statistical approaches we are going to adopt:</p>
<div id="45ab3a94" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>continuous_state_modelling_df, count_state_modelling_df, eva_state_modelling_df <span class="op">=</span> (</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    create_all_datasets(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>        modelling_df<span class="op">=</span>modelling_df[</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>            (modelling_df[<span class="st">"year"</span>] <span class="op">&gt;=</span> LOWER_CUT_OFF_YEAR)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> (modelling_df[<span class="st">"year"</span>] <span class="op">&lt;=</span> UPPER_CUT_OFF_YEAR)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        geometries_df<span class="op">=</span>geometries_df,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        state<span class="op">=</span>SELECTED_ANALYSIS_STATES,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="1">
<li>One for extreme value analysis.</li>
</ol>
<div id="8de0bbc3" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>eva_state_modelling_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 1768 entries, 0 to 1767
Data columns (total 6 columns):
 #   Column           Non-Null Count  Dtype         
---  ------           --------------  -----         
 0   begin_date_time  1768 non-null   datetime64[ns]
 1   magnitude        1768 non-null   float64       
 2   countyfp         1768 non-null   object        
 3   state            1768 non-null   object        
 4   geometry         1768 non-null   geometry      
 5   county           1768 non-null   object        
dtypes: datetime64[ns](1), float64(1), geometry(1), object(3)
memory usage: 83.0+ KB</code></pre>
</div>
</div>
<ol start="2" type="1">
<li>One with a continuous target (i.e., hail magnitude) for the quantile regression.</li>
</ol>
<div id="c5c36265" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>continuous_state_modelling_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 3813 entries, 0 to 3812
Data columns (total 9 columns):
 #   Column     Non-Null Count  Dtype   
---  ------     --------------  -----   
 0   year       3813 non-null   int32   
 1   month      3813 non-null   int32   
 2   hour       3813 non-null   int32   
 3   begin_lat  3813 non-null   float64 
 4   begin_lon  3813 non-null   float64 
 5   state      3813 non-null   object  
 6   countyfp   3813 non-null   object  
 7   magnitude  3813 non-null   float64 
 8   geometry   3813 non-null   geometry
dtypes: float64(3), geometry(1), int32(3), object(2)
memory usage: 223.5+ KB</code></pre>
</div>
</div>
<ol start="3" type="1">
<li>One with a count target (i.e, number of hail events) for the zero-inflated negative binomial regression.</li>
</ol>
<div id="8776a89f" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>count_state_modelling_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 501696 entries, 0 to 501695
Data columns (total 7 columns):
 #   Column         Non-Null Count   Dtype   
---  ------         --------------   -----   
 0   year           501696 non-null  int32   
 1   month          501696 non-null  int32   
 2   hour           501696 non-null  int32   
 3   state          501696 non-null  object  
 4   countyfp       501696 non-null  object  
 5   number_events  501696 non-null  float64 
 6   geometry       501696 non-null  geometry
dtypes: float64(1), geometry(1), int32(3), object(2)
memory usage: 21.1+ MB</code></pre>
</div>
</div>
</section>
<section id="visualizing-hail-events" class="level3" data-number="1.2.2">
<h3 data-number="1.2.2" class="anchored" data-anchor-id="visualizing-hail-events"><span class="header-section-number">1.2.2</span> Visualizing Hail Events</h3>
<div id="c05b304f" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Show supplementary code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gif</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mpl_toolkits.axes_grid1.inset_locator <span class="im">import</span> inset_axes</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_distribution_hail(</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    continuous_state_modelling_df: pd.DataFrame,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    x: <span class="bu">str</span>,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    ax: plt.Axes,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    states: List[<span class="bu">str</span>] <span class="op">=</span> SELECTED_ANALYSIS_STATES,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>kwargs: Any,</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> plt.Axes:</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot the distribution of hail magnitude"""</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    title_states <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join([state.capitalize() <span class="cf">for</span> state <span class="kw">in</span> states])</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    sns.histplot(data<span class="op">=</span>continuous_state_modelling_df, x<span class="op">=</span>x, ax<span class="op">=</span>ax, <span class="op">**</span>kwargs)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    ax.grid(alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"</span><span class="sc">{</span>title_states<span class="sc">}</span><span class="ch">\n</span><span class="ss">Hourly Hail Events"</span>)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_hail_distribution_with_tails(</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    magnitude_events: ArrayLike, state: <span class="bu">str</span>, threshold<span class="op">=</span>CRITICAL_VALUE_CONTINUOUS_TARGET</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[plt.Figure, plt.Axes, plt.Axes]:</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot a distribution of hail events magnitude with a focus on the tail."""</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>[<span class="dv">8</span>, <span class="dv">5</span>])</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    sub_ax <span class="op">=</span> inset_axes(</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>        ax,</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>        width<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>        height<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>        loc<span class="op">=</span><span class="st">"center right"</span>,</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    sns.histplot(</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>magnitude_events,</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>        bins<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>        ax<span class="op">=</span>ax,</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>    sns.histplot(</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>magnitude_events[magnitude_events <span class="op">&gt;</span> threshold],</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>        bins<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>        ax<span class="op">=</span>sub_ax,</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"Distribution Hail Events</span><span class="ch">\n</span><span class="sc">{</span>state<span class="sc">.</span>capitalize()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"Hail Size"</span>)</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>    sub_ax.set_title(<span class="ss">f"Extreme Hail Events</span><span class="ch">\n</span><span class="sc">{</span>state<span class="sc">.</span>capitalize()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>    sub_ax.set_xlabel(<span class="st">"Hail Size"</span>)</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>    ax.axvline(</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>        <span class="fl">1.77</span>,</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>        linestyle<span class="op">=</span><span class="st">"--"</span>,</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span><span class="st">"r"</span>,</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>        linewidth<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">"Critical Value"</span>,</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>    ax.grid(alpha<span class="op">=</span><span class="fl">0.5</span>, zorder<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig, ax, sub_ax</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_hail_events_on_map(</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>    geometries_df: gpd.GeoDataFrame,</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>    state_modelling_df: pd.DataFrame,</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>    selected_state: <span class="bu">str</span> <span class="op">=</span> SELECTED_ANALYSIS_STATES,</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>    threshold: <span class="bu">float</span> <span class="op">=</span> CRITICAL_VALUE_CONTINUOUS_TARGET,</span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>    extreme_threshold: <span class="bu">float</span> <span class="op">=</span> <span class="fl">2.5</span>,</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>    extreme_events_size: <span class="bu">float</span> <span class="op">=</span> <span class="dv">25</span>,</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>scatter_kwargs: Any,</span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Visualize the hail events on a map with highlight of above-threshold event"""</span></span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>    fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>), sharey<span class="op">=</span><span class="va">True</span>, sharex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>        geometries_df[geometries_df[STATE_INDEX] <span class="op">==</span> selected_state].boundary.plot(</span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>axs[<span class="dv">0</span>], color<span class="op">=</span><span class="st">"k"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span></span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>        geometries_df[geometries_df[STATE_INDEX] <span class="op">==</span> selected_state].boundary.plot(</span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>axs[<span class="dv">1</span>], color<span class="op">=</span><span class="st">"k"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span></span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>].scatter(</span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a>        state_modelling_df[<span class="st">"begin_lon"</span>].values,</span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>        state_modelling_df[<span class="st">"begin_lat"</span>].values,</span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span>state_modelling_df[CONTINUOUS_TARGET].values,</span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>        vmin<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>        vmax<span class="op">=</span><span class="fl">4.5</span>,</span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a>        cmap<span class="op">=</span>COLORMAP_NAME,</span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>        <span class="op">**</span>scatter_kwargs,</span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].scatter(</span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a>        state_modelling_df[</span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a>            (state_modelling_df[CONTINUOUS_TARGET] <span class="op">&gt;</span> threshold)</span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> (state_modelling_df[CONTINUOUS_TARGET] <span class="op">&lt;</span> extreme_threshold)</span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a>        ][<span class="st">"begin_lon"</span>].values,</span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a>        state_modelling_df[</span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a>            (state_modelling_df[CONTINUOUS_TARGET] <span class="op">&gt;</span> threshold)</span>
<span id="cb16-103"><a href="#cb16-103" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> (state_modelling_df[CONTINUOUS_TARGET] <span class="op">&lt;</span> extreme_threshold)</span>
<span id="cb16-104"><a href="#cb16-104" aria-hidden="true" tabindex="-1"></a>        ][<span class="st">"begin_lat"</span>].values,</span>
<span id="cb16-105"><a href="#cb16-105" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span>state_modelling_df[</span>
<span id="cb16-106"><a href="#cb16-106" aria-hidden="true" tabindex="-1"></a>            (state_modelling_df[CONTINUOUS_TARGET] <span class="op">&gt;</span> threshold)</span>
<span id="cb16-107"><a href="#cb16-107" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span> (state_modelling_df[CONTINUOUS_TARGET] <span class="op">&lt;</span> extreme_threshold)</span>
<span id="cb16-108"><a href="#cb16-108" aria-hidden="true" tabindex="-1"></a>        ][CONTINUOUS_TARGET].values,</span>
<span id="cb16-109"><a href="#cb16-109" aria-hidden="true" tabindex="-1"></a>        vmin<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb16-110"><a href="#cb16-110" aria-hidden="true" tabindex="-1"></a>        vmax<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb16-111"><a href="#cb16-111" aria-hidden="true" tabindex="-1"></a>        cmap<span class="op">=</span>COLORMAP_NAME,</span>
<span id="cb16-112"><a href="#cb16-112" aria-hidden="true" tabindex="-1"></a>        <span class="op">**</span>scatter_kwargs,</span>
<span id="cb16-113"><a href="#cb16-113" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-114"><a href="#cb16-114" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].scatter(</span>
<span id="cb16-115"><a href="#cb16-115" aria-hidden="true" tabindex="-1"></a>        state_modelling_df[</span>
<span id="cb16-116"><a href="#cb16-116" aria-hidden="true" tabindex="-1"></a>            (state_modelling_df[CONTINUOUS_TARGET] <span class="op">&gt;=</span> extreme_threshold)</span>
<span id="cb16-117"><a href="#cb16-117" aria-hidden="true" tabindex="-1"></a>        ][<span class="st">"begin_lon"</span>].values,</span>
<span id="cb16-118"><a href="#cb16-118" aria-hidden="true" tabindex="-1"></a>        state_modelling_df[</span>
<span id="cb16-119"><a href="#cb16-119" aria-hidden="true" tabindex="-1"></a>            (state_modelling_df[CONTINUOUS_TARGET] <span class="op">&gt;=</span> extreme_threshold)</span>
<span id="cb16-120"><a href="#cb16-120" aria-hidden="true" tabindex="-1"></a>        ][<span class="st">"begin_lat"</span>].values,</span>
<span id="cb16-121"><a href="#cb16-121" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span><span class="st">"r"</span>,</span>
<span id="cb16-122"><a href="#cb16-122" aria-hidden="true" tabindex="-1"></a>        s<span class="op">=</span>extreme_events_size,</span>
<span id="cb16-123"><a href="#cb16-123" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-124"><a href="#cb16-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-125"><a href="#cb16-125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax <span class="kw">in</span> axs:</span>
<span id="cb16-126"><a href="#cb16-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-127"><a href="#cb16-127" aria-hidden="true" tabindex="-1"></a>        ax.grid(alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb16-128"><a href="#cb16-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-129"><a href="#cb16-129" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>].set_title(<span class="ss">f"Hail Events</span><span class="ch">\n</span><span class="sc">{</span>selected_state<span class="sc">.</span>capitalize()<span class="sc">}</span><span class="ss"> Counties"</span>)</span>
<span id="cb16-130"><a href="#cb16-130" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].set_title(<span class="ss">f"Extreme Hail Events</span><span class="ch">\n</span><span class="sc">{</span>selected_state<span class="sc">.</span>capitalize()<span class="sc">}</span><span class="ss"> Counties"</span>)</span>
<span id="cb16-131"><a href="#cb16-131" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>].set_xlabel(<span class="st">"Longitude"</span>)</span>
<span id="cb16-132"><a href="#cb16-132" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].set_xlabel(<span class="st">"Longitude"</span>)</span>
<span id="cb16-133"><a href="#cb16-133" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>].set_ylabel(<span class="st">"Latitude"</span>)</span>
<span id="cb16-134"><a href="#cb16-134" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].set_title(<span class="ss">f"Extreme Hail Events</span><span class="ch">\n</span><span class="sc">{</span>selected_state<span class="sc">.</span>capitalize()<span class="sc">}</span><span class="ss"> Counties"</span>)</span>
<span id="cb16-135"><a href="#cb16-135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig, axs</span>
<span id="cb16-136"><a href="#cb16-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-137"><a href="#cb16-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-138"><a href="#cb16-138" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_quantile_hail_time(</span>
<span id="cb16-139"><a href="#cb16-139" aria-hidden="true" tabindex="-1"></a>    time_column: <span class="bu">str</span>,</span>
<span id="cb16-140"><a href="#cb16-140" aria-hidden="true" tabindex="-1"></a>    y: <span class="bu">str</span>,</span>
<span id="cb16-141"><a href="#cb16-141" aria-hidden="true" tabindex="-1"></a>    modelling_df: pd.DataFrame,</span>
<span id="cb16-142"><a href="#cb16-142" aria-hidden="true" tabindex="-1"></a>    ax: plt.Axes,</span>
<span id="cb16-143"><a href="#cb16-143" aria-hidden="true" tabindex="-1"></a>    quantile: <span class="bu">float</span>,</span>
<span id="cb16-144"><a href="#cb16-144" aria-hidden="true" tabindex="-1"></a>    states: List[<span class="bu">str</span>] <span class="op">=</span> SELECTED_ANALYSIS_STATES,</span>
<span id="cb16-145"><a href="#cb16-145" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>kwargs: Any,</span>
<span id="cb16-146"><a href="#cb16-146" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> plt.Axes:</span>
<span id="cb16-147"><a href="#cb16-147" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot the average hail attribute over a certain categorical columns"""</span></span>
<span id="cb16-148"><a href="#cb16-148" aria-hidden="true" tabindex="-1"></a>    title_states <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join([state.capitalize() <span class="cf">for</span> state <span class="kw">in</span> states])</span>
<span id="cb16-149"><a href="#cb16-149" aria-hidden="true" tabindex="-1"></a>    sns.lineplot(</span>
<span id="cb16-150"><a href="#cb16-150" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>modelling_df,</span>
<span id="cb16-151"><a href="#cb16-151" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>time_column,</span>
<span id="cb16-152"><a href="#cb16-152" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span>y,</span>
<span id="cb16-153"><a href="#cb16-153" aria-hidden="true" tabindex="-1"></a>        ax<span class="op">=</span>ax,</span>
<span id="cb16-154"><a href="#cb16-154" aria-hidden="true" tabindex="-1"></a>        estimator<span class="op">=</span>partial(np.percentile, q<span class="op">=</span>quantile),</span>
<span id="cb16-155"><a href="#cb16-155" aria-hidden="true" tabindex="-1"></a>        n_boot<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb16-156"><a href="#cb16-156" aria-hidden="true" tabindex="-1"></a>        <span class="op">**</span>kwargs,</span>
<span id="cb16-157"><a href="#cb16-157" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-158"><a href="#cb16-158" aria-hidden="true" tabindex="-1"></a>    ax.grid(alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb16-159"><a href="#cb16-159" aria-hidden="true" tabindex="-1"></a>    ax.set_ylim(<span class="dv">0</span>, modelling_df[y].<span class="bu">max</span>())</span>
<span id="cb16-160"><a href="#cb16-160" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(y.capitalize())</span>
<span id="cb16-161"><a href="#cb16-161" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(time_column.capitalize())</span>
<span id="cb16-162"><a href="#cb16-162" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"</span><span class="sc">{</span>title_states<span class="sc">}</span><span class="ch">\n</span><span class="ss">Quantile </span><span class="sc">{</span>quantile<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>y<span class="sc">.</span>capitalize()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-163"><a href="#cb16-163" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span>
<span id="cb16-164"><a href="#cb16-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-165"><a href="#cb16-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-166"><a href="#cb16-166" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_quantile_hail_geometry(</span>
<span id="cb16-167"><a href="#cb16-167" aria-hidden="true" tabindex="-1"></a>    modelling_df: pd.DataFrame,</span>
<span id="cb16-168"><a href="#cb16-168" aria-hidden="true" tabindex="-1"></a>    color_column: <span class="bu">str</span>,</span>
<span id="cb16-169"><a href="#cb16-169" aria-hidden="true" tabindex="-1"></a>    max_value: <span class="bu">float</span>,</span>
<span id="cb16-170"><a href="#cb16-170" aria-hidden="true" tabindex="-1"></a>    ax: Axes,</span>
<span id="cb16-171"><a href="#cb16-171" aria-hidden="true" tabindex="-1"></a>    quantile: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span id="cb16-172"><a href="#cb16-172" aria-hidden="true" tabindex="-1"></a>    states: List[<span class="bu">str</span>] <span class="op">=</span> SELECTED_ANALYSIS_STATES,</span>
<span id="cb16-173"><a href="#cb16-173" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Axes:</span>
<span id="cb16-174"><a href="#cb16-174" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot quantile of hail attribute over geometries"""</span></span>
<span id="cb16-175"><a href="#cb16-175" aria-hidden="true" tabindex="-1"></a>    title_states <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join([state.capitalize() <span class="cf">for</span> state <span class="kw">in</span> states])</span>
<span id="cb16-176"><a href="#cb16-176" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb16-177"><a href="#cb16-177" aria-hidden="true" tabindex="-1"></a>        gpd.GeoDataFrame(</span>
<span id="cb16-178"><a href="#cb16-178" aria-hidden="true" tabindex="-1"></a>            modelling_df.groupby(<span class="st">"geometry"</span>)[color_column]</span>
<span id="cb16-179"><a href="#cb16-179" aria-hidden="true" tabindex="-1"></a>            .quantile(quantile)</span>
<span id="cb16-180"><a href="#cb16-180" aria-hidden="true" tabindex="-1"></a>            .reset_index()</span>
<span id="cb16-181"><a href="#cb16-181" aria-hidden="true" tabindex="-1"></a>        ).plot(</span>
<span id="cb16-182"><a href="#cb16-182" aria-hidden="true" tabindex="-1"></a>            color_column,</span>
<span id="cb16-183"><a href="#cb16-183" aria-hidden="true" tabindex="-1"></a>            cmap<span class="op">=</span>COLORMAP_NAME,</span>
<span id="cb16-184"><a href="#cb16-184" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax,</span>
<span id="cb16-185"><a href="#cb16-185" aria-hidden="true" tabindex="-1"></a>            legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb16-186"><a href="#cb16-186" aria-hidden="true" tabindex="-1"></a>            vmin<span class="op">=</span><span class="fl">0.0</span>,</span>
<span id="cb16-187"><a href="#cb16-187" aria-hidden="true" tabindex="-1"></a>            vmax<span class="op">=</span>max_value,</span>
<span id="cb16-188"><a href="#cb16-188" aria-hidden="true" tabindex="-1"></a>            legend_kwds<span class="op">=</span>{<span class="st">"shrink"</span>: <span class="fl">0.7</span>},</span>
<span id="cb16-189"><a href="#cb16-189" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-190"><a href="#cb16-190" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-191"><a href="#cb16-191" aria-hidden="true" tabindex="-1"></a>    ax.grid(alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb16-192"><a href="#cb16-192" aria-hidden="true" tabindex="-1"></a>    ax.set_title(</span>
<span id="cb16-193"><a href="#cb16-193" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>title_states<span class="sc">}</span><span class="ch">\n</span><span class="ss">Quantile </span><span class="sc">{</span>quantile <span class="op">*</span> <span class="dv">100</span><span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>color_column<span class="sc">.</span>capitalize()<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb16-194"><a href="#cb16-194" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-195"><a href="#cb16-195" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"Longitude"</span>)</span>
<span id="cb16-196"><a href="#cb16-196" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"Latitude"</span>)</span>
<span id="cb16-197"><a href="#cb16-197" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span>
<span id="cb16-198"><a href="#cb16-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-199"><a href="#cb16-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-200"><a href="#cb16-200" aria-hidden="true" tabindex="-1"></a><span class="at">@gif.frame</span></span>
<span id="cb16-201"><a href="#cb16-201" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_comparison_quantile_hail_geometry(</span>
<span id="cb16-202"><a href="#cb16-202" aria-hidden="true" tabindex="-1"></a>    quantile: <span class="bu">float</span>,</span>
<span id="cb16-203"><a href="#cb16-203" aria-hidden="true" tabindex="-1"></a>    continuous_state_modelling_df: gpd.GeoDataFrame,</span>
<span id="cb16-204"><a href="#cb16-204" aria-hidden="true" tabindex="-1"></a>    count_state_modelling_df: gpd.GeoDataFrame,</span>
<span id="cb16-205"><a href="#cb16-205" aria-hidden="true" tabindex="-1"></a>    states: List[<span class="bu">str</span>] <span class="op">=</span> SELECTED_ANALYSIS_STATES,</span>
<span id="cb16-206"><a href="#cb16-206" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb16-207"><a href="#cb16-207" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compare hail magnitude and hail quantity over geometries"""</span></span>
<span id="cb16-208"><a href="#cb16-208" aria-hidden="true" tabindex="-1"></a>    fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>))</span>
<span id="cb16-209"><a href="#cb16-209" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, df, color_column <span class="kw">in</span> <span class="bu">zip</span>(</span>
<span id="cb16-210"><a href="#cb16-210" aria-hidden="true" tabindex="-1"></a>        axs,</span>
<span id="cb16-211"><a href="#cb16-211" aria-hidden="true" tabindex="-1"></a>        [continuous_state_modelling_df, count_state_modelling_df],</span>
<span id="cb16-212"><a href="#cb16-212" aria-hidden="true" tabindex="-1"></a>        [CONTINUOUS_TARGET, COUNT_TARGET],</span>
<span id="cb16-213"><a href="#cb16-213" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb16-214"><a href="#cb16-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-215"><a href="#cb16-215" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> plot_quantile_hail_geometry(</span>
<span id="cb16-216"><a href="#cb16-216" aria-hidden="true" tabindex="-1"></a>            modelling_df<span class="op">=</span>df,</span>
<span id="cb16-217"><a href="#cb16-217" aria-hidden="true" tabindex="-1"></a>            color_column<span class="op">=</span>color_column,</span>
<span id="cb16-218"><a href="#cb16-218" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax,</span>
<span id="cb16-219"><a href="#cb16-219" aria-hidden="true" tabindex="-1"></a>            quantile<span class="op">=</span>quantile,</span>
<span id="cb16-220"><a href="#cb16-220" aria-hidden="true" tabindex="-1"></a>            max_value<span class="op">=</span>df[color_column].<span class="bu">max</span>(),</span>
<span id="cb16-221"><a href="#cb16-221" aria-hidden="true" tabindex="-1"></a>            states<span class="op">=</span>states,</span>
<span id="cb16-222"><a href="#cb16-222" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-223"><a href="#cb16-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-224"><a href="#cb16-224" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb16-225"><a href="#cb16-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-226"><a href="#cb16-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-227"><a href="#cb16-227" aria-hidden="true" tabindex="-1"></a><span class="at">@gif.frame</span></span>
<span id="cb16-228"><a href="#cb16-228" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_comparison_quantile_hail_time(</span>
<span id="cb16-229"><a href="#cb16-229" aria-hidden="true" tabindex="-1"></a>    y: <span class="bu">str</span>,</span>
<span id="cb16-230"><a href="#cb16-230" aria-hidden="true" tabindex="-1"></a>    modelling_df: gpd.GeoDataFrame,</span>
<span id="cb16-231"><a href="#cb16-231" aria-hidden="true" tabindex="-1"></a>    quantile: <span class="bu">float</span>,</span>
<span id="cb16-232"><a href="#cb16-232" aria-hidden="true" tabindex="-1"></a>    color: Any,</span>
<span id="cb16-233"><a href="#cb16-233" aria-hidden="true" tabindex="-1"></a>    states: List[<span class="bu">str</span>] <span class="op">=</span> SELECTED_ANALYSIS_STATES,</span>
<span id="cb16-234"><a href="#cb16-234" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>kwargs: Any,</span>
<span id="cb16-235"><a href="#cb16-235" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb16-236"><a href="#cb16-236" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compare average hail attribute over hour and month"""</span></span>
<span id="cb16-237"><a href="#cb16-237" aria-hidden="true" tabindex="-1"></a>    fig, axs <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">1</span>, ncols<span class="op">=</span><span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">5</span>))</span>
<span id="cb16-238"><a href="#cb16-238" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, time_indicator <span class="kw">in</span> <span class="bu">zip</span>(axs, [<span class="st">"hour"</span>, <span class="st">"month"</span>, <span class="st">"year"</span>]):</span>
<span id="cb16-239"><a href="#cb16-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-240"><a href="#cb16-240" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> plot_quantile_hail_time(</span>
<span id="cb16-241"><a href="#cb16-241" aria-hidden="true" tabindex="-1"></a>            modelling_df<span class="op">=</span>modelling_df,</span>
<span id="cb16-242"><a href="#cb16-242" aria-hidden="true" tabindex="-1"></a>            time_column<span class="op">=</span>time_indicator,</span>
<span id="cb16-243"><a href="#cb16-243" aria-hidden="true" tabindex="-1"></a>            y<span class="op">=</span>y,</span>
<span id="cb16-244"><a href="#cb16-244" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax,</span>
<span id="cb16-245"><a href="#cb16-245" aria-hidden="true" tabindex="-1"></a>            quantile<span class="op">=</span>quantile,</span>
<span id="cb16-246"><a href="#cb16-246" aria-hidden="true" tabindex="-1"></a>            states<span class="op">=</span>states,</span>
<span id="cb16-247"><a href="#cb16-247" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>color,</span>
<span id="cb16-248"><a href="#cb16-248" aria-hidden="true" tabindex="-1"></a>            <span class="op">**</span>kwargs,</span>
<span id="cb16-249"><a href="#cb16-249" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-250"><a href="#cb16-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-251"><a href="#cb16-251" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>As first thing we want to have a sense of how the hail events distributed spatially so we proceed at visualizing the entire history of hail events on Florida.</p>
<div id="67e6acff" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plot_hail_events_on_map(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    geometries_df<span class="op">=</span>geometries_df,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    state_modelling_df<span class="op">=</span>continuous_state_modelling_df,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    selected_state<span class="op">=</span>SELECTED_ANALYSIS_STATES[<span class="dv">0</span>],</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    threshold<span class="op">=</span><span class="fl">1.7</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    s<span class="op">=</span><span class="fl">1.5</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    extreme_events_size<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>fig.subplots_adjust(top<span class="op">=</span><span class="fl">1.33</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>plt.savefig(Path(IMAGES_PATH, <span class="st">"hail_events_comparison_total.png"</span>))</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>plt.close(<span class="st">"all"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-hail_comparison_total" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-hail_comparison_total-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="results/images/hail_events_comparison_total.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-hail_comparison_total-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Comparing Normal and Extreme Hail Events
</figcaption>
</figure>
</div>
<p><a href="#fig-hail_comparison_total" class="quarto-xref">Figure&nbsp;1</a> shows on the left side all the hail events coloured according to the estimated hail size of the event. On the right we can see a filtered version of the left panel where only events with estimated hail size greater than 1.7” are shown, in particular we have highlighted in red those events with hail size greater than 2.5” (i.e., exceptionally large hail events).</p>
<div id="f1c79113" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>partialized_plot_comparison_quantile_hail_geometry <span class="op">=</span> partial(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    plot_comparison_quantile_hail_geometry,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    continuous_state_modelling_df<span class="op">=</span>continuous_state_modelling_df,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    count_state_modelling_df<span class="op">=</span>count_state_modelling_df[</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>        count_state_modelling_df[<span class="st">"number_events"</span>] <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    states<span class="op">=</span>SELECTED_ANALYSIS_STATES,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>quantiles <span class="op">=</span> [<span class="fl">.25</span>, <span class="fl">.75</span>, <span class="fl">.95</span>, <span class="fl">.99</span>]</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>frames <span class="op">=</span> [partialized_plot_comparison_quantile_hail_geometry(quantile<span class="op">=</span>quantile) <span class="cf">for</span> index, quantile <span class="kw">in</span> <span class="bu">enumerate</span>(quantiles)]</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>gif.save(frames, Path(GIFS_PATH, <span class="st">'spatial_map_quantiles.gif'</span>).as_posix(), duration<span class="op">=</span><span class="dv">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-sample_size" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sample_size-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="results/gif_images/spatial_map_quantiles.gif" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sample_size-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Observed Spatial Quantiles
</figcaption>
</figure>
</div>
<p>From <a href="#fig-hail_comparison_total" class="quarto-xref">Figure&nbsp;1</a> and <a href="#fig-sample_size" class="quarto-xref">Figure&nbsp;2</a> can already have an intuition of various characteristics of hail events</p>
<ol type="1">
<li><p>They are not evenly distributed in space, there are areas which don’t see events at all. <a href="#fig-sample_size" class="quarto-xref">Figure&nbsp;2</a> shows the percentiles for both hail size and hail events across counties. Darker colors indicate higher hail size and number of hail events.</p></li>
<li><p>Very large hail events are very rare and exceptionally large hail events are even more rare.</p></li>
<li><p>Very large hail events can occur even in areas where hail per-se is a very rare event. <a href="#fig-sample_size" class="quarto-xref">Figure&nbsp;2</a> shows three different type of percentile values of hail size for the different counties: 50%, 95% and 99% as we can see some of the most extreme values occur in area where there has been very few hail events.</p></li>
<li><p>We can notice that there is spatial coherence in how the hail events distribute on the territory of Florida (possibly reflecting geographical characteristics of the various areas)</p></li>
</ol>
<div id="065242d7" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>partialized_plot_comparison_quantile_hail_time <span class="op">=</span> partial(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    plot_comparison_quantile_hail_time,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>COUNT_TARGET,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    modelling_df<span class="op">=</span>count_state_modelling_df[</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>        count_state_modelling_df[<span class="st">"number_events"</span>] <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    states<span class="op">=</span>SELECTED_ANALYSIS_STATES,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    linewidth<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    solid_capstyle<span class="op">=</span><span class="st">'round'</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>quantiles <span class="op">=</span> [<span class="dv">25</span>, <span class="dv">75</span>, <span class="dv">95</span>, <span class="dv">99</span>]</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>frames <span class="op">=</span> [partialized_plot_comparison_quantile_hail_time(quantile<span class="op">=</span>quantile, color<span class="op">=</span>COLORMAP(index <span class="op">+</span> <span class="dv">1</span>)) <span class="cf">for</span> index, quantile <span class="kw">in</span> <span class="bu">enumerate</span>(quantiles)]</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>gif.save(frames, Path(GIFS_PATH, <span class="st">'temporal_quantiles.gif'</span>).as_posix(), duration<span class="op">=</span><span class="dv">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-temporal_quantiles" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-temporal_quantiles-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="results/gif_images/temporal_quantiles.gif" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-temporal_quantiles-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Observed Temporal Quantiles
</figcaption>
</figure>
</div>
<ol start="5" type="1">
<li>From <a href="#fig-temporal_quantiles" class="quarto-xref">Figure&nbsp;3</a> we can also observe the presence of seasonal patterns and trending behaviour that changes when considering different quantiles for both hail sizes and number of hail events.</li>
</ol>
<div id="fig-hail_magnitude_daily_probability" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-hail_magnitude_daily_probability-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="results/images/hail_magnitudes_daily_probability.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-hail_magnitude_daily_probability-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Comparing Daily Empirical Probability of Hail Events by Magnitude
</figcaption>
</figure>
</div>
<p><a href="#fig-hail_magnitude_daily_probability" class="quarto-xref">Figure&nbsp;4</a> shows in more detail how the more an event is severe, in terms of hail size (i.e., disruptive), the lower is its daily probability of occurring. I particular we can see the sharp drop from moderate (1.25” to 1.75”) to severe (greater than 1.77”) hail storm.</p>
<p>What this tells us is that hail storms, in particular those which have potential of being disruptive or dangerous, are better framed in terms of extreme events. In the next section we will see how these events require to be treated with particular care.</p>
</section>
<section id="visualizing-the-characteristics-of-extreme-hail-events" class="level3" data-number="1.2.3">
<h3 data-number="1.2.3" class="anchored" data-anchor-id="visualizing-the-characteristics-of-extreme-hail-events"><span class="header-section-number">1.2.3</span> Visualizing The characteristics of Extreme Hail Events</h3>
<p>We now want to have a better understanding of the statistical characteristics of hail events which are extreme in size, meaning they are above 1.77”</p>
<div id="4f1d8de4" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fig, ax, sub_ax <span class="op">=</span> plot_hail_distribution_with_tails(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    magnitude_events<span class="op">=</span>continuous_state_modelling_df[CONTINUOUS_TARGET].values,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    state<span class="op">=</span>SELECTED_ANALYSIS_STATES[<span class="dv">0</span>],</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>plt.savefig(Path(IMAGES_PATH, <span class="st">"events_distribution.png"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="fig-distribution_hail_events" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-distribution_hail_events-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="results/images/events_distribution.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-distribution_hail_events-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Visualizing the Distribution of Hail Events
</figcaption>
</figure>
</div>
<p><a href="#fig-distribution_hail_events" class="quarto-xref">Figure&nbsp;5</a> shows the distribution of the hail events with a red line indicating the critical value of 1.77”. We can observe a series of characteristics typical of hail events:</p>
<ol type="1">
<li><p>Most of the mass of the distribution lies around the 1” mark indicating that the most common hail events are usually innocuous. We need to note that from <a href="#fig-distribution_hail_events" class="quarto-xref">Figure&nbsp;5</a> we removed all the days in which there were no hail events. If not we would have observed the typical pattern of a <a href="https://en.wikipedia.org/wiki/Zero-inflated_model">zero-inflated distribution</a>.</p></li>
<li><p>The distribution is left skewed with a relatively long and heavy right tail. This indicates that hail event of disruptive force can appear with a non-negligible probability but are in general very rare.</p></li>
<li><p>Focusing on the extreme hail events (i.e., above the 1.77” mark) we can see the distribution is again heavily skewed on the left suggesting that truly disastrous hail events (i.e., size above the 2.5”) can be very hard to predict.</p></li>
</ol>
</section>
</section>
<section id="analyses-conducted" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="analyses-conducted"><span class="header-section-number">1.3</span> Analyses Conducted</h2>
<p>In this section we will outline the methodology we adopted for estimating hail size and hail risk at the county level.</p>
</section>
<section id="estimating-return-periods-using-extreme-value-analysis" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="estimating-return-periods-using-extreme-value-analysis"><span class="header-section-number">1.4</span> Estimating Return Periods using Extreme Value Analysis</h2>
<div id="2889e06d" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Show supplementary code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> rankdata</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> genextreme</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyextremes <span class="im">import</span> get_extremes</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyextremes <span class="im">import</span> EVA</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_empirical_return_periods(hail_events_extremes: ArrayLike) <span class="op">-&gt;</span> ArrayLike:</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute the return period empirically from the data"""</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    ranks <span class="op">=</span> rankdata(a<span class="op">=-</span>hail_events_extremes)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    excedance <span class="op">=</span> ranks <span class="op">/</span> (<span class="bu">len</span>(hail_events_extremes) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    periods <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> excedance</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> periods</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_mle_return_periods_scipy(</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    hail_events_extremes: pd.Series, max_years: <span class="bu">int</span> <span class="op">=</span> <span class="dv">150</span>, min_years: <span class="bu">float</span> <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> List[<span class="bu">float</span>]:</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Estimate the parameters of a genextreme distribution and compute the return periods using</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="co">    the genextreme parameters estimated using scipy.</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    c, loc, scale <span class="op">=</span> genextreme.fit(hail_events_extremes)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    periods <span class="op">=</span> []</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> year <span class="kw">in</span> np.arange(min_years, max_years):</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>        periods.append(genextreme.ppf(<span class="dv">1</span> <span class="op">-</span> <span class="dv">1</span> <span class="op">/</span> year, c, loc<span class="op">=</span>loc, scale<span class="op">=</span>scale))</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> periods</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_mle_return_periods_pyextremes(</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    hail_events_extremes: pd.Series, max_years: <span class="bu">int</span> <span class="op">=</span> <span class="dv">150</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[ArrayLike, Any]:</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Estimate the parameters of a genextreme distribution and compute the return periods using</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a><span class="co">    the genextreme parameters estimated using pyextremes.</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> EVA.from_extremes(extremes<span class="op">=</span>hail_events_extremes, method<span class="op">=</span><span class="st">"BM"</span>)</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>    model.fit_model(distribution_kwargs<span class="op">=</span>{<span class="st">"floc"</span>: <span class="dv">0</span>})</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>    periods, _, _ <span class="op">=</span> model.get_return_value(np.arange(<span class="dv">2</span>, max_years))</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> periods, model</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_fit_extreme_values(</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>    ax: Axes,</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>    category: <span class="bu">str</span>,</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>    model_names: List[<span class="bu">str</span>],</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>    models: Dict[<span class="bu">str</span>, Any],</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>    critical_magnitude: <span class="bu">float</span>,</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>    critical_period: <span class="bu">int</span>,</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Axes:</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Visualize how the estimated return function fit the empirical return values."""</span></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>    ax.scatter(</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>        models[<span class="st">"empirical"</span>][category][<span class="st">"period"</span>],</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>        models[<span class="st">"empirical"</span>][category][<span class="st">"magnitude"</span>],</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>        s<span class="op">=</span><span class="dv">80</span>,</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>        facecolors<span class="op">=</span><span class="st">"none"</span>,</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>        edgecolors<span class="op">=</span><span class="st">"k"</span>,</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">"Empirical Values"</span>,</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>    ax.axhline(critical_magnitude, c<span class="op">=</span><span class="st">"r"</span>, linestyle<span class="op">=</span><span class="st">":"</span>, label<span class="op">=</span><span class="st">"Critical Limit"</span>)</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>    ax.axvline(critical_period, c<span class="op">=</span><span class="st">"r"</span>, linestyle<span class="op">=</span><span class="st">"-."</span>, label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>critical_period<span class="sc">}</span><span class="ss"> Years"</span>)</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> model_name <span class="kw">in</span> model_names:</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>        ax.plot(</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>            models[model_name][category][<span class="st">"period"</span>],</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>            models[model_name][category][<span class="st">"magnitude"</span>],</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(category.split(<span class="st">"_"</span>)))</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>    ax.grid(alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"Hail Size"</span>)</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"Return Period"</span>)</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The first estimation approach we decided to use was based on <a href="https://en.wikipedia.org/wiki/Extreme_value_theory">Extreme Value Theory</a>. In particular we followed <a href="https://comptools.climatematch.io/tutorials/W2D3_ExtremesandVariability/student/W2D3_Intro.html">this tutorial</a> on extreme events provided by course on <a href="https://comptools.climatematch.io/tutorials/intro.html">computational tools in climate science</a>.</p>
<p>Extreme Value Analysis (EVA) usually has the aim of estimating, giving a sample of data, the probability (i.e., risk) associated with an event that is extreme in nature. For doing so it usually require three steps:</p>
<ol type="1">
<li><p>Individuating the extremes in a given period of time with a given time resolution (it usually boils down to be the annual extremes).</p></li>
<li><p>Fit an appropriated statistical distribution to the extreme data.</p></li>
<li><p>Estimate the probability of potentially unseen extreme events using the parameters of the distribution.</p></li>
</ol>
<section id="individuating-the-extremes" class="level3" data-number="1.4.1">
<h3 data-number="1.4.1" class="anchored" data-anchor-id="individuating-the-extremes"><span class="header-section-number">1.4.1</span> Individuating the “Extremes”</h3>
<p>In order to individuate the extreme in our data we have two options:</p>
<ol type="1">
<li>Block Maxima (i.e., BM): selecting the maximum value ove a “block of time” (e.g.&nbsp;a year).</li>
<li>Peak Over Threshold (i.e., POT): selecting all the values higher than a given threshold.</li>
</ol>
<p>Both options have their advantages and dis-advantages. We won’t go into details and just say that we select BM mostly for convenience as it is the methodology that retains most of the data (which is already scarce in our situation). More information can be found in <a href="https://georgebv.github.io/pyextremes/user-guide/2-extreme-value-types/">this page</a>.</p>
<div id="fig-block_maxima" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-block_maxima-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="results/images/block_maxima.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-block_maxima-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Example of Bock Maxima
</figcaption>
</figure>
</div>
<p>In <a href="#fig-block_maxima" class="quarto-xref">Figure&nbsp;6</a> we can see how the maximum monthly hail sizes get converted in maximum <strong>annual</strong> hail sizes by applying a block maxima of size 12 months. One of the major advantages of block maxima is that of partially removing the issue of autocorrelation and seasonality as we take exactly one value for each year.</p>
</section>
<section id="fitting-the-appropriated-distribution" class="level3" data-number="1.4.2">
<h3 data-number="1.4.2" class="anchored" data-anchor-id="fitting-the-appropriated-distribution"><span class="header-section-number">1.4.2</span> Fitting the Appropriated Distribution</h3>
<p>Once we have obtained our samples of extreme values and did all that is in our power to ensure that they are independent and identically distributed (i.i.d.) we can proceed at fitting a distribution to the samples. Which distribution is more suitable depends on the characteristics of the events we are are tying to model.</p>
<p>In the case of extreme events what we are dealing with are tail events better described by skewed distributions with a fat tail. There are 3 types of distribution that are well suited for this: <a href="https://en.wikipedia.org/wiki/Gumbel_distribution">Gumbell</a>, <a href="https://en.wikipedia.org/wiki/Weibull_distribution">Weibull</a> and <a href="https://en.wikipedia.org/wiki/Fréchet_distribution">Frechet</a> which can be flexibly represented by a single 3 parameters distribution the Generalized <a href="https://en.wikipedia.org/wiki/Generalized_extreme_value_distribution">Extreme Value distribution (GEV)</a>.</p>
<p>The Cumulative Distribution Function (CDF) for the GEV is defined as:</p>
<p><span class="math display">\[
H(x) =
\begin{cases}
[1 + \xi(\frac{x - \mu}{\sigma})]^{1/ \xi} ,&amp; \text{if } \xi\neq 0 \\
e^{-(\frac{x - \mu}{\sigma})} ,&amp; \text{if } \xi = 0 \\
\end{cases}
\]</span></p>
<p>with <span class="math inline">\(\mu\)</span> being the location parameter (which controls the center of the distribution), <span class="math inline">\(\sigma\)</span> being the scale parameter (controlling the spread of the distribution) and <span class="math inline">\(\xi\)</span> being the shape parameter (which controls the behavior in the tails of the distribution). The CDF will become important later on when we will try to convert the probability associated with a given extreme value in a return period.</p>
<p>There are some important statistical reasons for choosing the GEV distribution for modelling annual maxima of hail events, but in our case we can see this more clearly by looking at <a href="#fig-gaus_gev_fit" class="quarto-xref">Figure&nbsp;7</a></p>
<div id="fig-gaus_gev_fit" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-gaus_gev_fit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="results/images/hail_events_distributions.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-gaus_gev_fit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Comparing Gaussian and GenExtreme Fit
</figcaption>
</figure>
</div>
<p>The figure show both a Gaussian and a GEV fit to annual maxima for hail sizes. Other than the sub-optimal fit for the Gaussian distribution we can see how the tails in particular (where most problematic and truly extreme events concentrate) are heavily discounted.</p>
</section>
<section id="estimating-the-probability-and-return-period-for-any-extreme-value" class="level3" data-number="1.4.3">
<h3 data-number="1.4.3" class="anchored" data-anchor-id="estimating-the-probability-and-return-period-for-any-extreme-value"><span class="header-section-number">1.4.3</span> Estimating the probability and return period for any extreme value</h3>
<p>Once we have obtained the parameters of the GEV distribution it is possible to estimate the probability of a new, potentially unseen, hail event <strong>as large as a critical value c</strong> as simply <span class="math inline">\(p(event &lt;= c | \mu, \sigma, \xi)\)</span> with <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\sigma\)</span> and <span class="math inline">\(\xi\)</span> being estimated parameters. Of course the probability of observing an event <strong>as large or larger then a critical value c</strong> is simply given by <span class="math inline">\(1 - p\)</span>.</p>
<p>It is also possible to convert this probability value in what is called a “return period” which indicate that on average how much time can pass between an events of certain magnitude or greater. This value is obtained by</p>
<p><span class="math display">\[
T = \frac{1}{1 - p}
\]</span></p>
<p>Given that in our case the time resolution of our extreme events is yearly, we can define each critical value as a “T years event” which indicates that every year there is a <span class="math inline">\(1-p\)</span> of observing an event <strong>as large or larger then the critical value</strong>. For example a “100 years event” indicate a probability of 0.01 of observing said event in a given year.</p>
<p>Let’s see how our EVA approach perform at the state level</p>
<div id="97a7c8d2" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>aggregated_eva_state_modelling <span class="op">=</span> (</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    eva_state_modelling_df.groupby(eva_state_modelling_df[<span class="st">"begin_date_time"</span>].dt.year)[</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>        CONTINUOUS_TARGET</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">max</span>()</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> compute_empirical_return_periods(</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    aggregated_eva_state_modelling[CONTINUOUS_TARGET].values</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>plt.scatter(</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    returns,</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    aggregated_eva_state_modelling[CONTINUOUS_TARGET].values,</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    s<span class="op">=</span><span class="dv">80</span>,</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    facecolors<span class="op">=</span><span class="st">"none"</span>,</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    edgecolors<span class="op">=</span><span class="st">"k"</span>,</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"Empirical Values"</span>,</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>plt.plot(</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    np.arange(<span class="dv">1</span>, <span class="dv">150</span>),</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    compute_mle_return_periods_scipy(</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        aggregated_eva_state_modelling[CONTINUOUS_TARGET],</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>        max_years<span class="op">=</span><span class="dv">150</span>,</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>        min_years<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    c<span class="op">=</span>COLORMAP(<span class="dv">5</span>),</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>plt.grid(alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"Return Periods</span><span class="ch">\n</span><span class="sc">{</span>SINGLE_STATE[<span class="dv">0</span>]<span class="sc">.</span>capitalize()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Hail Size"</span>)</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Years"</span>)</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>plt.axvline(<span class="dv">100</span>, linestyle<span class="op">=</span><span class="st">"-."</span>, c<span class="op">=</span><span class="st">"r"</span>, label<span class="op">=</span><span class="st">"100 Years Event"</span>)</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>plt.axhline(</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    CRITICAL_VALUE_CONTINUOUS_TARGET, linestyle<span class="op">=</span><span class="st">":"</span>, c<span class="op">=</span><span class="st">"r"</span>, label<span class="op">=</span><span class="st">'1.7" Hail Event'</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>in this case we used scipy’s <code>genextreme</code> distribution instead of the library <code>pyextreme</code>. We see how the estimated return periods fit nicely with the empirical values.</p>
<p>Estimating return periods at the state level is not very useful as:</p>
<ol type="1">
<li>US states are rather big.</li>
<li>Over an entire state it is very likely that we will have at least one very large hail event per year. Therefore we might be overestimating the actual county-level risk profile.</li>
</ol>
<p>We can perform the same type of analysis using county level data</p>
<div id="25b66383" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Show supplementary code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"empirical"</span>: {},</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MLE_scipy"</span>: {},</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MLE_pyextreme"</span>: {},</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>county_names <span class="op">=</span> eva_state_modelling_df[<span class="st">"county"</span>].unique()</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> county <span class="kw">in</span> tqdm(county_names):</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    hail_events_extremes <span class="op">=</span> eva_state_modelling_df[</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        eva_state_modelling_df[<span class="st">"county"</span>] <span class="op">==</span> county</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    ][CONTINUOUS_TARGET].values</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    time_index <span class="op">=</span> eva_state_modelling_df[eva_state_modelling_df[<span class="st">"county"</span>] <span class="op">==</span> county][</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        TIME_COLUMN</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    ].values</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    return_value, model <span class="op">=</span> compute_mle_return_periods_pyextremes(</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>        hail_events_extremes<span class="op">=</span>pd.Series(data<span class="op">=</span>hail_events_extremes, index<span class="op">=</span>time_index),</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    models[<span class="st">"empirical"</span>][county] <span class="op">=</span> {</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"period"</span>: compute_empirical_return_periods(</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>            hail_events_extremes<span class="op">=</span>hail_events_extremes,</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"magnitude"</span>: hail_events_extremes,</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    models[<span class="st">"MLE_scipy"</span>][county] <span class="op">=</span> {</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"period"</span>: np.arange(<span class="dv">2</span>, <span class="dv">150</span>),</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"magnitude"</span>: compute_mle_return_periods_scipy(</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>            hail_events_extremes<span class="op">=</span>hail_events_extremes,</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    models[<span class="st">"MLE_pyextreme"</span>][county] <span class="op">=</span> {</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"period"</span>: np.arange(<span class="dv">2</span>, <span class="dv">150</span>),</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"magnitude"</span>: return_value,</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"model"</span>: model,</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>  0%|          | 0/68 [00:00&lt;?, ?it/s]  4%|▍         | 3/68 [00:00&lt;00:02, 25.17it/s] 10%|█         | 7/68 [00:00&lt;00:02, 29.15it/s] 15%|█▍        | 10/68 [00:00&lt;00:01, 29.24it/s] 19%|█▉        | 13/68 [00:00&lt;00:01, 28.81it/s] 24%|██▎       | 16/68 [00:00&lt;00:02, 24.82it/s] 28%|██▊       | 19/68 [00:00&lt;00:02, 22.79it/s] 32%|███▏      | 22/68 [00:00&lt;00:02, 22.76it/s] 37%|███▋      | 25/68 [00:01&lt;00:01, 23.27it/s] 41%|████      | 28/68 [00:01&lt;00:01, 24.32it/s] 46%|████▌     | 31/68 [00:01&lt;00:01, 24.92it/s] 50%|█████     | 34/68 [00:01&lt;00:01, 24.76it/s] 56%|█████▌    | 38/68 [00:01&lt;00:01, 26.89it/s] 62%|██████▏   | 42/68 [00:01&lt;00:00, 28.76it/s] 66%|██████▌   | 45/68 [00:01&lt;00:00, 28.23it/s] 72%|███████▏  | 49/68 [00:01&lt;00:00, 29.36it/s] 76%|███████▋  | 52/68 [00:01&lt;00:00, 27.21it/s] 82%|████████▏ | 56/68 [00:02&lt;00:00, 29.23it/s] 87%|████████▋ | 59/68 [00:02&lt;00:00, 24.40it/s] 91%|█████████ | 62/68 [00:02&lt;00:00, 25.57it/s] 97%|█████████▋| 66/68 [00:02&lt;00:00, 27.46it/s]100%|██████████| 68/68 [00:02&lt;00:00, 26.15it/s]</code></pre>
</div>
</div>
<div id="c82a68d6" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>selected_counties <span class="op">=</span> np.random.choice(county_names, <span class="dv">16</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">4</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>), sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, county <span class="kw">in</span> <span class="bu">zip</span>(axs.flatten(), selected_counties):</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> plot_fit_extreme_values(</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>        ax<span class="op">=</span>ax,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        category<span class="op">=</span>county,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        model_names<span class="op">=</span>[<span class="st">"MLE_pyextreme"</span>],</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        models<span class="op">=</span>models,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        critical_magnitude<span class="op">=</span><span class="fl">1.77</span>,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        critical_period<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As we can see the return periods can provide a substatially different profile depending on the county taken into consideration.</p>
</section>
</section>
<section id="sec-bayesian_regression" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="sec-bayesian_regression"><span class="header-section-number">1.5</span> Estimating Expected Extreme Values and Hail Events using Bayesian Regression</h2>
<p>Looking at <a href="#fig-hail_comparison_total" class="quarto-xref">Figure&nbsp;1</a> we can hypothesize that the probability of observing a hail event of a certain magnitude can be a function of latitude and longitude. Indeed,the extreme hail events, although scattered, seem to show a certain degree of spatial consistency.</p>
<p>So why not simply empirically derive the likelihood of observing a given hail size in a given county? A bit like whe have been doing in <a href="#fig-sample_size" class="quarto-xref">Figure&nbsp;2</a>. As we can see, the empirical percentiles derived from the observed data are very dis-homogeneous. This is because they are strongly influenced by the data we have available for a given county. According to <a href="#fig-sample_size" class="quarto-xref">Figure&nbsp;2</a> sample sizes can vary wildly from county to county and make the empirical estimate subject to the influence of outliers.</p>
<p>In this case what we would want to do is to pool information from the entire state for helping estimating a given percentile of hail size in each county, even in those were we observe a limited number of events. On top of that we would also want to smooth out the contribution of outliers. One option in this case could be to fit a regression model on latitude and longitude data so to be able to estimate the hail size for a given event. However, relying a conventional linear regression approach would not be appropriated in our case as:</p>
<ol type="1">
<li><p>Estimating the mean as simple least square regression would do is not appropriate as in our case we would be interested in the tail of the distribution.</p></li>
<li><p>Assuming the residuals are normally distributed, as it is the case in standard linear regression, does not hold in our case.</p></li>
<li><p>Looking at <a href="#fig-hail_comparison_total" class="quarto-xref">Figure&nbsp;1</a> we can see that if a relationship between latitude, longitude and hail size exists, it is certainly not linear.</p></li>
</ol>
<p>A potential solution to these hurdles would be to fit a <a href="https://en.wikipedia.org/wiki/Quantile_regression">quantile regression</a>. Differently from conventional regression, quantile regression can be used for estimating any quantile in a distribution and not just the mean</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="results/images/quantile_regression.png" class="img-fluid figure-img"></p>
<figcaption>Example of Quantile Regression</figcaption>
</figure>
</div>
<p>Using a regression approach would allow us to include the type of spatial and temporal effect we outlined during oour exploratory data analysis. Generically the regression would have the following formulation:</p>
<p>$_{y_i|X_i}() = + X_i $</p>
<p>with <span class="math inline">\(\tau\)</span> being the desired quantile, <span class="math inline">\(X_i\)</span> all the spatio-temporal covariates associated with hail events <span class="math inline">\(y_i\)</span> and <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> parameters to be estimated. Expanding the formulation for quantile regression further, we would have</p>
<p>$<em>{y_i|X_i}() = + (LatLon_i) </em>{LatLon} + (hour) <em>{Hour} + (month) </em>{month} + (year) _{year} $</p>
<p>here <span class="math inline">\(\phi\)</span> indicate a cubic spline function that we apply in order to model non-linearity in the contribution of the various covariates. More precisly, <span class="math inline">\(\phi(LatLon_i)\)</span> is a <a href="https://stats.stackexchange.com/questions/45446/intuition-behind-tensor-product-interactions-in-gams-mgcv-package-in-r">tensor-product spline</a> generated from the latitude and longitude splines. <span class="math inline">\(\phi(hour)\)</span> and <span class="math inline">\(\phi(month)\)</span> can be thought as seasonal components while <span class="math inline">\(\phi(year)\)</span> can be identified as a trend component.</p>
<p>In order to perform estimation on the entire surface of Florida we opted for an approximation of the spatial covariates by doing the following:</p>
<ol type="1">
<li>Dividing the entire surface of Florida in a grid with 1 mile resolution (see <a href="#fig-estimation_grid" class="quarto-xref">Figure&nbsp;8</a>).</li>
</ol>
<div id="fig-estimation_grid" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-estimation_grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="results/images/estimation_grid.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-estimation_grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: The Estimation Grid Used for the Regression
</figcaption>
</figure>
</div>
<ol start="3" type="1">
<li>For each square in the grid we obtain its centroid and extract the latitude, longitude and maximum observed hail size for that specific centroid obtaining something like the following table</li>
</ol>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: center;">latitude</th>
<th style="text-align: center;">longitude</th>
<th style="text-align: center;">hail_size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">XXX</td>
<td style="text-align: center;">YYY</td>
<td style="text-align: center;">Z</td>
</tr>
<tr class="even">
<td style="text-align: center;">XXX</td>
<td style="text-align: center;">YYY</td>
<td style="text-align: center;">Z</td>
</tr>
<tr class="odd">
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
</tr>
</tbody>
</table>
<p>We retained all measurements associated with a given square so that a single square might have more than one hail event associated to it. It goes without saying that the spatial resolution of our regression here would be entirely determined by the size of the squares.</p>
<div id="855c3a6c" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Show supplementary code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> iqr</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> SplineTransformer, OrdinalEncoder, MinMaxScaler</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jax <span class="im">import</span> numpy <span class="im">as</span> jnp</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jax <span class="im">import</span> random</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpyro.infer.reparam <span class="im">import</span> LocScaleReparam</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpyro.distributions <span class="im">import</span> (</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    Normal,</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    AsymmetricLaplaceQuantile,</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    HalfNormal,</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    HalfCauchy,</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    Distribution,</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    Laplace,</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpyro.infer <span class="im">import</span> MCMC, NUTS, Predictive, SVI, Trace_ELBO, RenyiELBO</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpyro.infer.svi <span class="im">import</span> SVIRunResult</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpyro.infer.autoguide <span class="im">import</span> (</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    AutoDAIS,</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    AutoNormal,</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    AutoLowRankMultivariateNormal,</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    AutoMultivariateNormal,</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>RNG_KEY <span class="op">=</span> random.key(seed<span class="op">=</span><span class="dv">666</span>)</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sample_using_mcmc(</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>    rng_key: ArrayLike,</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    model: Callable,</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>    model_kwargs: Dict[<span class="bu">str</span>, Any],</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>    MCMC_kwargs: Dict[<span class="bu">str</span>, Any],</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> MCMC:</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Sample from the model using MCMC"""</span></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>    rng_key, sub_rng_key <span class="op">=</span> random.split(rng_key)</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>    kernel <span class="op">=</span> NUTS(model<span class="op">=</span>model)</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>    mcmc <span class="op">=</span> MCMC(kernel, progress_bar<span class="op">=</span><span class="va">True</span>, <span class="op">**</span>MCMC_kwargs)</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>    mcmc.run(sub_rng_key, <span class="op">**</span>model_kwargs)</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>    mcmc.print_summary()</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mcmc</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sample_using_svi(</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>    rng_key: ArrayLike,</span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>    model: Callable,</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>    autoguide: Any,</span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>    model_kwargs: Dict[<span class="bu">str</span>, Any],</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>    guide_kwargs: Dict[<span class="bu">str</span>, Any],</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>    optimizer_kwargs: Dict[<span class="bu">str</span>, Any],</span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>    num_steps: <span class="bu">int</span>,</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>    elbo_tracer: Any <span class="op">=</span> Trace_ELBO,</span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>    num_particles: <span class="bu">int</span> <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[SVIRunResult, AutoDAIS]:</span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Sample from the model using variational inference"""</span></span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>    rng_key, sub_rng_key <span class="op">=</span> random.split(rng_key)</span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>    guide <span class="op">=</span> autoguide(model<span class="op">=</span>model, <span class="op">**</span>guide_kwargs)</span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> numpyro.optim.ClippedAdam(<span class="op">**</span>optimizer_kwargs)</span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a>    svi <span class="op">=</span> SVI(model, guide, optimizer, loss<span class="op">=</span>elbo_tracer(num_particles<span class="op">=</span>num_particles))</span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a>    svi_result <span class="op">=</span> svi.run(sub_rng_key, num_steps, <span class="op">**</span>model_kwargs)</span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a>    ax.plot(svi_result.losses)</span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">"ELBO loss"</span>)</span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a>    ax.grid(alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> svi_result, guide</span>
<span id="cb26-70"><a href="#cb26-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-71"><a href="#cb26-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-72"><a href="#cb26-72" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sample_posterior_predictive_mcmc(</span>
<span id="cb26-73"><a href="#cb26-73" aria-hidden="true" tabindex="-1"></a>    rng_key: ArrayLike,</span>
<span id="cb26-74"><a href="#cb26-74" aria-hidden="true" tabindex="-1"></a>    model: Callable,</span>
<span id="cb26-75"><a href="#cb26-75" aria-hidden="true" tabindex="-1"></a>    posterior_samples: Dict[<span class="bu">str</span>, Any],</span>
<span id="cb26-76"><a href="#cb26-76" aria-hidden="true" tabindex="-1"></a>    model_kwargs: Dict[<span class="bu">str</span>, Any],</span>
<span id="cb26-77"><a href="#cb26-77" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> ArrayLike:</span>
<span id="cb26-78"><a href="#cb26-78" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Sample from the posterior using MCMC  posterior samples"""</span></span>
<span id="cb26-79"><a href="#cb26-79" aria-hidden="true" tabindex="-1"></a>    rng_key, sub_rng_key <span class="op">=</span> random.split(rng_key)</span>
<span id="cb26-80"><a href="#cb26-80" aria-hidden="true" tabindex="-1"></a>    predictive <span class="op">=</span> Predictive(model, posterior_samples<span class="op">=</span>posterior_samples)</span>
<span id="cb26-81"><a href="#cb26-81" aria-hidden="true" tabindex="-1"></a>    posterior_predictive <span class="op">=</span> predictive(rng_key<span class="op">=</span>sub_rng_key, <span class="op">**</span>model_kwargs)</span>
<span id="cb26-82"><a href="#cb26-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> posterior_predictive</span>
<span id="cb26-83"><a href="#cb26-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-84"><a href="#cb26-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-85"><a href="#cb26-85" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sample_posterior_predictive_svi(</span>
<span id="cb26-86"><a href="#cb26-86" aria-hidden="true" tabindex="-1"></a>    rng_key: ArrayLike,</span>
<span id="cb26-87"><a href="#cb26-87" aria-hidden="true" tabindex="-1"></a>    model: Callable,</span>
<span id="cb26-88"><a href="#cb26-88" aria-hidden="true" tabindex="-1"></a>    guide: AutoDAIS,</span>
<span id="cb26-89"><a href="#cb26-89" aria-hidden="true" tabindex="-1"></a>    covariates_hat: Dict[<span class="bu">str</span>, ArrayLike],</span>
<span id="cb26-90"><a href="#cb26-90" aria-hidden="true" tabindex="-1"></a>    svi_result: SVIRunResult,</span>
<span id="cb26-91"><a href="#cb26-91" aria-hidden="true" tabindex="-1"></a>    num_samples: <span class="bu">int</span>,</span>
<span id="cb26-92"><a href="#cb26-92" aria-hidden="true" tabindex="-1"></a>    model_kwargs: Dict[<span class="bu">str</span>, Any],</span>
<span id="cb26-93"><a href="#cb26-93" aria-hidden="true" tabindex="-1"></a>    return_sites: List[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb26-94"><a href="#cb26-94" aria-hidden="true" tabindex="-1"></a>    target: ArrayLike <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb26-95"><a href="#cb26-95" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> ArrayLike:</span>
<span id="cb26-96"><a href="#cb26-96" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Sample from the posterior using SVI inferred parameters"""</span></span>
<span id="cb26-97"><a href="#cb26-97" aria-hidden="true" tabindex="-1"></a>    model_kwargs <span class="op">=</span> {key: value <span class="cf">for</span> key, value <span class="kw">in</span> model_kwargs.items()}</span>
<span id="cb26-98"><a href="#cb26-98" aria-hidden="true" tabindex="-1"></a>    model_kwargs[<span class="st">"target"</span>] <span class="op">=</span> target</span>
<span id="cb26-99"><a href="#cb26-99" aria-hidden="true" tabindex="-1"></a>    model_kwargs[<span class="st">"covariates"</span>] <span class="op">=</span> covariates_hat</span>
<span id="cb26-100"><a href="#cb26-100" aria-hidden="true" tabindex="-1"></a>    predictive <span class="op">=</span> Predictive(</span>
<span id="cb26-101"><a href="#cb26-101" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>model,</span>
<span id="cb26-102"><a href="#cb26-102" aria-hidden="true" tabindex="-1"></a>        guide<span class="op">=</span>guide,</span>
<span id="cb26-103"><a href="#cb26-103" aria-hidden="true" tabindex="-1"></a>        params<span class="op">=</span>svi_result.params,</span>
<span id="cb26-104"><a href="#cb26-104" aria-hidden="true" tabindex="-1"></a>        num_samples<span class="op">=</span>num_samples,</span>
<span id="cb26-105"><a href="#cb26-105" aria-hidden="true" tabindex="-1"></a>        exclude_deterministic<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb26-106"><a href="#cb26-106" aria-hidden="true" tabindex="-1"></a>        return_sites<span class="op">=</span>return_sites,</span>
<span id="cb26-107"><a href="#cb26-107" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-108"><a href="#cb26-108" aria-hidden="true" tabindex="-1"></a>    rng_key, sub_rng_key <span class="op">=</span> random.split(rng_key)</span>
<span id="cb26-109"><a href="#cb26-109" aria-hidden="true" tabindex="-1"></a>    posterior_predictive <span class="op">=</span> predictive(rng_key<span class="op">=</span>sub_rng_key, <span class="op">**</span>model_kwargs)</span>
<span id="cb26-110"><a href="#cb26-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> posterior_predictive</span>
<span id="cb26-111"><a href="#cb26-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-112"><a href="#cb26-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-113"><a href="#cb26-113" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> transform_fitting_covariates(</span>
<span id="cb26-114"><a href="#cb26-114" aria-hidden="true" tabindex="-1"></a>    covariates: Dict[<span class="bu">str</span>, ArrayLike],</span>
<span id="cb26-115"><a href="#cb26-115" aria-hidden="true" tabindex="-1"></a>    transformers: Dict[<span class="bu">str</span>, Any],</span>
<span id="cb26-116"><a href="#cb26-116" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[Dict[<span class="bu">str</span>, ArrayLike], Dict[<span class="bu">str</span>, Any]]:</span>
<span id="cb26-117"><a href="#cb26-117" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Fit transformers and transform covariates"""</span></span>
<span id="cb26-118"><a href="#cb26-118" aria-hidden="true" tabindex="-1"></a>    transformed_covariates <span class="op">=</span> {}</span>
<span id="cb26-119"><a href="#cb26-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> covariate_name, covariate_array <span class="kw">in</span> covariates.items():</span>
<span id="cb26-120"><a href="#cb26-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-121"><a href="#cb26-121" aria-hidden="true" tabindex="-1"></a>        transformers[covariate_name].fit(covariate_array)</span>
<span id="cb26-122"><a href="#cb26-122" aria-hidden="true" tabindex="-1"></a>        transformed_covariates[covariate_name] <span class="op">=</span> transformers[covariate_name].transform(</span>
<span id="cb26-123"><a href="#cb26-123" aria-hidden="true" tabindex="-1"></a>            covariate_array</span>
<span id="cb26-124"><a href="#cb26-124" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-125"><a href="#cb26-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-126"><a href="#cb26-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> transformed_covariates, transformers</span>
<span id="cb26-127"><a href="#cb26-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-128"><a href="#cb26-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-129"><a href="#cb26-129" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> transform_estimation_covariates(</span>
<span id="cb26-130"><a href="#cb26-130" aria-hidden="true" tabindex="-1"></a>    covariates: Dict[<span class="bu">str</span>, ArrayLike],</span>
<span id="cb26-131"><a href="#cb26-131" aria-hidden="true" tabindex="-1"></a>    transformers: Dict[<span class="bu">str</span>, Any],</span>
<span id="cb26-132"><a href="#cb26-132" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, ArrayLike]:</span>
<span id="cb26-133"><a href="#cb26-133" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Transform covariates using fitted transformers"""</span></span>
<span id="cb26-134"><a href="#cb26-134" aria-hidden="true" tabindex="-1"></a>    transformed_covariates <span class="op">=</span> {}</span>
<span id="cb26-135"><a href="#cb26-135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> covariate_name, covariate_array <span class="kw">in</span> covariates.items():</span>
<span id="cb26-136"><a href="#cb26-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-137"><a href="#cb26-137" aria-hidden="true" tabindex="-1"></a>        transformed_covariates[covariate_name] <span class="op">=</span> transformers[covariate_name].transform(</span>
<span id="cb26-138"><a href="#cb26-138" aria-hidden="true" tabindex="-1"></a>            covariate_array</span>
<span id="cb26-139"><a href="#cb26-139" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-140"><a href="#cb26-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-141"><a href="#cb26-141" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> transformed_covariates</span>
<span id="cb26-142"><a href="#cb26-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-143"><a href="#cb26-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-144"><a href="#cb26-144" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> jaxify_array_dictionary(</span>
<span id="cb26-145"><a href="#cb26-145" aria-hidden="true" tabindex="-1"></a>    array_dictionary: Dict[<span class="bu">str</span>, ArrayLike],</span>
<span id="cb26-146"><a href="#cb26-146" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, ArrayLike]:</span>
<span id="cb26-147"><a href="#cb26-147" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Turn arrays in a dictionary into JAX arrays"""</span></span>
<span id="cb26-148"><a href="#cb26-148" aria-hidden="true" tabindex="-1"></a>    jaxified_array_dictionary <span class="op">=</span> {}</span>
<span id="cb26-149"><a href="#cb26-149" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key, value <span class="kw">in</span> array_dictionary.items():</span>
<span id="cb26-150"><a href="#cb26-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-151"><a href="#cb26-151" aria-hidden="true" tabindex="-1"></a>        jaxified_array_dictionary[key] <span class="op">=</span> jnp.array(value)</span>
<span id="cb26-152"><a href="#cb26-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-153"><a href="#cb26-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jaxified_array_dictionary</span>
<span id="cb26-154"><a href="#cb26-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-155"><a href="#cb26-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-156"><a href="#cb26-156" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_modelling_data(</span>
<span id="cb26-157"><a href="#cb26-157" aria-hidden="true" tabindex="-1"></a>    covariates: Dict[<span class="bu">str</span>, ArrayLike],</span>
<span id="cb26-158"><a href="#cb26-158" aria-hidden="true" tabindex="-1"></a>    covariates_hat: Dict[<span class="bu">str</span>, ArrayLike],</span>
<span id="cb26-159"><a href="#cb26-159" aria-hidden="true" tabindex="-1"></a>    transformers: Dict[<span class="bu">str</span>, Pipeline],</span>
<span id="cb26-160"><a href="#cb26-160" aria-hidden="true" tabindex="-1"></a>    target: ArrayLike,</span>
<span id="cb26-161"><a href="#cb26-161" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[Dict[<span class="bu">str</span>, Pipeline], Dict[<span class="bu">str</span>, ArrayLike], Dict[<span class="bu">str</span>, ArrayLike], ArrayLike]:</span>
<span id="cb26-162"><a href="#cb26-162" aria-hidden="true" tabindex="-1"></a>    transformed_covariates, transformers <span class="op">=</span> transform_fitting_covariates(</span>
<span id="cb26-163"><a href="#cb26-163" aria-hidden="true" tabindex="-1"></a>        covariates<span class="op">=</span>covariates,</span>
<span id="cb26-164"><a href="#cb26-164" aria-hidden="true" tabindex="-1"></a>        transformers<span class="op">=</span>transformers,</span>
<span id="cb26-165"><a href="#cb26-165" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-166"><a href="#cb26-166" aria-hidden="true" tabindex="-1"></a>    transformed_covariates_hat <span class="op">=</span> transform_estimation_covariates(</span>
<span id="cb26-167"><a href="#cb26-167" aria-hidden="true" tabindex="-1"></a>        covariates<span class="op">=</span>covariates_hat,</span>
<span id="cb26-168"><a href="#cb26-168" aria-hidden="true" tabindex="-1"></a>        transformers<span class="op">=</span>transformers,</span>
<span id="cb26-169"><a href="#cb26-169" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-170"><a href="#cb26-170" aria-hidden="true" tabindex="-1"></a>    transformed_covariates <span class="op">=</span> jaxify_array_dictionary(</span>
<span id="cb26-171"><a href="#cb26-171" aria-hidden="true" tabindex="-1"></a>        array_dictionary<span class="op">=</span>transformed_covariates,</span>
<span id="cb26-172"><a href="#cb26-172" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-173"><a href="#cb26-173" aria-hidden="true" tabindex="-1"></a>    transformed_covariates_hat <span class="op">=</span> jaxify_array_dictionary(</span>
<span id="cb26-174"><a href="#cb26-174" aria-hidden="true" tabindex="-1"></a>        array_dictionary<span class="op">=</span>transformed_covariates_hat,</span>
<span id="cb26-175"><a href="#cb26-175" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-176"><a href="#cb26-176" aria-hidden="true" tabindex="-1"></a>    target <span class="op">=</span> jnp.array(target)</span>
<span id="cb26-177"><a href="#cb26-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-178"><a href="#cb26-178" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> transformers, transformed_covariates, transformed_covariates_hat, target</span>
<span id="cb26-179"><a href="#cb26-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-180"><a href="#cb26-180" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_temporal_components(</span>
<span id="cb26-181"><a href="#cb26-181" aria-hidden="true" tabindex="-1"></a>    posterior: Dict[<span class="bu">str</span>, ArrayLike],</span>
<span id="cb26-182"><a href="#cb26-182" aria-hidden="true" tabindex="-1"></a>    transformers: Dict[<span class="bu">str</span>, Pipeline],</span>
<span id="cb26-183"><a href="#cb26-183" aria-hidden="true" tabindex="-1"></a>    years: ArrayLike,</span>
<span id="cb26-184"><a href="#cb26-184" aria-hidden="true" tabindex="-1"></a>    suffix: <span class="bu">str</span> <span class="op">=</span> <span class="st">""</span>,</span>
<span id="cb26-185"><a href="#cb26-185" aria-hidden="true" tabindex="-1"></a>    parameter_transformer: Callable <span class="op">=</span> <span class="va">None</span></span>
<span id="cb26-186"><a href="#cb26-186" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, ArrayLike]:</span>
<span id="cb26-187"><a href="#cb26-187" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generate the temporal components"""</span></span>
<span id="cb26-188"><a href="#cb26-188" aria-hidden="true" tabindex="-1"></a>    mapped_dot <span class="op">=</span> vmap(jnp.dot, in_axes<span class="op">=</span>(<span class="va">None</span>, <span class="dv">0</span>))</span>
<span id="cb26-189"><a href="#cb26-189" aria-hidden="true" tabindex="-1"></a>    covariates <span class="op">=</span> {</span>
<span id="cb26-190"><a href="#cb26-190" aria-hidden="true" tabindex="-1"></a>        <span class="st">"year_covariates"</span>: (years.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)),</span>
<span id="cb26-191"><a href="#cb26-191" aria-hidden="true" tabindex="-1"></a>        <span class="st">"month_covariates"</span>: (np.arange(<span class="dv">1</span>, <span class="dv">13</span>).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)),</span>
<span id="cb26-192"><a href="#cb26-192" aria-hidden="true" tabindex="-1"></a>        <span class="st">"hour_covariates"</span>: (np.arange(<span class="dv">24</span>).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)),</span>
<span id="cb26-193"><a href="#cb26-193" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb26-194"><a href="#cb26-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-195"><a href="#cb26-195" aria-hidden="true" tabindex="-1"></a>    covariates <span class="op">=</span> transform_estimation_covariates(</span>
<span id="cb26-196"><a href="#cb26-196" aria-hidden="true" tabindex="-1"></a>        covariates<span class="op">=</span>covariates, transformers<span class="op">=</span>transformers</span>
<span id="cb26-197"><a href="#cb26-197" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-198"><a href="#cb26-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-199"><a href="#cb26-199" aria-hidden="true" tabindex="-1"></a>    year_component <span class="op">=</span> mapped_dot(</span>
<span id="cb26-200"><a href="#cb26-200" aria-hidden="true" tabindex="-1"></a>        covariates[<span class="st">"year_covariates"</span>], posterior[<span class="ss">f"beta_year</span><span class="sc">{</span>suffix<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb26-201"><a href="#cb26-201" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-202"><a href="#cb26-202" aria-hidden="true" tabindex="-1"></a>    month_component <span class="op">=</span> mapped_dot(</span>
<span id="cb26-203"><a href="#cb26-203" aria-hidden="true" tabindex="-1"></a>        covariates[<span class="st">"month_covariates"</span>], posterior[<span class="ss">f"beta_month</span><span class="sc">{</span>suffix<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb26-204"><a href="#cb26-204" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-205"><a href="#cb26-205" aria-hidden="true" tabindex="-1"></a>    hour_component <span class="op">=</span> mapped_dot(</span>
<span id="cb26-206"><a href="#cb26-206" aria-hidden="true" tabindex="-1"></a>        covariates[<span class="st">"hour_covariates"</span>], posterior[<span class="ss">f"beta_hour</span><span class="sc">{</span>suffix<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb26-207"><a href="#cb26-207" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-208"><a href="#cb26-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-209"><a href="#cb26-209" aria-hidden="true" tabindex="-1"></a>    posterior_components <span class="op">=</span> {</span>
<span id="cb26-210"><a href="#cb26-210" aria-hidden="true" tabindex="-1"></a>        <span class="st">"year_component"</span>: year_component,</span>
<span id="cb26-211"><a href="#cb26-211" aria-hidden="true" tabindex="-1"></a>        <span class="st">"month_component"</span>: month_component,</span>
<span id="cb26-212"><a href="#cb26-212" aria-hidden="true" tabindex="-1"></a>        <span class="st">"hour_component"</span>: hour_component,</span>
<span id="cb26-213"><a href="#cb26-213" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb26-214"><a href="#cb26-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-215"><a href="#cb26-215" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> parameter_transformer <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb26-216"><a href="#cb26-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-217"><a href="#cb26-217" aria-hidden="true" tabindex="-1"></a>        posterior_components <span class="op">=</span> {</span>
<span id="cb26-218"><a href="#cb26-218" aria-hidden="true" tabindex="-1"></a>            key: parameter_transformer(value) <span class="cf">for</span> key, value <span class="kw">in</span> posterior_components.items()</span>
<span id="cb26-219"><a href="#cb26-219" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb26-220"><a href="#cb26-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-221"><a href="#cb26-221" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> posterior_components</span>
<span id="cb26-222"><a href="#cb26-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-223"><a href="#cb26-223" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_geo_regression(</span>
<span id="cb26-224"><a href="#cb26-224" aria-hidden="true" tabindex="-1"></a>    covariates_hat_df: gpd.GeoDataFrame, posterior: Dict[<span class="bu">str</span>, ArrayLike], parameter: <span class="bu">str</span>, parameter_transformer: Callable <span class="op">=</span> <span class="va">None</span></span>
<span id="cb26-225"><a href="#cb26-225" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[plt.Figure, Axes]:</span>
<span id="cb26-226"><a href="#cb26-226" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Visualize the result from the regression on a geodataframe."""</span></span>
<span id="cb26-227"><a href="#cb26-227" aria-hidden="true" tabindex="-1"></a>    parameter_value <span class="op">=</span> posterior[parameter]</span>
<span id="cb26-228"><a href="#cb26-228" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> parameter_transformer <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb26-229"><a href="#cb26-229" aria-hidden="true" tabindex="-1"></a>        parameter_value <span class="op">=</span> parameter_transformer(parameter_value)</span>
<span id="cb26-230"><a href="#cb26-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-231"><a href="#cb26-231" aria-hidden="true" tabindex="-1"></a>    covariates_hat_df[<span class="st">"2.5%"</span>] <span class="op">=</span> np.percentile(</span>
<span id="cb26-232"><a href="#cb26-232" aria-hidden="true" tabindex="-1"></a>        parameter_value,</span>
<span id="cb26-233"><a href="#cb26-233" aria-hidden="true" tabindex="-1"></a>        q<span class="op">=</span><span class="fl">2.5</span>,</span>
<span id="cb26-234"><a href="#cb26-234" aria-hidden="true" tabindex="-1"></a>        axis<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb26-235"><a href="#cb26-235" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-236"><a href="#cb26-236" aria-hidden="true" tabindex="-1"></a>    covariates_hat_df[<span class="st">"Median"</span>] <span class="op">=</span> np.percentile(</span>
<span id="cb26-237"><a href="#cb26-237" aria-hidden="true" tabindex="-1"></a>        parameter_value,</span>
<span id="cb26-238"><a href="#cb26-238" aria-hidden="true" tabindex="-1"></a>        q<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb26-239"><a href="#cb26-239" aria-hidden="true" tabindex="-1"></a>        axis<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb26-240"><a href="#cb26-240" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-241"><a href="#cb26-241" aria-hidden="true" tabindex="-1"></a>    covariates_hat_df[<span class="st">"97.5%"</span>] <span class="op">=</span> np.percentile(</span>
<span id="cb26-242"><a href="#cb26-242" aria-hidden="true" tabindex="-1"></a>        parameter_value,</span>
<span id="cb26-243"><a href="#cb26-243" aria-hidden="true" tabindex="-1"></a>        q<span class="op">=</span><span class="fl">97.5</span>,</span>
<span id="cb26-244"><a href="#cb26-244" aria-hidden="true" tabindex="-1"></a>        axis<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb26-245"><a href="#cb26-245" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-246"><a href="#cb26-246" aria-hidden="true" tabindex="-1"></a>    fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">10</span>))</span>
<span id="cb26-247"><a href="#cb26-247" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, column <span class="kw">in</span> <span class="bu">zip</span>(axs, [<span class="st">"2.5%"</span>, <span class="st">"Median"</span>, <span class="st">"97.5%"</span>]):</span>
<span id="cb26-248"><a href="#cb26-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-249"><a href="#cb26-249" aria-hidden="true" tabindex="-1"></a>        covariates_hat_df.plot(</span>
<span id="cb26-250"><a href="#cb26-250" aria-hidden="true" tabindex="-1"></a>            column,</span>
<span id="cb26-251"><a href="#cb26-251" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax,</span>
<span id="cb26-252"><a href="#cb26-252" aria-hidden="true" tabindex="-1"></a>            cmap<span class="op">=</span>COLORMAP_NAME,</span>
<span id="cb26-253"><a href="#cb26-253" aria-hidden="true" tabindex="-1"></a>            legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb26-254"><a href="#cb26-254" aria-hidden="true" tabindex="-1"></a>            legend_kwds<span class="op">=</span>{<span class="st">"shrink"</span>: <span class="fl">0.3</span>},</span>
<span id="cb26-255"><a href="#cb26-255" aria-hidden="true" tabindex="-1"></a>            vmin<span class="op">=</span>np.percentile(parameter_value, q<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb26-256"><a href="#cb26-256" aria-hidden="true" tabindex="-1"></a>            vmax<span class="op">=</span>np.percentile(parameter_value, q<span class="op">=</span><span class="dv">99</span>),</span>
<span id="cb26-257"><a href="#cb26-257" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-258"><a href="#cb26-258" aria-hidden="true" tabindex="-1"></a>        ax.grid(alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb26-259"><a href="#cb26-259" aria-hidden="true" tabindex="-1"></a>        ax.set_title(column)</span>
<span id="cb26-260"><a href="#cb26-260" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">"Longitude"</span>)</span>
<span id="cb26-261"><a href="#cb26-261" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">"Latitude"</span>)</span>
<span id="cb26-262"><a href="#cb26-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-263"><a href="#cb26-263" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig, axs</span>
<span id="cb26-264"><a href="#cb26-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-265"><a href="#cb26-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-266"><a href="#cb26-266" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_county_regression(</span>
<span id="cb26-267"><a href="#cb26-267" aria-hidden="true" tabindex="-1"></a>    modelling_df: pd.DataFrame,</span>
<span id="cb26-268"><a href="#cb26-268" aria-hidden="true" tabindex="-1"></a>    covariates_hat_df: gpd.GeoDataFrame,</span>
<span id="cb26-269"><a href="#cb26-269" aria-hidden="true" tabindex="-1"></a>    posterior: Dict[<span class="bu">str</span>, ArrayLike],</span>
<span id="cb26-270"><a href="#cb26-270" aria-hidden="true" tabindex="-1"></a>    parameter: <span class="bu">str</span>,</span>
<span id="cb26-271"><a href="#cb26-271" aria-hidden="true" tabindex="-1"></a>    target: <span class="bu">str</span>,</span>
<span id="cb26-272"><a href="#cb26-272" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[plt.Figure, Axes]:</span>
<span id="cb26-273"><a href="#cb26-273" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Visualize the regression at county level"""</span></span>
<span id="cb26-274"><a href="#cb26-274" aria-hidden="true" tabindex="-1"></a>    samples_df <span class="op">=</span> pd.DataFrame(posterior[parameter].T)</span>
<span id="cb26-275"><a href="#cb26-275" aria-hidden="true" tabindex="-1"></a>    samples_df[COUNTIES_INDEX] <span class="op">=</span> covariates_hat_df[COUNTIES_INDEX].values</span>
<span id="cb26-276"><a href="#cb26-276" aria-hidden="true" tabindex="-1"></a>    rows <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb26-277"><a href="#cb26-277" aria-hidden="true" tabindex="-1"></a>    random_counties <span class="op">=</span> np.random.choice(</span>
<span id="cb26-278"><a href="#cb26-278" aria-hidden="true" tabindex="-1"></a>        samples_df[COUNTIES_INDEX].unique(), rows<span class="op">**</span><span class="dv">2</span>, replace<span class="op">=</span><span class="va">False</span></span>
<span id="cb26-279"><a href="#cb26-279" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-280"><a href="#cb26-280" aria-hidden="true" tabindex="-1"></a>    fig, axs <span class="op">=</span> plt.subplots(rows, rows, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb26-281"><a href="#cb26-281" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> county, ax <span class="kw">in</span> <span class="bu">zip</span>(random_counties, axs.flatten()):</span>
<span id="cb26-282"><a href="#cb26-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-283"><a href="#cb26-283" aria-hidden="true" tabindex="-1"></a>        county_target <span class="op">=</span> modelling_df[modelling_df[COUNTIES_INDEX] <span class="op">==</span> county][</span>
<span id="cb26-284"><a href="#cb26-284" aria-hidden="true" tabindex="-1"></a>            target</span>
<span id="cb26-285"><a href="#cb26-285" aria-hidden="true" tabindex="-1"></a>        ].values</span>
<span id="cb26-286"><a href="#cb26-286" aria-hidden="true" tabindex="-1"></a>        county_samples <span class="op">=</span> (</span>
<span id="cb26-287"><a href="#cb26-287" aria-hidden="true" tabindex="-1"></a>            samples_df[samples_df[COUNTIES_INDEX] <span class="op">==</span> county]</span>
<span id="cb26-288"><a href="#cb26-288" aria-hidden="true" tabindex="-1"></a>            .drop([COUNTIES_INDEX], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb26-289"><a href="#cb26-289" aria-hidden="true" tabindex="-1"></a>            .values.flatten()</span>
<span id="cb26-290"><a href="#cb26-290" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-291"><a href="#cb26-291" aria-hidden="true" tabindex="-1"></a>        sns.histplot(</span>
<span id="cb26-292"><a href="#cb26-292" aria-hidden="true" tabindex="-1"></a>            data<span class="op">=</span>county_target,</span>
<span id="cb26-293"><a href="#cb26-293" aria-hidden="true" tabindex="-1"></a>            element<span class="op">=</span><span class="st">"step"</span>,</span>
<span id="cb26-294"><a href="#cb26-294" aria-hidden="true" tabindex="-1"></a>            fill<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb26-295"><a href="#cb26-295" aria-hidden="true" tabindex="-1"></a>            stat<span class="op">=</span><span class="st">"density"</span>,</span>
<span id="cb26-296"><a href="#cb26-296" aria-hidden="true" tabindex="-1"></a>            ax<span class="op">=</span>ax,</span>
<span id="cb26-297"><a href="#cb26-297" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>COLORMAP(<span class="dv">5</span>),</span>
<span id="cb26-298"><a href="#cb26-298" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-299"><a href="#cb26-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-300"><a href="#cb26-300" aria-hidden="true" tabindex="-1"></a>        ax.axvline(np.quantile(county_target, CRITICAL_QUANTILE), c<span class="op">=</span><span class="st">"r"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb26-301"><a href="#cb26-301" aria-hidden="true" tabindex="-1"></a>        ax.axvspan(</span>
<span id="cb26-302"><a href="#cb26-302" aria-hidden="true" tabindex="-1"></a>            np.quantile(county_samples, <span class="fl">0.025</span>),</span>
<span id="cb26-303"><a href="#cb26-303" aria-hidden="true" tabindex="-1"></a>            np.quantile(county_samples, <span class="fl">0.975</span>),</span>
<span id="cb26-304"><a href="#cb26-304" aria-hidden="true" tabindex="-1"></a>            alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb26-305"><a href="#cb26-305" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">"red"</span>,</span>
<span id="cb26-306"><a href="#cb26-306" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-307"><a href="#cb26-307" aria-hidden="true" tabindex="-1"></a>        ax.grid(alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb26-308"><a href="#cb26-308" aria-hidden="true" tabindex="-1"></a>        ax.set_ylim(<span class="dv">0</span>, <span class="va">None</span>)</span>
<span id="cb26-309"><a href="#cb26-309" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb26-310"><a href="#cb26-310" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig, axs</span>
<span id="cb26-311"><a href="#cb26-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-312"><a href="#cb26-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-313"><a href="#cb26-313" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_temporal_components(temporal_components: Dict[<span class="bu">str</span>, ArrayLike]) <span class="op">-&gt;</span> Tuple[plt.Figure, Axes]:</span>
<span id="cb26-314"><a href="#cb26-314" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Visualize the various temporal components"""</span></span>
<span id="cb26-315"><a href="#cb26-315" aria-hidden="true" tabindex="-1"></a>    fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb26-316"><a href="#cb26-316" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, component <span class="kw">in</span> <span class="bu">zip</span>(axs.flatten(), [<span class="st">"year_component"</span>, <span class="st">"month_component"</span>, <span class="st">"hour_component"</span>]):</span>
<span id="cb26-317"><a href="#cb26-317" aria-hidden="true" tabindex="-1"></a>        ax.plot(</span>
<span id="cb26-318"><a href="#cb26-318" aria-hidden="true" tabindex="-1"></a>            np.percentile(</span>
<span id="cb26-319"><a href="#cb26-319" aria-hidden="true" tabindex="-1"></a>                a<span class="op">=</span>temporal_components[component],</span>
<span id="cb26-320"><a href="#cb26-320" aria-hidden="true" tabindex="-1"></a>                q<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb26-321"><a href="#cb26-321" aria-hidden="true" tabindex="-1"></a>                axis<span class="op">=</span><span class="dv">0</span></span>
<span id="cb26-322"><a href="#cb26-322" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb26-323"><a href="#cb26-323" aria-hidden="true" tabindex="-1"></a>            c<span class="op">=</span>COLORMAP(<span class="dv">5</span>)</span>
<span id="cb26-324"><a href="#cb26-324" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-325"><a href="#cb26-325" aria-hidden="true" tabindex="-1"></a>        ax.fill_between(</span>
<span id="cb26-326"><a href="#cb26-326" aria-hidden="true" tabindex="-1"></a>            np.arange(temporal_components[component].shape[<span class="dv">1</span>]),</span>
<span id="cb26-327"><a href="#cb26-327" aria-hidden="true" tabindex="-1"></a>            np.percentile(</span>
<span id="cb26-328"><a href="#cb26-328" aria-hidden="true" tabindex="-1"></a>                a<span class="op">=</span>temporal_components[component],</span>
<span id="cb26-329"><a href="#cb26-329" aria-hidden="true" tabindex="-1"></a>                q<span class="op">=</span><span class="fl">2.5</span>,</span>
<span id="cb26-330"><a href="#cb26-330" aria-hidden="true" tabindex="-1"></a>                axis<span class="op">=</span><span class="dv">0</span></span>
<span id="cb26-331"><a href="#cb26-331" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb26-332"><a href="#cb26-332" aria-hidden="true" tabindex="-1"></a>            np.percentile(</span>
<span id="cb26-333"><a href="#cb26-333" aria-hidden="true" tabindex="-1"></a>                a<span class="op">=</span>temporal_components[component],</span>
<span id="cb26-334"><a href="#cb26-334" aria-hidden="true" tabindex="-1"></a>                q<span class="op">=</span><span class="fl">97.5</span>,</span>
<span id="cb26-335"><a href="#cb26-335" aria-hidden="true" tabindex="-1"></a>                axis<span class="op">=</span><span class="dv">0</span></span>
<span id="cb26-336"><a href="#cb26-336" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb26-337"><a href="#cb26-337" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>COLORMAP(<span class="dv">1</span>),</span>
<span id="cb26-338"><a href="#cb26-338" aria-hidden="true" tabindex="-1"></a>            alpha<span class="op">=</span><span class="fl">0.5</span></span>
<span id="cb26-339"><a href="#cb26-339" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-340"><a href="#cb26-340" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="st">" "</span>.join(component.split(<span class="st">"_"</span>)))</span>
<span id="cb26-341"><a href="#cb26-341" aria-hidden="true" tabindex="-1"></a>        ax.grid(alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb26-342"><a href="#cb26-342" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(component.split(<span class="st">"_"</span>)[<span class="dv">0</span>])</span>
<span id="cb26-343"><a href="#cb26-343" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(<span class="st">"Component Contribution"</span>)</span>
<span id="cb26-344"><a href="#cb26-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-345"><a href="#cb26-345" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb26-346"><a href="#cb26-346" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig, axs</span>
<span id="cb26-347"><a href="#cb26-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-348"><a href="#cb26-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-349"><a href="#cb26-349" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_tensor_product_spline(first_spline, second_spline):</span>
<span id="cb26-350"><a href="#cb26-350" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.tensordot(first_spline, second_spline, axes<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="sec-quantile_regression" class="level3" data-number="1.5.1">
<h3 data-number="1.5.1" class="anchored" data-anchor-id="sec-quantile_regression"><span class="header-section-number">1.5.1</span> Estimating Expected Extreme Values Using Quantile Regression</h3>
<div id="82d58e2e" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Show supplementary code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_estimation_covariates_quantile_regression(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    months: List[<span class="bu">int</span>],</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    hours: List[<span class="bu">int</span>],</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    years: List[<span class="bu">int</span>],</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    geometries_df: gpd.GeoDataFrame,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    edge_size: <span class="bu">float</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    states: List[<span class="bu">str</span>],</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[gpd.GeoDataFrame, Dict[<span class="bu">str</span>, ArrayLike]]:</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create the covariates for estimation"""</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    quantile_regression_covariates_hat_df <span class="op">=</span> create_covariates_df(</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>        geometries_df<span class="op">=</span>geometries_df,</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>        edge_size<span class="op">=</span>edge_size,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>        state<span class="op">=</span>states,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>        months<span class="op">=</span>months,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>        hours<span class="op">=</span>hours,</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>        years<span class="op">=</span>years,</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    quantile_regression_covariates_hat <span class="op">=</span> {</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"latitude_covariates"</span>: (</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>            quantile_regression_covariates_hat_df[LAT_COVARIATES].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"longitude_covariates"</span>: (</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>            quantile_regression_covariates_hat_df[LON_COVARIATES].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"year_covariates"</span>: (</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>            quantile_regression_covariates_hat_df[YEAR_COVARIATES].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"month_covariates"</span>: (</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>            quantile_regression_covariates_hat_df[MONTH_COVARIATE].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"hour_covariates"</span>: (</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>            quantile_regression_covariates_hat_df[HOUR_COVARIATE].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"counties_index"</span>: (</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>            quantile_regression_covariates_hat_df[COUNTIES_INDEX].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> quantile_regression_covariates_hat_df, quantile_regression_covariates_hat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="6288c858" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>quantile_regression_transformers <span class="op">=</span> {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"latitude_covariates"</span>: Pipeline(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>        steps<span class="op">=</span>[</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>                <span class="st">"spline_transformer"</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>                SplineTransformer(</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>                    include_bias<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>                    extrapolation<span class="op">=</span><span class="st">"periodic"</span>,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>                    n_knots<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"longitude_covariates"</span>: Pipeline(</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>        steps<span class="op">=</span>[</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>                <span class="st">"spline_transformer"</span>,</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>                SplineTransformer(</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>                    include_bias<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>                    extrapolation<span class="op">=</span><span class="st">"periodic"</span>,</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>                    n_knots<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"year_covariates"</span>: Pipeline(</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>        steps<span class="op">=</span>[</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">"ordinal_encoder"</span>,</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>                OrdinalEncoder(</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>                    dtype<span class="op">=</span><span class="st">"int"</span>,</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>                <span class="st">"spline_transformer"</span>,</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>                SplineTransformer(</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>                    include_bias<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"month_covariates"</span>: Pipeline(</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>        steps<span class="op">=</span>[</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>                <span class="st">"spline_transformer"</span>,</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>                SplineTransformer(</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>                    include_bias<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hour_covariates"</span>: Pipeline(</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>        steps<span class="op">=</span>[</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>                <span class="st">"spline_transformer"</span>,</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>                SplineTransformer(</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>                    include_bias<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">"counties_index"</span>: OrdinalEncoder(</span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>        dtype<span class="op">=</span><span class="st">"int"</span>,</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>quantile_regression_covariates <span class="op">=</span> {</span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">"latitude_covariates"</span>: (</span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>        continuous_state_modelling_df[LAT_COVARIATES].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">"longitude_covariates"</span>: (</span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>        continuous_state_modelling_df[LON_COVARIATES].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">"year_covariates"</span>: (</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a>        continuous_state_modelling_df[YEAR_COVARIATES].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>    <span class="st">"month_covariates"</span>: (</span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>        continuous_state_modelling_df[MONTH_COVARIATE].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hour_covariates"</span>: (</span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a>        continuous_state_modelling_df[HOUR_COVARIATE].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a>    <span class="st">"counties_index"</span>: (</span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a>        continuous_state_modelling_df[COUNTIES_INDEX].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a>quantile_regression_target <span class="op">=</span> continuous_state_modelling_df[CONTINUOUS_TARGET].values</span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a>quantile_regression_covariates_hat_df, quantile_regression_covariates_hat <span class="op">=</span> (</span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a>    create_estimation_covariates_quantile_regression(</span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a>        months<span class="op">=</span>[<span class="dv">5</span>],</span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a>        hours<span class="op">=</span>[<span class="dv">17</span>],</span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a>        years<span class="op">=</span>[<span class="dv">2024</span>],</span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a>        geometries_df<span class="op">=</span>geometries_df,</span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a>        edge_size<span class="op">=</span>DEGREES_PRECISION,</span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a>        states<span class="op">=</span>SELECTED_ANALYSIS_STATES,</span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a>    quantile_regression_transformers,</span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a>    quantile_regression_covariates,</span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a>    quantile_regression_covariates_hat,</span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a>    target,</span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a>) <span class="op">=</span> prepare_modelling_data(</span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a>    covariates<span class="op">=</span>quantile_regression_covariates,</span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a>    covariates_hat<span class="op">=</span>quantile_regression_covariates_hat,</span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a>    target<span class="op">=</span>quantile_regression_target,</span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a>    transformers<span class="op">=</span>quantile_regression_transformers,</span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a>quantile_regression_covariates[<span class="st">"latitude_longitude_tensor_covariates"</span>] <span class="op">=</span> (</span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a>    np.vstack(</span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a>        [</span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a>            create_tensor_product_spline(</span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a>                quantile_regression_covariates[<span class="st">"latitude_covariates"</span>][i, :], </span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a>                quantile_regression_covariates[<span class="st">"longitude_covariates"</span>][i, :]).flatten() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(quantile_regression_covariates[<span class="st">"latitude_covariates"</span>].shape[<span class="dv">0</span>]</span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a>quantile_regression_covariates_hat[<span class="st">"latitude_longitude_tensor_covariates"</span>] <span class="op">=</span> (</span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a>    np.vstack(</span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a>        [</span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a>            create_tensor_product_spline(</span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a>                quantile_regression_covariates_hat[<span class="st">"latitude_covariates"</span>][i, :], </span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a>                quantile_regression_covariates_hat[<span class="st">"longitude_covariates"</span>][i, :]).flatten() <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(quantile_regression_covariates_hat[<span class="st">"latitude_covariates"</span>].shape[<span class="dv">0</span>]</span>
<span id="cb28-127"><a href="#cb28-127" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb28-128"><a href="#cb28-128" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb28-129"><a href="#cb28-129" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-130"><a href="#cb28-130" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Partially Pooled Quantile Regression</strong></p>
<p>Before modelling the spatial components directly (which is a rather expensive process) we attempted an approximated solution by varying the intercept of the model for each county in the state. In order to pool information across the entire state and performing outlier regularization we opted for a <a href="https://en.wikipedia.org/wiki/Bayesian_hierarchical_modeling">partially-pooled model</a> (an amazing resource for learning more about this topic is this Michael Betancourt <a href="https://betanalpha.github.io/assets/case_studies/hierarchical_modeling.html">blog post</a>).</p>
<p><span class="math display">\[
\begin{gather}
\color{RedOrange}\sigma_{county} \sim HalfCauchy(\sigma=5) \\
\color{RedOrange}\mu_{county} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\color{RedOrange}\alpha_{county} \sim \mathcal{N}(\mu_{county}, \sigma_{county}) \\
\beta_{hour} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\beta_{month} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\sigma \sim HalfNormal(1)\\
\mu = exp(\alpha_{county} + \beta_{hour}f(hour) + \beta_{month}f(month) + \beta_{year}f(year))\\
\color{RedOrange} y \sim AsymmetricLapace(\mu, \sigma, \tau=.95)
\end{gather}
\]</span></p>
<p>Given the fomrulation above, it is iomportant to remeber that given the exponential link applied to <span class="math inline">\(\mu\)</span> the relationship between covariates is multiplicative rather than additive.</p>
<p>We define the model in numpyro and visualize its graphical model representation</p>
<div id="2bfc8eb5" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>reparam_config <span class="op">=</span> {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha"</span>: LocScaleReparam(<span class="dv">0</span>),</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="at">@numpyro.handlers.reparam</span>(config<span class="op">=</span>reparam_config)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hierarchical_non_spatial_quantile_regression(</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    target: ArrayLike,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    covariates: Dict[<span class="bu">str</span>, ArrayLike],</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    quantile: <span class="bu">float</span>,</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    prior_mu_alpha: Distribution,</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    prior_sigma_alpha: Distribution,</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    prior_scale: Distribution,</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    prior_beta_year: Distribution,</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    prior_beta_month: Distribution,</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    prior_beta_hour: Distribution,</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Quantile regression model with partially pooled intercept"""</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    n_groups <span class="op">=</span> <span class="bu">len</span>(np.unique(covariates[<span class="st">"counties_index"</span>]))</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    counties_index <span class="op">=</span> covariates[<span class="st">"counties_index"</span>].flatten()</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    mu_alpha <span class="op">=</span> numpyro.sample(</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mu_alpha"</span>,</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>        prior_mu_alpha,</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>    sigma_alpha <span class="op">=</span> numpyro.sample(</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sigma_alpha"</span>,</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>        prior_sigma_alpha,</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> numpyro.plate(<span class="st">"counties"</span>, n_groups):</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>        alpha <span class="op">=</span> numpyro.sample(</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">"alpha"</span>,</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>            Normal(mu_alpha, sigma_alpha),</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>    beta_hour <span class="op">=</span> numpyro.sample(</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta_hour"</span>,</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>        prior_beta_hour.expand([covariates[<span class="st">"hour_covariates"</span>].shape[<span class="dv">1</span>]]),</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>    beta_month <span class="op">=</span> numpyro.sample(</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta_month"</span>,</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>        prior_beta_month.expand([covariates[<span class="st">"month_covariates"</span>].shape[<span class="dv">1</span>]]),</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>    beta_year <span class="op">=</span> numpyro.sample(</span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta_year"</span>,</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>        prior_beta_year.expand([covariates[<span class="st">"year_covariates"</span>].shape[<span class="dv">1</span>]]),</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>    hour_component <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"hour_component"</span>,</span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"hour_covariates"</span>], beta_hour),</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>    month_component <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"month_component"</span>,</span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"month_covariates"</span>], beta_month),</span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>    year_component <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"year_component"</span>,</span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"year_covariates"</span>], beta_year),</span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a>    temporal_component <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"temporal_component"</span>,</span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>year_component <span class="op">+</span> month_component <span class="op">+</span> hour_component,</span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a>    spatial_component <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"spatial_component"</span>,</span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>alpha[counties_index],</span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a>    loc <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"loc"</span>, </span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.exp(spatial_component <span class="op">+</span> temporal_component)</span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a>    scale <span class="op">=</span> numpyro.sample(</span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">"scale"</span>,</span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a>        prior_scale,</span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a>    obs <span class="op">=</span> numpyro.sample(</span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a>        <span class="st">"obs"</span>,</span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a>        AsymmetricLaplaceQuantile(loc<span class="op">=</span>loc, scale<span class="op">=</span>scale, quantile<span class="op">=</span>quantile),</span>
<span id="cb29-81"><a href="#cb29-81" aria-hidden="true" tabindex="-1"></a>        obs<span class="op">=</span>target,</span>
<span id="cb29-82"><a href="#cb29-82" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-83"><a href="#cb29-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> target <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb29-84"><a href="#cb29-84" aria-hidden="true" tabindex="-1"></a>        numpyro.deterministic(</span>
<span id="cb29-85"><a href="#cb29-85" aria-hidden="true" tabindex="-1"></a>            <span class="st">"log_likelihood"</span>,</span>
<span id="cb29-86"><a href="#cb29-86" aria-hidden="true" tabindex="-1"></a>            AsymmetricLaplaceQuantile(</span>
<span id="cb29-87"><a href="#cb29-87" aria-hidden="true" tabindex="-1"></a>                loc<span class="op">=</span>loc, </span>
<span id="cb29-88"><a href="#cb29-88" aria-hidden="true" tabindex="-1"></a>                scale<span class="op">=</span>scale, </span>
<span id="cb29-89"><a href="#cb29-89" aria-hidden="true" tabindex="-1"></a>                quantile<span class="op">=</span>quantile,</span>
<span id="cb29-90"><a href="#cb29-90" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb29-91"><a href="#cb29-91" aria-hidden="true" tabindex="-1"></a>            .log_prob(target)</span>
<span id="cb29-92"><a href="#cb29-92" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb29-93"><a href="#cb29-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-94"><a href="#cb29-94" aria-hidden="true" tabindex="-1"></a>hierarchical_non_spatial_model_parameters <span class="op">=</span> [</span>
<span id="cb29-95"><a href="#cb29-95" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mu_alpha"</span>,</span>
<span id="cb29-96"><a href="#cb29-96" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sigma_alpha"</span>,</span>
<span id="cb29-97"><a href="#cb29-97" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_hour"</span>,</span>
<span id="cb29-98"><a href="#cb29-98" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_month"</span>,</span>
<span id="cb29-99"><a href="#cb29-99" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_year"</span>,</span>
<span id="cb29-100"><a href="#cb29-100" aria-hidden="true" tabindex="-1"></a>    <span class="st">"loc"</span>,</span>
<span id="cb29-101"><a href="#cb29-101" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha"</span>,</span>
<span id="cb29-102"><a href="#cb29-102" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hour_component"</span>,</span>
<span id="cb29-103"><a href="#cb29-103" aria-hidden="true" tabindex="-1"></a>    <span class="st">"month_component"</span>,</span>
<span id="cb29-104"><a href="#cb29-104" aria-hidden="true" tabindex="-1"></a>    <span class="st">"year_component"</span>,</span>
<span id="cb29-105"><a href="#cb29-105" aria-hidden="true" tabindex="-1"></a>    <span class="st">"temporal_component"</span>,</span>
<span id="cb29-106"><a href="#cb29-106" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spatial_component"</span>,</span>
<span id="cb29-107"><a href="#cb29-107" aria-hidden="true" tabindex="-1"></a>    <span class="st">"scale"</span>,</span>
<span id="cb29-108"><a href="#cb29-108" aria-hidden="true" tabindex="-1"></a>    <span class="st">"obs"</span>,</span>
<span id="cb29-109"><a href="#cb29-109" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb29-110"><a href="#cb29-110" aria-hidden="true" tabindex="-1"></a>hierarchical_non_spatial_model_kwargs <span class="op">=</span> {</span>
<span id="cb29-111"><a href="#cb29-111" aria-hidden="true" tabindex="-1"></a>    <span class="st">"covariates"</span>: quantile_regression_covariates,</span>
<span id="cb29-112"><a href="#cb29-112" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quantile"</span>: CRITICAL_QUANTILE,</span>
<span id="cb29-113"><a href="#cb29-113" aria-hidden="true" tabindex="-1"></a>    <span class="st">"target"</span>: quantile_regression_target,</span>
<span id="cb29-114"><a href="#cb29-114" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_mu_alpha"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="fl">5.0</span>),</span>
<span id="cb29-115"><a href="#cb29-115" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_sigma_alpha"</span>: HalfCauchy(scale<span class="op">=</span><span class="fl">2.0</span>),</span>
<span id="cb29-116"><a href="#cb29-116" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_year"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb29-117"><a href="#cb29-117" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_month"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb29-118"><a href="#cb29-118" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_hour"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb29-119"><a href="#cb29-119" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_scale"</span>: HalfNormal(scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb29-120"><a href="#cb29-120" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-121"><a href="#cb29-121" aria-hidden="true" tabindex="-1"></a>numpyro.render_model(</span>
<span id="cb29-122"><a href="#cb29-122" aria-hidden="true" tabindex="-1"></a>    hierarchical_non_spatial_quantile_regression,</span>
<span id="cb29-123"><a href="#cb29-123" aria-hidden="true" tabindex="-1"></a>    model_kwargs<span class="op">=</span>hierarchical_non_spatial_model_kwargs,</span>
<span id="cb29-124"><a href="#cb29-124" aria-hidden="true" tabindex="-1"></a>    render_distributions<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb29-125"><a href="#cb29-125" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-24-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Given the size of our data we then proceed at estimating the parameters using <a href="https://en.wikipedia.org/wiki/Variational_Bayesian_methods">variational inference</a> (we recommend this amazing <a href="https://www.youtube.com/watch?v=Moo4-KR5qNg">primer</a> on variational bayes by Tamara Broderick).</p>
<div id="801b5e0a" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>svi_pooled_quantile_regression_parameters, svi_pooled_quantile_regression_guide <span class="op">=</span> (</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    sample_using_svi(</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>        rng_key<span class="op">=</span>RNG_KEY,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>hierarchical_non_spatial_quantile_regression,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>        model_kwargs<span class="op">=</span>hierarchical_non_spatial_model_kwargs,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>        autoguide<span class="op">=</span>AutoMultivariateNormal,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>        guide_kwargs<span class="op">=</span>{},</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>        optimizer_kwargs<span class="op">=</span>{<span class="st">"step_size"</span>: <span class="fl">1e-4</span>, <span class="st">"clip_norm"</span>: <span class="dv">5</span>},</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>        num_steps<span class="op">=</span>NUMBER_ITERATIONS,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>        num_particles<span class="op">=</span>NUMBER_PARTICLES,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>  0%|          | 0/100 [00:00&lt;?, ?it/s]  1%|          | 1/100 [00:00&lt;00:27,  3.56it/s]100%|██████████| 100/100 [00:00&lt;00:00, 323.59it/s, init loss: 15671.9941, avg. loss [96-100]: 16196.0732]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-25-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>An then sampled from the posterior distribution using previously unseen data (i.e.&nbsp;the covariates we have generated)</p>
<div id="5e57fe17" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>posterior_hierarchical_non_spatial_regression_svi <span class="op">=</span> sample_posterior_predictive_svi(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    rng_key<span class="op">=</span>RNG_KEY,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    covariates_hat<span class="op">=</span>quantile_regression_covariates_hat,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    model_kwargs<span class="op">=</span>hierarchical_non_spatial_model_kwargs,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>hierarchical_non_spatial_quantile_regression,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    guide<span class="op">=</span>svi_pooled_quantile_regression_guide,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    svi_result<span class="op">=</span>svi_pooled_quantile_regression_parameters,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    num_samples<span class="op">=</span><span class="dv">2000</span>,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    return_sites<span class="op">=</span>hierarchical_non_spatial_model_parameters,</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This plot shows the estimated intercept values for each county as a crude approxiamtion of a spatial component</p>
<div id="79c7ebb7" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> visualize_geo_regression(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    covariates_hat_df<span class="op">=</span>quantile_regression_covariates_hat_df,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    posterior<span class="op">=</span>posterior_hierarchical_non_spatial_regression_svi,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    parameter<span class="op">=</span><span class="st">"spatial_component"</span>,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    parameter_transformer<span class="op">=</span><span class="kw">lambda</span> x: jnp.exp(x)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>While this other plots show both the seasonal and trend componets coming from the hour, month and year covariates.</p>
<div id="592b7a5c" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> visualize_temporal_components(</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    temporal_components<span class="op">=</span>generate_temporal_components(</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>        posterior<span class="op">=</span>posterior_hierarchical_non_spatial_regression_svi,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>        transformers<span class="op">=</span>quantile_regression_transformers,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>        years<span class="op">=</span>continuous_state_modelling_df[YEAR_COVARIATES].unique(),</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>        parameter_transformer<span class="op">=</span><span class="kw">lambda</span> x: jnp.exp(x)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-28-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Fully Pooled Spatial Quantile Regression</strong></p>
<p>In order to then obtain a finer grain spatial representation we then proceeded at substituting the intercept <span class="math inline">\(\alpha\)</span> from the previous model with a tensor product spline obtained from latitude and longitude. In the case the <span class="math inline">\(Laplace\)</span> prior is applied in order to put a strong regularization component on the tensor product spline.</p>
<p><span class="math display">\[
\begin{gather}
\color{RedOrange}\beta_{spatial} \sim Laplace(\mu=0, \sigma=1) \\
\beta_{hour} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\beta_{month} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\beta_{year} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\sigma \sim HalfNormal(1)\\
\color{RedOrange}\mu = exp(\beta_{spatial}f(spatial) + \beta_{hour}f(hour) + \beta_{month}f(month) + \beta_{year}f(year))\\
\ y \sim AsymmetricLapace(\mu, \sigma, \tau=.95)
\end{gather}
\]</span></p>
<div id="c34b7663" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pooled_quantile_regression(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    target: ArrayLike,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    covariates: Dict[<span class="bu">str</span>, ArrayLike],</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    quantile: <span class="bu">float</span>,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    prior_beta_spatial: Distribution,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    prior_beta_month: Distribution,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    prior_beta_year: Distribution,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    prior_beta_hour: Distribution,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    prior_scale: Distribution,</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Simple quantile regression model"""</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    beta_spatial <span class="op">=</span> numpyro.sample(</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta_spatial"</span>,</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>        prior_beta_spatial.expand([covariates[<span class="st">"latitude_longitude_tensor_covariates"</span>].shape[<span class="dv">1</span>]]),</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    beta_hour <span class="op">=</span> numpyro.sample(</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta_hour"</span>,</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>        prior_beta_hour.expand([covariates[<span class="st">"hour_covariates"</span>].shape[<span class="dv">1</span>]]),</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    beta_month <span class="op">=</span> numpyro.sample(</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta_month"</span>,</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>        prior_beta_month.expand([covariates[<span class="st">"month_covariates"</span>].shape[<span class="dv">1</span>]]),</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    beta_year <span class="op">=</span> numpyro.sample(</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta_year"</span>,</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>        prior_beta_year.expand([covariates[<span class="st">"year_covariates"</span>].shape[<span class="dv">1</span>]]),</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    scale <span class="op">=</span> numpyro.sample(</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"scale"</span>,</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>        prior_scale,</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>    hour_component <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"hour_component"</span>,</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"hour_covariates"</span>], beta_hour),</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>    month_component <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"month_component"</span>,</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"month_covariates"</span>], beta_month),</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>    year_component <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"year_component"</span>,</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"year_covariates"</span>], beta_year),</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>    spatial_component <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"spatial_component"</span>,</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"latitude_longitude_tensor_covariates"</span>], beta_spatial),</span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>    temporal_component <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"temporal_component"</span>,</span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>year_component <span class="op">+</span> month_component <span class="op">+</span> hour_component,</span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>    loc <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"loc"</span>,</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.exp(spatial_component <span class="op">+</span> temporal_component),</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>    obs <span class="op">=</span> numpyro.sample(</span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">"obs"</span>,</span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a>        AsymmetricLaplaceQuantile(loc<span class="op">=</span>loc, scale<span class="op">=</span>scale, quantile<span class="op">=</span>quantile),</span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a>        obs<span class="op">=</span>target,</span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> target <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a>        numpyro.deterministic(</span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a>            <span class="st">"log_likelihood"</span>,</span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a>            AsymmetricLaplaceQuantile(</span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>                loc<span class="op">=</span>loc, </span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a>                scale<span class="op">=</span>scale, </span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a>                quantile<span class="op">=</span>quantile,</span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a>            .log_prob(target)</span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a>pooled_quantile_model_parameters <span class="op">=</span> [</span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_spatial"</span>,</span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_hour"</span>,</span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_month"</span>,</span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_year"</span>,</span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a>    <span class="st">"loc"</span>,</span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spatial_component"</span>,</span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hour_component"</span>,</span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a>    <span class="st">"month_component"</span>,</span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a>    <span class="st">"year_component"</span>,</span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a>    <span class="st">"scale"</span>,</span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">"obs"</span>,</span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a>pooled_quantile_model_kwargs <span class="op">=</span> {</span>
<span id="cb35-86"><a href="#cb35-86" aria-hidden="true" tabindex="-1"></a>    <span class="st">"covariates"</span>: quantile_regression_covariates,</span>
<span id="cb35-87"><a href="#cb35-87" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quantile"</span>: CRITICAL_QUANTILE,</span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a>    <span class="st">"target"</span>: quantile_regression_target,</span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_spatial"</span>: Laplace(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="dv">5</span>),</span>
<span id="cb35-90"><a href="#cb35-90" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_year"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb35-91"><a href="#cb35-91" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_month"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb35-92"><a href="#cb35-92" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_hour"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb35-93"><a href="#cb35-93" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_scale"</span>: HalfNormal(scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb35-94"><a href="#cb35-94" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-95"><a href="#cb35-95" aria-hidden="true" tabindex="-1"></a>numpyro.render_model(</span>
<span id="cb35-96"><a href="#cb35-96" aria-hidden="true" tabindex="-1"></a>    pooled_quantile_regression,</span>
<span id="cb35-97"><a href="#cb35-97" aria-hidden="true" tabindex="-1"></a>    model_kwargs<span class="op">=</span>pooled_quantile_model_kwargs,</span>
<span id="cb35-98"><a href="#cb35-98" aria-hidden="true" tabindex="-1"></a>    render_distributions<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb35-99"><a href="#cb35-99" aria-hidden="true" tabindex="-1"></a>    render_params<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb35-100"><a href="#cb35-100" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-29-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Again we proceeded at estimating parameters using variational inference</p>
<div id="55db7a01" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>svi_pooled_quantile_regression_parameters, svi_pooled_quantile_regression_guide <span class="op">=</span> (</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    sample_using_svi(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>        rng_key<span class="op">=</span>RNG_KEY,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>pooled_quantile_regression,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>        model_kwargs<span class="op">=</span>pooled_quantile_model_kwargs,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>        autoguide<span class="op">=</span>AutoMultivariateNormal,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>        guide_kwargs<span class="op">=</span>{},</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>        optimizer_kwargs<span class="op">=</span>{<span class="st">"step_size"</span>: <span class="fl">1e-4</span>, <span class="st">"clip_norm"</span>: <span class="dv">5</span>},</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>        num_steps<span class="op">=</span>NUMBER_ITERATIONS,</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>        num_particles<span class="op">=</span>NUMBER_PARTICLES,</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>  0%|          | 0/100 [00:00&lt;?, ?it/s]  1%|          | 1/100 [00:00&lt;00:27,  3.67it/s] 86%|████████▌ | 86/100 [00:00&lt;00:00, 294.07it/s, init loss: 13984.2441, avg. loss [81-85]: 14533.4922]100%|██████████| 100/100 [00:00&lt;00:00, 256.42it/s, init loss: 13984.2441, avg. loss [96-100]: 14279.2705]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-30-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>And we then obtained the posterior samples</p>
<div id="c937c41f" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>posterior_pooled_quantile_regression_svi <span class="op">=</span> sample_posterior_predictive_svi(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    rng_key<span class="op">=</span>RNG_KEY,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    covariates_hat<span class="op">=</span>quantile_regression_covariates_hat,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    model_kwargs<span class="op">=</span>pooled_quantile_model_kwargs,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>pooled_quantile_regression,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    guide<span class="op">=</span>svi_pooled_quantile_regression_guide,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    svi_result<span class="op">=</span>svi_pooled_quantile_regression_parameters,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    num_samples<span class="op">=</span><span class="dv">2000</span>,</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    return_sites<span class="op">=</span>pooled_quantile_model_parameters,</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see how the spatial component now varies smoothly across the entire state</p>
<div id="3b1f1c87" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> visualize_geo_regression(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    covariates_hat_df<span class="op">=</span>quantile_regression_covariates_hat_df,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    posterior<span class="op">=</span>posterior_pooled_quantile_regression_svi,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    parameter<span class="op">=</span><span class="st">"spatial_component"</span>,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    parameter_transformer<span class="op">=</span><span class="kw">lambda</span> x: jnp.exp(x)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-32-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We also obtained the same temporal components as before</p>
<div id="b9bc9e28" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> visualize_temporal_components(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    temporal_components<span class="op">=</span>generate_temporal_components(</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>        posterior<span class="op">=</span>posterior_pooled_quantile_regression_svi,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>        transformers<span class="op">=</span>quantile_regression_transformers,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>        years<span class="op">=</span>continuous_state_modelling_df[YEAR_COVARIATES].unique(),</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>        parameter_transformer<span class="op">=</span><span class="kw">lambda</span> x: jnp.exp(x)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-33-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Partially Pooled Spatial Quantile Regression</strong></p>
<p>As a final iteration of the quantile regression model we wanted to combine the partially pooled model with the fully pooled spatial model by allowing the spatial component to vary within each county. Although rather expensive (the model needs to estimate <code>number_of_counties * number_spline_features</code> parameters) this approach allows to have spatial effects that are localized to each county. This is an attempt to model the geographical peculiarities that each county might have.</p>
<p><span class="math display">\[
\begin{gather}
\color{RedOrange}\sigma_{county} \sim HalfCauchy(\sigma=5) \\
\color{RedOrange}\mu_{county} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\color{RedOrange}\beta_{spatial,county} \sim Laplace(\mu_{county}, \sigma_{county}) \\
\beta_{hour} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\beta_{month} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\beta_{year} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\sigma \sim HalfNormal(1)\\
\color{RedOrange}\mu = exp(\beta_{spatial,county}f(spatial) + \beta_{hour}f(hour) + \beta_{month}f(month) + \beta_{year}f(year))\\
\ y \sim AsymmetricLapace(\mu, \sigma, \tau=.95)
\end{gather}
\]</span></p>
<p>The numpyro model here make use of a double plate notation in order to specify a different <code>beta_spatial</code> for each county</p>
<div id="8eb0d198" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>reparam_config <span class="op">=</span> {</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_spatial"</span>: LocScaleReparam(<span class="dv">0</span>),</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="at">@numpyro.handlers.reparam</span>(config<span class="op">=</span>reparam_config)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hierarchical_quantile_regression(</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    target: ArrayLike,</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    covariates: Dict[<span class="bu">str</span>, ArrayLike],</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    quantile: <span class="bu">float</span>,</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    prior_mu_beta_spatial: Distribution,</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    prior_sigma_beta_spatial: Distribution,</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    prior_scale: Distribution,</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    prior_beta_year: Distribution,</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    prior_beta_month: Distribution,</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    prior_beta_hour: Distribution,</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Quantile regression model with partially pooled intercept"""</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    n_groups <span class="op">=</span> <span class="bu">len</span>(np.unique(covariates[<span class="st">"counties_index"</span>]))</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    n_spatial_covariates <span class="op">=</span> covariates[<span class="st">"latitude_longitude_tensor_covariates"</span>].shape[<span class="dv">1</span>]</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    counties_index <span class="op">=</span> covariates[<span class="st">"counties_index"</span>].flatten()</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    mu_beta_spatial <span class="op">=</span> numpyro.sample(</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mu_beta_spatial"</span>,</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>        prior_mu_beta_spatial,</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    sigma_beta_spatial <span class="op">=</span> numpyro.sample(</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sigma_beta_spatial"</span>,</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>        prior_sigma_beta_spatial,</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> numpyro.plate(<span class="st">"counties"</span>, n_groups, dim<span class="op">=-</span><span class="dv">2</span>):</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> numpyro.plate(<span class="st">"spline_coefficients"</span>, n_spatial_covariates, dim<span class="op">=-</span><span class="dv">1</span>):</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>            beta_spatial <span class="op">=</span> numpyro.sample(</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>                <span class="st">"beta_spatial"</span>,</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>                Laplace(mu_beta_spatial, sigma_beta_spatial),</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>    beta_hour <span class="op">=</span> numpyro.sample(</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta_hour"</span>,</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>        prior_beta_hour.expand([covariates[<span class="st">"hour_covariates"</span>].shape[<span class="dv">1</span>]]),</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>    beta_month <span class="op">=</span> numpyro.sample(</span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta_month"</span>,</span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>        prior_beta_month.expand([covariates[<span class="st">"month_covariates"</span>].shape[<span class="dv">1</span>]]),</span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a>    beta_year <span class="op">=</span> numpyro.sample(</span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta_year"</span>,</span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>        prior_beta_year.expand([covariates[<span class="st">"year_covariates"</span>].shape[<span class="dv">1</span>]]),</span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a>    spatial_component <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"spatial_component"</span>,</span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.<span class="bu">sum</span>(</span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a>            beta_spatial[counties_index, :] <span class="op">*</span> covariates[<span class="st">"latitude_longitude_tensor_covariates"</span>],</span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>            axis<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>    hour_component <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"hour_component"</span>,</span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"hour_covariates"</span>], beta_hour),</span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a>    month_component <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"month_component"</span>,</span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"month_covariates"</span>], beta_month),</span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true" tabindex="-1"></a>    year_component <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb41-66"><a href="#cb41-66" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"year_component"</span>,</span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"year_covariates"</span>], beta_year),</span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a>    temporal_component <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"temporal_component"</span>,</span>
<span id="cb41-71"><a href="#cb41-71" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>year_component <span class="op">+</span> month_component <span class="op">+</span> hour_component,</span>
<span id="cb41-72"><a href="#cb41-72" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-73"><a href="#cb41-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-74"><a href="#cb41-74" aria-hidden="true" tabindex="-1"></a>    loc <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb41-75"><a href="#cb41-75" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"loc"</span>,</span>
<span id="cb41-76"><a href="#cb41-76" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.exp(spatial_component <span class="op">+</span> temporal_component),</span>
<span id="cb41-77"><a href="#cb41-77" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-78"><a href="#cb41-78" aria-hidden="true" tabindex="-1"></a>    scale <span class="op">=</span> numpyro.sample(</span>
<span id="cb41-79"><a href="#cb41-79" aria-hidden="true" tabindex="-1"></a>        <span class="st">"scale"</span>,</span>
<span id="cb41-80"><a href="#cb41-80" aria-hidden="true" tabindex="-1"></a>        prior_scale,</span>
<span id="cb41-81"><a href="#cb41-81" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-82"><a href="#cb41-82" aria-hidden="true" tabindex="-1"></a>    obs <span class="op">=</span> numpyro.sample(</span>
<span id="cb41-83"><a href="#cb41-83" aria-hidden="true" tabindex="-1"></a>        <span class="st">"obs"</span>,</span>
<span id="cb41-84"><a href="#cb41-84" aria-hidden="true" tabindex="-1"></a>        AsymmetricLaplaceQuantile(loc<span class="op">=</span>loc, scale<span class="op">=</span>scale, quantile<span class="op">=</span>quantile),</span>
<span id="cb41-85"><a href="#cb41-85" aria-hidden="true" tabindex="-1"></a>        obs<span class="op">=</span>target,</span>
<span id="cb41-86"><a href="#cb41-86" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-87"><a href="#cb41-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> target <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb41-88"><a href="#cb41-88" aria-hidden="true" tabindex="-1"></a>        numpyro.deterministic(</span>
<span id="cb41-89"><a href="#cb41-89" aria-hidden="true" tabindex="-1"></a>            <span class="st">"log_likelihood"</span>,</span>
<span id="cb41-90"><a href="#cb41-90" aria-hidden="true" tabindex="-1"></a>            AsymmetricLaplaceQuantile(</span>
<span id="cb41-91"><a href="#cb41-91" aria-hidden="true" tabindex="-1"></a>                loc<span class="op">=</span>loc, </span>
<span id="cb41-92"><a href="#cb41-92" aria-hidden="true" tabindex="-1"></a>                scale<span class="op">=</span>scale, </span>
<span id="cb41-93"><a href="#cb41-93" aria-hidden="true" tabindex="-1"></a>                quantile<span class="op">=</span>quantile,</span>
<span id="cb41-94"><a href="#cb41-94" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb41-95"><a href="#cb41-95" aria-hidden="true" tabindex="-1"></a>            .log_prob(target)</span>
<span id="cb41-96"><a href="#cb41-96" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb41-97"><a href="#cb41-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-98"><a href="#cb41-98" aria-hidden="true" tabindex="-1"></a>hierarchical_quantile_model_kwargs <span class="op">=</span> {</span>
<span id="cb41-99"><a href="#cb41-99" aria-hidden="true" tabindex="-1"></a>    <span class="st">"covariates"</span>: quantile_regression_covariates,</span>
<span id="cb41-100"><a href="#cb41-100" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quantile"</span>: CRITICAL_QUANTILE,</span>
<span id="cb41-101"><a href="#cb41-101" aria-hidden="true" tabindex="-1"></a>    <span class="st">"target"</span>: quantile_regression_target,</span>
<span id="cb41-102"><a href="#cb41-102" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_mu_beta_spatial"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="fl">5.0</span>),</span>
<span id="cb41-103"><a href="#cb41-103" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_sigma_beta_spatial"</span>: HalfCauchy(scale<span class="op">=</span><span class="fl">2.0</span>),</span>
<span id="cb41-104"><a href="#cb41-104" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_year"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb41-105"><a href="#cb41-105" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_month"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb41-106"><a href="#cb41-106" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_hour"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb41-107"><a href="#cb41-107" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_scale"</span>: HalfNormal(scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb41-108"><a href="#cb41-108" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-109"><a href="#cb41-109" aria-hidden="true" tabindex="-1"></a>hierarchical_quantile_model_parameters <span class="op">=</span> [</span>
<span id="cb41-110"><a href="#cb41-110" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mu_beta_latitude"</span>,</span>
<span id="cb41-111"><a href="#cb41-111" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sigma_beta_latitude"</span>,</span>
<span id="cb41-112"><a href="#cb41-112" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mu_beta_longitude"</span>,</span>
<span id="cb41-113"><a href="#cb41-113" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sigma_beta_longitude"</span>,</span>
<span id="cb41-114"><a href="#cb41-114" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_hour"</span>,</span>
<span id="cb41-115"><a href="#cb41-115" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_month"</span>,</span>
<span id="cb41-116"><a href="#cb41-116" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_year"</span>,</span>
<span id="cb41-117"><a href="#cb41-117" aria-hidden="true" tabindex="-1"></a>    <span class="st">"loc"</span>,</span>
<span id="cb41-118"><a href="#cb41-118" aria-hidden="true" tabindex="-1"></a>    <span class="st">"latitude_component"</span>,</span>
<span id="cb41-119"><a href="#cb41-119" aria-hidden="true" tabindex="-1"></a>    <span class="st">"longitude_component"</span>,</span>
<span id="cb41-120"><a href="#cb41-120" aria-hidden="true" tabindex="-1"></a>    <span class="st">"temporal_component"</span>,</span>
<span id="cb41-121"><a href="#cb41-121" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spatial_component"</span>,</span>
<span id="cb41-122"><a href="#cb41-122" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hour_component"</span>,</span>
<span id="cb41-123"><a href="#cb41-123" aria-hidden="true" tabindex="-1"></a>    <span class="st">"month_component"</span>,</span>
<span id="cb41-124"><a href="#cb41-124" aria-hidden="true" tabindex="-1"></a>    <span class="st">"year_component"</span>,</span>
<span id="cb41-125"><a href="#cb41-125" aria-hidden="true" tabindex="-1"></a>    <span class="st">"scale"</span>,</span>
<span id="cb41-126"><a href="#cb41-126" aria-hidden="true" tabindex="-1"></a>    <span class="st">"obs"</span>,</span>
<span id="cb41-127"><a href="#cb41-127" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb41-128"><a href="#cb41-128" aria-hidden="true" tabindex="-1"></a>numpyro.render_model(</span>
<span id="cb41-129"><a href="#cb41-129" aria-hidden="true" tabindex="-1"></a>    hierarchical_quantile_regression,</span>
<span id="cb41-130"><a href="#cb41-130" aria-hidden="true" tabindex="-1"></a>    model_kwargs<span class="op">=</span>hierarchical_quantile_model_kwargs,</span>
<span id="cb41-131"><a href="#cb41-131" aria-hidden="true" tabindex="-1"></a>    render_distributions<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb41-132"><a href="#cb41-132" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-34-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="1bfbba4a" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    svi_hierarchical_quantile_regression_parameters,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    svi_hierarchical_quantile_regression_guide,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">=</span> sample_using_svi(</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    rng_key<span class="op">=</span>RNG_KEY,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>hierarchical_quantile_regression,</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    model_kwargs<span class="op">=</span>hierarchical_quantile_model_kwargs,</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    autoguide<span class="op">=</span>AutoLowRankMultivariateNormal,</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    guide_kwargs<span class="op">=</span>{},</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    optimizer_kwargs<span class="op">=</span>{<span class="st">"step_size"</span>: <span class="fl">1e-4</span>, <span class="st">"clip_norm"</span>: <span class="dv">5</span>},</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    num_steps<span class="op">=</span>NUMBER_ITERATIONS,</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    num_particles<span class="op">=</span>NUMBER_PARTICLES,</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>  0%|          | 0/100 [00:00&lt;?, ?it/s]  1%|          | 1/100 [00:00&lt;00:40,  2.42it/s]  7%|▋         | 7/100 [00:00&lt;00:05, 17.21it/s, init loss: 71826.6406, avg. loss [1-5]: 71922.1875] 14%|█▍        | 14/100 [00:00&lt;00:02, 30.19it/s, init loss: 71826.6406, avg. loss [6-10]: 71910.7891] 21%|██        | 21/100 [00:00&lt;00:02, 39.23it/s, init loss: 71826.6406, avg. loss [16-20]: 71963.5156] 28%|██▊       | 28/100 [00:00&lt;00:01, 45.85it/s, init loss: 71826.6406, avg. loss [21-25]: 71821.6719] 35%|███▌      | 35/100 [00:00&lt;00:01, 50.27it/s, init loss: 71826.6406, avg. loss [31-35]: 71905.7266] 42%|████▏     | 42/100 [00:01&lt;00:01, 53.57it/s, init loss: 71826.6406, avg. loss [36-40]: 71917.4219] 49%|████▉     | 49/100 [00:01&lt;00:00, 55.89it/s, init loss: 71826.6406, avg. loss [41-45]: 71900.5156] 56%|█████▌    | 56/100 [00:01&lt;00:00, 57.43it/s, init loss: 71826.6406, avg. loss [51-55]: 71542.4844] 63%|██████▎   | 63/100 [00:01&lt;00:00, 58.71it/s, init loss: 71826.6406, avg. loss [56-60]: 71994.7031] 70%|███████   | 70/100 [00:01&lt;00:00, 59.60it/s, init loss: 71826.6406, avg. loss [66-70]: 71393.4297] 77%|███████▋  | 77/100 [00:01&lt;00:00, 60.15it/s, init loss: 71826.6406, avg. loss [71-75]: 71649.0703] 84%|████████▍ | 84/100 [00:01&lt;00:00, 60.69it/s, init loss: 71826.6406, avg. loss [76-80]: 71787.6797] 91%|█████████ | 91/100 [00:01&lt;00:00, 60.97it/s, init loss: 71826.6406, avg. loss [86-90]: 71647.8906] 98%|█████████▊| 98/100 [00:01&lt;00:00, 61.16it/s, init loss: 71826.6406, avg. loss [91-95]: 71602.4609]100%|██████████| 100/100 [00:02&lt;00:00, 49.27it/s, init loss: 71826.6406, avg. loss [96-100]: 71488.1406]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-35-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="2f1140f9" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>posterior_hierarchical_quantile_regression_svi <span class="op">=</span> sample_posterior_predictive_svi(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    rng_key<span class="op">=</span>RNG_KEY,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    covariates_hat<span class="op">=</span>quantile_regression_covariates_hat,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    model_kwargs<span class="op">=</span>hierarchical_quantile_model_kwargs,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>hierarchical_quantile_regression,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    guide<span class="op">=</span>svi_hierarchical_quantile_regression_guide,</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    svi_result<span class="op">=</span>svi_hierarchical_quantile_regression_parameters,</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    num_samples<span class="op">=</span><span class="dv">2000</span>,</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    return_sites<span class="op">=</span>hierarchical_quantile_model_parameters,</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As we can see, the spatial component is now much more heterogenous across counties. Although this is the effect we wanted to achieve, some of the sharp variation at counties’ edges do not look very natural. This is a desirable effect when environmental conditions justify this behaviour (e.g., the presence of mountains or terrain depressions) but it might also be due to the fact that we did not put any constraint forcing coninuity between contiguous boundaries.</p>
<div id="bf16b0fa" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>visualize_geo_regression(</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    covariates_hat_df<span class="op">=</span>quantile_regression_covariates_hat_df,</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    posterior<span class="op">=</span>posterior_hierarchical_quantile_regression_svi,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    parameter<span class="op">=</span><span class="st">"spatial_component"</span>,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    parameter_transformer<span class="op">=</span><span class="kw">lambda</span> x: jnp.exp(x),</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-37-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="4d7c2650" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> visualize_temporal_components(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    temporal_components<span class="op">=</span>generate_temporal_components(</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>        posterior<span class="op">=</span>posterior_pooled_quantile_regression_svi,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>        transformers<span class="op">=</span>quantile_regression_transformers,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>        years<span class="op">=</span>continuous_state_modelling_df[YEAR_COVARIATES].unique(),</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>        parameter_transformer<span class="op">=</span><span class="kw">lambda</span> x: jnp.exp(x),</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-38-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="estimating-the-likelyhood-of-hail-events-using-zero-inflated-negative-binomial-regression" class="level3" data-number="1.5.2">
<h3 data-number="1.5.2" class="anchored" data-anchor-id="estimating-the-likelyhood-of-hail-events-using-zero-inflated-negative-binomial-regression"><span class="header-section-number">1.5.2</span> Estimating the Likelyhood of Hail Events Using Zero-Inflated Negative Binomial Regression</h3>
<div id="3dcefcb3" class="cell" data-execution_count="39">
<details class="code-fold">
<summary>Show supplementary code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_estimation_covariates_zero_inflated_regression(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    quantile_regression_covariates_hat_df: pd.DataFrame,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    geometries_df: gpd.GeoDataFrame,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[gpd.GeoDataFrame, Dict[<span class="bu">str</span>, ArrayLike]]:</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create the covariates for estimation"""</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    zero_inflated_regression_covariates_df_hat <span class="op">=</span> quantile_regression_covariates_hat_df[</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>        [YEAR_COVARIATES, MONTH_COVARIATE, HOUR_COVARIATE, COUNTIES_INDEX, STATE_INDEX]</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    ].drop_duplicates()</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    zero_inflated_regression_covariates_df_hat <span class="op">=</span> gpd.GeoDataFrame(</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>        pd.merge(</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>            zero_inflated_regression_covariates_df_hat,</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>            geometries_df[[COUNTIES_INDEX, STATE_INDEX, <span class="st">"geometry"</span>]],</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>            how<span class="op">=</span><span class="st">"inner"</span>,</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>            on<span class="op">=</span>[COUNTIES_INDEX, STATE_INDEX],</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    zero_inflated_regression_covariates_hat <span class="op">=</span> {</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"year_covariates"</span>: (</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>            zero_inflated_regression_covariates_df_hat[YEAR_COVARIATES].values.reshape(</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>                <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"month_covariates"</span>: (</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>            zero_inflated_regression_covariates_df_hat[MONTH_COVARIATE].values.reshape(</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>                <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"hour_covariates"</span>: (</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>            zero_inflated_regression_covariates_df_hat[HOUR_COVARIATE].values.reshape(</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>                <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span></span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"counties_index"</span>: (</span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>            zero_inflated_regression_covariates_df_hat[COUNTIES_INDEX].values.reshape(</span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>                <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a>        zero_inflated_regression_covariates_df_hat,</span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a>        zero_inflated_regression_covariates_hat,</span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a>zero_inflated_regression_transformers <span class="op">=</span> {</span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"year_covariates"</span>: Pipeline(</span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a>        steps<span class="op">=</span>[</span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a>                <span class="st">"ordinal_encoder"</span>,</span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a>                OrdinalEncoder(</span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a>                    dtype<span class="op">=</span><span class="st">"int"</span>,</span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb47-52"><a href="#cb47-52" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb47-53"><a href="#cb47-53" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb47-54"><a href="#cb47-54" aria-hidden="true" tabindex="-1"></a>                <span class="st">"spline_transformer"</span>,</span>
<span id="cb47-55"><a href="#cb47-55" aria-hidden="true" tabindex="-1"></a>                SplineTransformer(</span>
<span id="cb47-56"><a href="#cb47-56" aria-hidden="true" tabindex="-1"></a>                    include_bias<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb47-57"><a href="#cb47-57" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb47-58"><a href="#cb47-58" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb47-59"><a href="#cb47-59" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb47-60"><a href="#cb47-60" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb47-61"><a href="#cb47-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">"month_covariates"</span>: Pipeline(</span>
<span id="cb47-62"><a href="#cb47-62" aria-hidden="true" tabindex="-1"></a>        steps<span class="op">=</span>[</span>
<span id="cb47-63"><a href="#cb47-63" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb47-64"><a href="#cb47-64" aria-hidden="true" tabindex="-1"></a>                <span class="st">"spline_transformer"</span>,</span>
<span id="cb47-65"><a href="#cb47-65" aria-hidden="true" tabindex="-1"></a>                SplineTransformer(</span>
<span id="cb47-66"><a href="#cb47-66" aria-hidden="true" tabindex="-1"></a>                    include_bias<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb47-67"><a href="#cb47-67" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb47-68"><a href="#cb47-68" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb47-69"><a href="#cb47-69" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb47-70"><a href="#cb47-70" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb47-71"><a href="#cb47-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hour_covariates"</span>: Pipeline(</span>
<span id="cb47-72"><a href="#cb47-72" aria-hidden="true" tabindex="-1"></a>        steps<span class="op">=</span>[</span>
<span id="cb47-73"><a href="#cb47-73" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb47-74"><a href="#cb47-74" aria-hidden="true" tabindex="-1"></a>                <span class="st">"spline_transformer"</span>,</span>
<span id="cb47-75"><a href="#cb47-75" aria-hidden="true" tabindex="-1"></a>                SplineTransformer(</span>
<span id="cb47-76"><a href="#cb47-76" aria-hidden="true" tabindex="-1"></a>                    include_bias<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb47-77"><a href="#cb47-77" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb47-78"><a href="#cb47-78" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb47-79"><a href="#cb47-79" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb47-80"><a href="#cb47-80" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb47-81"><a href="#cb47-81" aria-hidden="true" tabindex="-1"></a>    <span class="st">"counties_index"</span>: OrdinalEncoder(</span>
<span id="cb47-82"><a href="#cb47-82" aria-hidden="true" tabindex="-1"></a>        dtype<span class="op">=</span><span class="st">"int"</span>,</span>
<span id="cb47-83"><a href="#cb47-83" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb47-84"><a href="#cb47-84" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-85"><a href="#cb47-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-86"><a href="#cb47-86" aria-hidden="true" tabindex="-1"></a>zero_inflated_regression_covariates <span class="op">=</span> {</span>
<span id="cb47-87"><a href="#cb47-87" aria-hidden="true" tabindex="-1"></a>    <span class="st">"year_covariates"</span>: (</span>
<span id="cb47-88"><a href="#cb47-88" aria-hidden="true" tabindex="-1"></a>        count_state_modelling_df[YEAR_COVARIATES].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb47-89"><a href="#cb47-89" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb47-90"><a href="#cb47-90" aria-hidden="true" tabindex="-1"></a>    <span class="st">"month_covariates"</span>: (</span>
<span id="cb47-91"><a href="#cb47-91" aria-hidden="true" tabindex="-1"></a>        count_state_modelling_df[MONTH_COVARIATE].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb47-92"><a href="#cb47-92" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb47-93"><a href="#cb47-93" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hour_covariates"</span>: (count_state_modelling_df[HOUR_COVARIATE].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)),</span>
<span id="cb47-94"><a href="#cb47-94" aria-hidden="true" tabindex="-1"></a>    <span class="st">"counties_index"</span>: (count_state_modelling_df[COUNTIES_INDEX].values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)),</span>
<span id="cb47-95"><a href="#cb47-95" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-96"><a href="#cb47-96" aria-hidden="true" tabindex="-1"></a>zero_inflated_regression_covariates_hat_df, zero_inflated_regression_covariates_hat <span class="op">=</span> (</span>
<span id="cb47-97"><a href="#cb47-97" aria-hidden="true" tabindex="-1"></a>    create_estimation_covariates_zero_inflated_regression(</span>
<span id="cb47-98"><a href="#cb47-98" aria-hidden="true" tabindex="-1"></a>        quantile_regression_covariates_hat_df<span class="op">=</span>quantile_regression_covariates_hat_df,</span>
<span id="cb47-99"><a href="#cb47-99" aria-hidden="true" tabindex="-1"></a>        geometries_df<span class="op">=</span>geometries_df,</span>
<span id="cb47-100"><a href="#cb47-100" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-101"><a href="#cb47-101" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-102"><a href="#cb47-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-103"><a href="#cb47-103" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb47-104"><a href="#cb47-104" aria-hidden="true" tabindex="-1"></a>    zero_inflated_regression_covariates,</span>
<span id="cb47-105"><a href="#cb47-105" aria-hidden="true" tabindex="-1"></a>    zero_inflated_regression_transformers,</span>
<span id="cb47-106"><a href="#cb47-106" aria-hidden="true" tabindex="-1"></a>) <span class="op">=</span> transform_fitting_covariates(</span>
<span id="cb47-107"><a href="#cb47-107" aria-hidden="true" tabindex="-1"></a>    covariates<span class="op">=</span>zero_inflated_regression_covariates,</span>
<span id="cb47-108"><a href="#cb47-108" aria-hidden="true" tabindex="-1"></a>    transformers<span class="op">=</span>zero_inflated_regression_transformers,</span>
<span id="cb47-109"><a href="#cb47-109" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-110"><a href="#cb47-110" aria-hidden="true" tabindex="-1"></a>zero_inflated_regression_covariates_hat <span class="op">=</span> transform_estimation_covariates(</span>
<span id="cb47-111"><a href="#cb47-111" aria-hidden="true" tabindex="-1"></a>    covariates<span class="op">=</span>zero_inflated_regression_covariates_hat,</span>
<span id="cb47-112"><a href="#cb47-112" aria-hidden="true" tabindex="-1"></a>    transformers<span class="op">=</span>zero_inflated_regression_transformers,</span>
<span id="cb47-113"><a href="#cb47-113" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-114"><a href="#cb47-114" aria-hidden="true" tabindex="-1"></a>zero_inflated_regression_target <span class="op">=</span> count_state_modelling_df[COUNT_TARGET].values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>Fully Pooled</strong></p>
<p>$$ <span class="math display">\[\begin{gather}
\color{RedOrange}\alpha_{Gate} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\color{NavyBlue}\alpha_{Mean} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\\
\color{RedOrange}\beta_{GateHour} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\color{RedOrange}\beta_{GateMonth} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\color{RedOrange}\beta_{GateYear} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\color{NavyBlue}\beta_{MeanHour} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\color{NavyBlue}\beta_{MeanMonth} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\color{NavyBlue}\beta_{MeanYear} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\\
\color{RedOrange}p = expit(\alpha_{Gate} + \beta_{GateHour}f(hour) + \beta_{GateMonth}f(month) + \beta_{GateYear}f(year))\\
\color{NavyBlue}\mu = exp(\alpha_{Mean} + \beta_{MeanHour}f(hour) + \beta_{MeanMonth}f(month) + \beta_{GateYear}f(year))\\
\\
\lambda \sim InverseGamma(0.3, 0.4)\\

\ y \sim ZeroInflatedNegativeBinomial(p, \mu, \lambda)
\end{gather}\]</span> $$</p>
<div id="2f77bd5d" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jax.scipy.special <span class="im">import</span> expit</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jax <span class="im">import</span> numpy <span class="im">as</span> jnp</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpyro.distributions <span class="im">import</span> (</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    NegativeBinomial2,</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    InverseGamma,</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    ZeroInflatedDistribution,</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pooled_zero_inflated_negative_binomial_regression(</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    target: ArrayLike,</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    covariates: Dict[<span class="bu">str</span>, ArrayLike],</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    prior_rate: Distribution,</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    prior_alpha_gate: Distribution,</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    prior_beta_year_gate: Distribution,</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>    prior_beta_month_gate: Distribution,</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>    prior_beta_hour_gate: Distribution,</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>    prior_alpha_mean: Distribution,</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>    prior_beta_year_mean: Distribution,</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>    prior_beta_month_mean: Distribution,</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>    prior_beta_hour_mean: Distribution,</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Simple zero-inflated negative binomial regression model"""</span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>    alpha_gate <span class="op">=</span> numpyro.sample(</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"alpha_gate"</span>,</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>        prior_alpha_gate,</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>    alpha_mean <span class="op">=</span> numpyro.sample(</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"alpha_mean"</span>,</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>        prior_alpha_mean,</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> numpyro.plate(</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"year_spline_coefficients"</span>, size<span class="op">=</span>covariates[<span class="st">"year_covariates"</span>].shape[<span class="dv">1</span>]</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>        beta_year_gate <span class="op">=</span> numpyro.sample(</span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_year_gate"</span>,</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>            prior_beta_year_gate,</span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>        beta_year_mean <span class="op">=</span> numpyro.sample(</span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_year_mean"</span>,</span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>            prior_beta_year_mean,</span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> numpyro.plate(</span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"hour_spline_coefficients"</span>, size<span class="op">=</span>covariates[<span class="st">"hour_covariates"</span>].shape[<span class="dv">1</span>]</span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a>        beta_hour_gate <span class="op">=</span> numpyro.sample(</span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_hour_gate"</span>,</span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a>            prior_beta_hour_gate,</span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a>        beta_hour_mean <span class="op">=</span> numpyro.sample(</span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_hour_mean"</span>,</span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a>            prior_beta_hour_mean,</span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> numpyro.plate(</span>
<span id="cb48-59"><a href="#cb48-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">"month_spline_coefficients"</span>, size<span class="op">=</span>covariates[<span class="st">"month_covariates"</span>].shape[<span class="dv">1</span>]</span>
<span id="cb48-60"><a href="#cb48-60" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb48-61"><a href="#cb48-61" aria-hidden="true" tabindex="-1"></a>        beta_month_gate <span class="op">=</span> numpyro.sample(</span>
<span id="cb48-62"><a href="#cb48-62" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_month_gate"</span>,</span>
<span id="cb48-63"><a href="#cb48-63" aria-hidden="true" tabindex="-1"></a>            prior_beta_month_gate,</span>
<span id="cb48-64"><a href="#cb48-64" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb48-65"><a href="#cb48-65" aria-hidden="true" tabindex="-1"></a>        beta_month_mean <span class="op">=</span> numpyro.sample(</span>
<span id="cb48-66"><a href="#cb48-66" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_month_mean"</span>,</span>
<span id="cb48-67"><a href="#cb48-67" aria-hidden="true" tabindex="-1"></a>            prior_beta_month_mean,</span>
<span id="cb48-68"><a href="#cb48-68" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb48-69"><a href="#cb48-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-70"><a href="#cb48-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Year component</span></span>
<span id="cb48-71"><a href="#cb48-71" aria-hidden="true" tabindex="-1"></a>    year_component_gate <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb48-72"><a href="#cb48-72" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"year_component_gate"</span>,</span>
<span id="cb48-73"><a href="#cb48-73" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"year_covariates"</span>], beta_year_gate),</span>
<span id="cb48-74"><a href="#cb48-74" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-75"><a href="#cb48-75" aria-hidden="true" tabindex="-1"></a>    year_component_mean <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb48-76"><a href="#cb48-76" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"year_component_mean"</span>,</span>
<span id="cb48-77"><a href="#cb48-77" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"year_covariates"</span>], beta_year_mean),</span>
<span id="cb48-78"><a href="#cb48-78" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-79"><a href="#cb48-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Month component</span></span>
<span id="cb48-80"><a href="#cb48-80" aria-hidden="true" tabindex="-1"></a>    month_component_gate <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb48-81"><a href="#cb48-81" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"month_component_gate"</span>,</span>
<span id="cb48-82"><a href="#cb48-82" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"month_covariates"</span>], beta_month_gate),</span>
<span id="cb48-83"><a href="#cb48-83" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-84"><a href="#cb48-84" aria-hidden="true" tabindex="-1"></a>    month_component_mean <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb48-85"><a href="#cb48-85" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"month_component_mean"</span>,</span>
<span id="cb48-86"><a href="#cb48-86" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"month_covariates"</span>], beta_month_mean),</span>
<span id="cb48-87"><a href="#cb48-87" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-88"><a href="#cb48-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Hour component</span></span>
<span id="cb48-89"><a href="#cb48-89" aria-hidden="true" tabindex="-1"></a>    hour_component_gate <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb48-90"><a href="#cb48-90" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"hour_component_gate"</span>,</span>
<span id="cb48-91"><a href="#cb48-91" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"hour_covariates"</span>], beta_hour_gate),</span>
<span id="cb48-92"><a href="#cb48-92" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-93"><a href="#cb48-93" aria-hidden="true" tabindex="-1"></a>    hour_component_mean <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb48-94"><a href="#cb48-94" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"hour_component_mean"</span>,</span>
<span id="cb48-95"><a href="#cb48-95" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"hour_covariates"</span>], beta_hour_mean),</span>
<span id="cb48-96"><a href="#cb48-96" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-97"><a href="#cb48-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-98"><a href="#cb48-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Temporal components</span></span>
<span id="cb48-99"><a href="#cb48-99" aria-hidden="true" tabindex="-1"></a>    temporal_component_gate <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb48-100"><a href="#cb48-100" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"temporal_component_gate"</span>,</span>
<span id="cb48-101"><a href="#cb48-101" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>year_component_gate <span class="op">+</span> month_component_gate <span class="op">+</span> hour_component_gate,</span>
<span id="cb48-102"><a href="#cb48-102" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-103"><a href="#cb48-103" aria-hidden="true" tabindex="-1"></a>    temporal_component_mean <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb48-104"><a href="#cb48-104" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"temporal_component_mean"</span>,</span>
<span id="cb48-105"><a href="#cb48-105" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>year_component_mean <span class="op">+</span> month_component_mean <span class="op">+</span> hour_component_mean,</span>
<span id="cb48-106"><a href="#cb48-106" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-107"><a href="#cb48-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-108"><a href="#cb48-108" aria-hidden="true" tabindex="-1"></a>    gate <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb48-109"><a href="#cb48-109" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"gate"</span>,</span>
<span id="cb48-110"><a href="#cb48-110" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span><span class="dv">1</span> <span class="op">-</span> expit(alpha_gate <span class="op">+</span> temporal_component_gate),</span>
<span id="cb48-111"><a href="#cb48-111" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-112"><a href="#cb48-112" aria-hidden="true" tabindex="-1"></a>    mean <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb48-113"><a href="#cb48-113" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"mean"</span>,</span>
<span id="cb48-114"><a href="#cb48-114" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.exp(alpha_mean <span class="op">+</span> temporal_component_mean),</span>
<span id="cb48-115"><a href="#cb48-115" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-116"><a href="#cb48-116" aria-hidden="true" tabindex="-1"></a>    rate <span class="op">=</span> numpyro.sample(</span>
<span id="cb48-117"><a href="#cb48-117" aria-hidden="true" tabindex="-1"></a>        <span class="st">"rate"</span>,</span>
<span id="cb48-118"><a href="#cb48-118" aria-hidden="true" tabindex="-1"></a>        prior_rate,</span>
<span id="cb48-119"><a href="#cb48-119" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-120"><a href="#cb48-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-121"><a href="#cb48-121" aria-hidden="true" tabindex="-1"></a>    obs <span class="op">=</span> numpyro.sample(</span>
<span id="cb48-122"><a href="#cb48-122" aria-hidden="true" tabindex="-1"></a>        <span class="st">"obs"</span>,</span>
<span id="cb48-123"><a href="#cb48-123" aria-hidden="true" tabindex="-1"></a>        ZeroInflatedDistribution(</span>
<span id="cb48-124"><a href="#cb48-124" aria-hidden="true" tabindex="-1"></a>            base_dist<span class="op">=</span>NegativeBinomial2(mean, rate),</span>
<span id="cb48-125"><a href="#cb48-125" aria-hidden="true" tabindex="-1"></a>            gate<span class="op">=</span>gate,</span>
<span id="cb48-126"><a href="#cb48-126" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb48-127"><a href="#cb48-127" aria-hidden="true" tabindex="-1"></a>        obs<span class="op">=</span>target,</span>
<span id="cb48-128"><a href="#cb48-128" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-129"><a href="#cb48-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> target <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb48-130"><a href="#cb48-130" aria-hidden="true" tabindex="-1"></a>        numpyro.deterministic(</span>
<span id="cb48-131"><a href="#cb48-131" aria-hidden="true" tabindex="-1"></a>            <span class="st">"log_likelihood"</span>,</span>
<span id="cb48-132"><a href="#cb48-132" aria-hidden="true" tabindex="-1"></a>            ZeroInflatedDistribution(</span>
<span id="cb48-133"><a href="#cb48-133" aria-hidden="true" tabindex="-1"></a>                base_dist<span class="op">=</span>NegativeBinomial2(mean, rate),</span>
<span id="cb48-134"><a href="#cb48-134" aria-hidden="true" tabindex="-1"></a>                gate<span class="op">=</span>gate,</span>
<span id="cb48-135"><a href="#cb48-135" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb48-136"><a href="#cb48-136" aria-hidden="true" tabindex="-1"></a>            .log_prob(target)</span>
<span id="cb48-137"><a href="#cb48-137" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb48-138"><a href="#cb48-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-139"><a href="#cb48-139" aria-hidden="true" tabindex="-1"></a>pooled_zero_inflated_regression_parameters <span class="op">=</span> [</span>
<span id="cb48-140"><a href="#cb48-140" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rate"</span>,</span>
<span id="cb48-141"><a href="#cb48-141" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_gate"</span>,</span>
<span id="cb48-142"><a href="#cb48-142" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_year_gate"</span>,</span>
<span id="cb48-143"><a href="#cb48-143" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_month_gate"</span>,</span>
<span id="cb48-144"><a href="#cb48-144" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_hour_gate"</span>,</span>
<span id="cb48-145"><a href="#cb48-145" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_mean"</span>,</span>
<span id="cb48-146"><a href="#cb48-146" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_year_mean"</span>,</span>
<span id="cb48-147"><a href="#cb48-147" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_month_mean"</span>,</span>
<span id="cb48-148"><a href="#cb48-148" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_hour_mean"</span>,</span>
<span id="cb48-149"><a href="#cb48-149" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gate"</span>,</span>
<span id="cb48-150"><a href="#cb48-150" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mean"</span>,</span>
<span id="cb48-151"><a href="#cb48-151" aria-hidden="true" tabindex="-1"></a>    <span class="st">"obs"</span>,</span>
<span id="cb48-152"><a href="#cb48-152" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb48-153"><a href="#cb48-153" aria-hidden="true" tabindex="-1"></a>pooled_zero_inflated_regression_kwargs <span class="op">=</span> {</span>
<span id="cb48-154"><a href="#cb48-154" aria-hidden="true" tabindex="-1"></a>    <span class="st">"covariates"</span>: zero_inflated_regression_covariates,</span>
<span id="cb48-155"><a href="#cb48-155" aria-hidden="true" tabindex="-1"></a>    <span class="st">"target"</span>: zero_inflated_regression_target,</span>
<span id="cb48-156"><a href="#cb48-156" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_rate"</span>: InverseGamma(<span class="fl">0.4</span>, <span class="fl">0.3</span>),</span>
<span id="cb48-157"><a href="#cb48-157" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_alpha_gate"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="fl">1.</span>),</span>
<span id="cb48-158"><a href="#cb48-158" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_year_gate"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="fl">1.</span>),</span>
<span id="cb48-159"><a href="#cb48-159" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_month_gate"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="fl">1.</span>),</span>
<span id="cb48-160"><a href="#cb48-160" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_hour_gate"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="fl">1.</span>),</span>
<span id="cb48-161"><a href="#cb48-161" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_alpha_mean"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="fl">1.</span>),</span>
<span id="cb48-162"><a href="#cb48-162" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_year_mean"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="fl">1.</span>),</span>
<span id="cb48-163"><a href="#cb48-163" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_month_mean"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="fl">1.</span>),</span>
<span id="cb48-164"><a href="#cb48-164" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_hour_mean"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="fl">1.</span>),</span>
<span id="cb48-165"><a href="#cb48-165" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-166"><a href="#cb48-166" aria-hidden="true" tabindex="-1"></a>numpyro.render_model(</span>
<span id="cb48-167"><a href="#cb48-167" aria-hidden="true" tabindex="-1"></a>    pooled_zero_inflated_negative_binomial_regression,</span>
<span id="cb48-168"><a href="#cb48-168" aria-hidden="true" tabindex="-1"></a>    model_kwargs<span class="op">=</span>pooled_zero_inflated_regression_kwargs,</span>
<span id="cb48-169"><a href="#cb48-169" aria-hidden="true" tabindex="-1"></a>    render_distributions<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb48-170"><a href="#cb48-170" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-40-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="56e62bda" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    svi_pooled_zero_inflated_regression_parameters,</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    svi_pooled_zero_inflated_regression_guide,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">=</span> sample_using_svi(</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    rng_key<span class="op">=</span>RNG_KEY,</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>pooled_zero_inflated_negative_binomial_regression,</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    model_kwargs<span class="op">=</span>pooled_zero_inflated_regression_kwargs,</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    autoguide<span class="op">=</span>AutoLowRankMultivariateNormal,</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    guide_kwargs<span class="op">=</span>{},</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    optimizer_kwargs<span class="op">=</span>{<span class="st">"step_size"</span>: <span class="fl">1e-4</span>, <span class="st">"clip_norm"</span>: <span class="dv">5</span>},</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    num_steps<span class="op">=</span>NUMBER_ITERATIONS,</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    num_particles<span class="op">=</span>NUMBER_PARTICLES,</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>  0%|          | 0/100 [00:00&lt;?, ?it/s]  1%|          | 1/100 [00:00&lt;01:08,  1.45it/s] 10%|█         | 10/100 [00:00&lt;00:05, 16.40it/s, init loss: 26211.6211, avg. loss [6-10]: 26363.3594] 20%|██        | 20/100 [00:00&lt;00:02, 32.13it/s, init loss: 26211.6211, avg. loss [16-20]: 26311.1816] 30%|███       | 30/100 [00:01&lt;00:01, 45.70it/s, init loss: 26211.6211, avg. loss [26-30]: 27444.9961] 40%|████      | 40/100 [00:01&lt;00:01, 57.00it/s, init loss: 26211.6211, avg. loss [36-40]: 27344.7129] 50%|█████     | 50/100 [00:01&lt;00:00, 65.83it/s, init loss: 26211.6211, avg. loss [46-50]: 27010.3789] 60%|██████    | 60/100 [00:01&lt;00:00, 72.68it/s, init loss: 26211.6211, avg. loss [56-60]: 26880.2246] 70%|███████   | 70/100 [00:01&lt;00:00, 77.86it/s, init loss: 26211.6211, avg. loss [66-70]: 27138.0352] 80%|████████  | 80/100 [00:01&lt;00:00, 81.87it/s, init loss: 26211.6211, avg. loss [76-80]: 26617.7383] 90%|█████████ | 90/100 [00:01&lt;00:00, 84.24it/s, init loss: 26211.6211, avg. loss [86-90]: 26915.8555] 99%|█████████▉| 99/100 [00:01&lt;00:00, 85.46it/s, init loss: 26211.6211, avg. loss [91-95]: 26201.1523]100%|██████████| 100/100 [00:01&lt;00:00, 55.88it/s, init loss: 26211.6211, avg. loss [96-100]: 27439.7871]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-41-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="b1365151" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>posterior_pooled_zero_inflated_regression_svi <span class="op">=</span> sample_posterior_predictive_svi(</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    rng_key<span class="op">=</span>RNG_KEY,</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>pooled_zero_inflated_negative_binomial_regression,</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    guide<span class="op">=</span>svi_pooled_zero_inflated_regression_guide,</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    covariates_hat<span class="op">=</span>zero_inflated_regression_covariates_hat,</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    svi_result<span class="op">=</span>svi_pooled_zero_inflated_regression_parameters,</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    num_samples<span class="op">=</span><span class="dv">1500</span>,</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    model_kwargs<span class="op">=</span>pooled_zero_inflated_regression_kwargs,</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    return_sites<span class="op">=</span>pooled_zero_inflated_regression_parameters,</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="425146b5" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>visualize_geo_regression(</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    covariates_hat_df<span class="op">=</span>zero_inflated_regression_covariates_hat_df,</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    posterior<span class="op">=</span>posterior_pooled_zero_inflated_regression_svi,</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    parameter<span class="op">=</span><span class="st">"alpha_gate"</span>,</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-43-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="f81b7b35" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>visualize_geo_regression(</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    covariates_hat_df<span class="op">=</span>zero_inflated_regression_covariates_hat_df,</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    posterior<span class="op">=</span>posterior_pooled_zero_inflated_regression_svi,</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    parameter<span class="op">=</span><span class="st">"alpha_mean"</span>,</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-44-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="28ee6ca3" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> visualize_temporal_components(</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    temporal_components<span class="op">=</span>generate_temporal_components(</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>        posterior<span class="op">=</span>posterior_pooled_zero_inflated_regression_svi,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>        transformers<span class="op">=</span>zero_inflated_regression_transformers,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>        years<span class="op">=</span>count_state_modelling_df[YEAR_COVARIATES].unique(),</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>        suffix<span class="op">=</span><span class="st">"_gate"</span>,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-45-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="772fea51" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> visualize_temporal_components(</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    temporal_components<span class="op">=</span>generate_temporal_components(</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>        posterior<span class="op">=</span>posterior_pooled_zero_inflated_regression_svi,</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>        transformers<span class="op">=</span>zero_inflated_regression_transformers,</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>        years<span class="op">=</span>count_state_modelling_df[YEAR_COVARIATES].unique(),</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>        suffix<span class="op">=</span><span class="st">"_mean"</span>,</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-46-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><strong>Partially Pooled</strong></p>
<p>$$ <span class="math display">\[\begin{gather}
\color{RedOrange}\sigma_{Gate, County} \sim HalfCauchy(\sigma=5) \\
\color{RedOrange}\mu_{Gate, County} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\color{RedOrange}\alpha_{Gate, County} \sim \mathcal{N}(\mu_{GateCounty}, \sigma_{GateCounty}) \\

\color{NavyBlue}\sigma_{Mean, County} \sim HalfCauchy(\sigma=5) \\
\color{NavyBlue}\mu_{Mean, County} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\color{NavyBlue}\alpha_{Mean, County} \sim \mathcal{N}(\mu_{MeanCounty}, \sigma_{MeanCounty}) \\
\\
\color{RedOrange}\beta_{GateHour} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\color{RedOrange}\beta_{GateMonth} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\color{RedOrange}\beta_{GateYear} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\color{NavyBlue}\beta_{MeanHour} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\color{NavyBlue}\beta_{MeanMonth} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\color{NavyBlue}\beta_{MeanYear} \sim \mathcal{N}(\mu=0, \sigma=1) \\
\\
\color{RedOrange}p = expit(\alpha_{Gate, County} + \beta_{GateHour}f(hour) + \beta_{GateMonth}f(month) + \beta_{GateYear}f(year))\\
\color{NavyBlue}\mu = exp(\alpha_{Mean, County} + \beta_{MeanHour}f(hour) + \beta_{MeanMonth}f(month) + \beta_{GateYear}f(year))\\
\\
\lambda \sim InverseGamma(0.3, 0.4)\\

\ y \sim ZeroInflatedNegativeBinomial(p, \mu, \lambda)
\end{gather}\]</span> $$</p>
<div id="83c994bc" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>reparam_config <span class="op">=</span> {<span class="st">"alpha_gate"</span>: LocScaleReparam(<span class="dv">0</span>), <span class="st">"alpha_mean"</span>: LocScaleReparam(<span class="dv">0</span>)}</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="at">@numpyro.handlers.reparam</span>(config<span class="op">=</span>reparam_config)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hierarchical_zero_inflated_negative_binomial_regression(</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    target: ArrayLike,</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    covariates: Dict[<span class="bu">str</span>, ArrayLike],</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    prior_rate: Distribution,</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    prior_beta_year_gate: Distribution,</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    prior_beta_month_gate: Distribution,</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    prior_beta_hour_gate: Distribution,</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>    prior_beta_year_mean: Distribution,</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    prior_beta_month_mean: Distribution,</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    prior_beta_hour_mean: Distribution,</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    prior_mu_alpha_gate: Distribution,</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>    prior_sigma_alpha_gate: Distribution,</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>    prior_mu_alpha_mean: Distribution,</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>    prior_sigma_alpha_mean: Distribution,</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Hierarchical zero-inflated Negative Binomial regression model"""</span></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>    number_groups <span class="op">=</span> <span class="bu">len</span>(np.unique(covariates[<span class="st">"counties_index"</span>]))</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>    counties_index <span class="op">=</span> covariates[<span class="st">"counties_index"</span>].flatten()</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>    mu_alpha_gate <span class="op">=</span> numpyro.sample(</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mu_alpha_gate"</span>,</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>        prior_mu_alpha_gate,</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>    sigma_alpha_gate <span class="op">=</span> numpyro.sample(</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sigma_alpha_gate"</span>,</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>        prior_sigma_alpha_gate,</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>    mu_alpha_mean <span class="op">=</span> numpyro.sample(</span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mu_alpha_mean"</span>,</span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>        prior_mu_alpha_mean,</span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>    sigma_alpha_mean <span class="op">=</span> numpyro.sample(</span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sigma_alpha_mean"</span>,</span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>        prior_sigma_alpha_mean,</span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> numpyro.plate(<span class="st">"counties"</span>, size<span class="op">=</span>number_groups):</span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>        alpha_gate <span class="op">=</span> numpyro.sample(</span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">"alpha_gate"</span>,</span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a>            Normal(mu_alpha_gate, sigma_alpha_gate),</span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a>        alpha_mean <span class="op">=</span> numpyro.sample(</span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a>            <span class="st">"alpha_mean"</span>,</span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a>            Normal(mu_alpha_mean, sigma_alpha_mean),</span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> numpyro.plate(</span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">"year_spline_coefficients"</span>, size<span class="op">=</span>covariates[<span class="st">"year_covariates"</span>].shape[<span class="dv">1</span>]</span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a>        beta_year_gate <span class="op">=</span> numpyro.sample(</span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_year_gate"</span>,</span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a>            prior_beta_year_gate,</span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true" tabindex="-1"></a>        beta_year_mean <span class="op">=</span> numpyro.sample(</span>
<span id="cb56-60"><a href="#cb56-60" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_year_mean"</span>,</span>
<span id="cb56-61"><a href="#cb56-61" aria-hidden="true" tabindex="-1"></a>            prior_beta_year_mean,</span>
<span id="cb56-62"><a href="#cb56-62" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-63"><a href="#cb56-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-64"><a href="#cb56-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> numpyro.plate(</span>
<span id="cb56-65"><a href="#cb56-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">"hour_spline_coefficients"</span>, size<span class="op">=</span>covariates[<span class="st">"hour_covariates"</span>].shape[<span class="dv">1</span>]</span>
<span id="cb56-66"><a href="#cb56-66" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb56-67"><a href="#cb56-67" aria-hidden="true" tabindex="-1"></a>        beta_hour_gate <span class="op">=</span> numpyro.sample(</span>
<span id="cb56-68"><a href="#cb56-68" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_hour_gate"</span>,</span>
<span id="cb56-69"><a href="#cb56-69" aria-hidden="true" tabindex="-1"></a>            prior_beta_hour_gate,</span>
<span id="cb56-70"><a href="#cb56-70" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-71"><a href="#cb56-71" aria-hidden="true" tabindex="-1"></a>        beta_hour_mean <span class="op">=</span> numpyro.sample(</span>
<span id="cb56-72"><a href="#cb56-72" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_hour_mean"</span>,</span>
<span id="cb56-73"><a href="#cb56-73" aria-hidden="true" tabindex="-1"></a>            prior_beta_hour_mean,</span>
<span id="cb56-74"><a href="#cb56-74" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-75"><a href="#cb56-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-76"><a href="#cb56-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> numpyro.plate(</span>
<span id="cb56-77"><a href="#cb56-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">"month_spline_coefficients"</span>, size<span class="op">=</span>covariates[<span class="st">"month_covariates"</span>].shape[<span class="dv">1</span>]</span>
<span id="cb56-78"><a href="#cb56-78" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb56-79"><a href="#cb56-79" aria-hidden="true" tabindex="-1"></a>        beta_month_gate <span class="op">=</span> numpyro.sample(</span>
<span id="cb56-80"><a href="#cb56-80" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_month_gate"</span>,</span>
<span id="cb56-81"><a href="#cb56-81" aria-hidden="true" tabindex="-1"></a>            prior_beta_month_gate,</span>
<span id="cb56-82"><a href="#cb56-82" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-83"><a href="#cb56-83" aria-hidden="true" tabindex="-1"></a>        beta_month_mean <span class="op">=</span> numpyro.sample(</span>
<span id="cb56-84"><a href="#cb56-84" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_month_mean"</span>,</span>
<span id="cb56-85"><a href="#cb56-85" aria-hidden="true" tabindex="-1"></a>            prior_beta_month_mean,</span>
<span id="cb56-86"><a href="#cb56-86" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-87"><a href="#cb56-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-88"><a href="#cb56-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Year component</span></span>
<span id="cb56-89"><a href="#cb56-89" aria-hidden="true" tabindex="-1"></a>    year_component_gate <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb56-90"><a href="#cb56-90" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"year_component_gate"</span>,</span>
<span id="cb56-91"><a href="#cb56-91" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"year_covariates"</span>], beta_year_gate),</span>
<span id="cb56-92"><a href="#cb56-92" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-93"><a href="#cb56-93" aria-hidden="true" tabindex="-1"></a>    year_component_mean <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb56-94"><a href="#cb56-94" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"year_component_mean"</span>,</span>
<span id="cb56-95"><a href="#cb56-95" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"year_covariates"</span>], beta_year_mean),</span>
<span id="cb56-96"><a href="#cb56-96" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-97"><a href="#cb56-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Month component</span></span>
<span id="cb56-98"><a href="#cb56-98" aria-hidden="true" tabindex="-1"></a>    month_component_gate <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb56-99"><a href="#cb56-99" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"month_component_gate"</span>,</span>
<span id="cb56-100"><a href="#cb56-100" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"month_covariates"</span>], beta_month_gate),</span>
<span id="cb56-101"><a href="#cb56-101" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-102"><a href="#cb56-102" aria-hidden="true" tabindex="-1"></a>    month_component_mean <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb56-103"><a href="#cb56-103" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"month_component_mean"</span>,</span>
<span id="cb56-104"><a href="#cb56-104" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"month_covariates"</span>], beta_month_mean),</span>
<span id="cb56-105"><a href="#cb56-105" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-106"><a href="#cb56-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Hour component</span></span>
<span id="cb56-107"><a href="#cb56-107" aria-hidden="true" tabindex="-1"></a>    hour_component_gate <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb56-108"><a href="#cb56-108" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"hour_component_gate"</span>,</span>
<span id="cb56-109"><a href="#cb56-109" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"hour_covariates"</span>], beta_hour_gate),</span>
<span id="cb56-110"><a href="#cb56-110" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-111"><a href="#cb56-111" aria-hidden="true" tabindex="-1"></a>    hour_component_mean <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb56-112"><a href="#cb56-112" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"hour_component_mean"</span>,</span>
<span id="cb56-113"><a href="#cb56-113" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.dot(covariates[<span class="st">"hour_covariates"</span>], beta_hour_mean),</span>
<span id="cb56-114"><a href="#cb56-114" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-115"><a href="#cb56-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-116"><a href="#cb56-116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Temporal components</span></span>
<span id="cb56-117"><a href="#cb56-117" aria-hidden="true" tabindex="-1"></a>    temporal_component_gate <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb56-118"><a href="#cb56-118" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"temporal_component_gate"</span>,</span>
<span id="cb56-119"><a href="#cb56-119" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>year_component_gate <span class="op">+</span> month_component_gate <span class="op">+</span> hour_component_gate,</span>
<span id="cb56-120"><a href="#cb56-120" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-121"><a href="#cb56-121" aria-hidden="true" tabindex="-1"></a>    temporal_component_mean <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb56-122"><a href="#cb56-122" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"temporal_component_mean"</span>,</span>
<span id="cb56-123"><a href="#cb56-123" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>year_component_mean <span class="op">+</span> month_component_mean <span class="op">+</span> hour_component_mean,</span>
<span id="cb56-124"><a href="#cb56-124" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-125"><a href="#cb56-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-126"><a href="#cb56-126" aria-hidden="true" tabindex="-1"></a>    spatial_component_mean <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb56-127"><a href="#cb56-127" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"spatial_component_mean"</span>,</span>
<span id="cb56-128"><a href="#cb56-128" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>alpha_mean[counties_index],</span>
<span id="cb56-129"><a href="#cb56-129" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-130"><a href="#cb56-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-131"><a href="#cb56-131" aria-hidden="true" tabindex="-1"></a>    spatial_component_gate <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb56-132"><a href="#cb56-132" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"spatial_component_gate"</span>,</span>
<span id="cb56-133"><a href="#cb56-133" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>alpha_gate[counties_index],</span>
<span id="cb56-134"><a href="#cb56-134" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-135"><a href="#cb56-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-136"><a href="#cb56-136" aria-hidden="true" tabindex="-1"></a>    gate <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb56-137"><a href="#cb56-137" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"gate"</span>,</span>
<span id="cb56-138"><a href="#cb56-138" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span><span class="dv">1</span> <span class="op">-</span> expit(spatial_component_gate <span class="op">+</span> temporal_component_gate),</span>
<span id="cb56-139"><a href="#cb56-139" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-140"><a href="#cb56-140" aria-hidden="true" tabindex="-1"></a>    mean <span class="op">=</span> numpyro.deterministic(</span>
<span id="cb56-141"><a href="#cb56-141" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"mean"</span>,</span>
<span id="cb56-142"><a href="#cb56-142" aria-hidden="true" tabindex="-1"></a>        value<span class="op">=</span>jnp.exp(spatial_component_mean <span class="op">+</span> temporal_component_mean),</span>
<span id="cb56-143"><a href="#cb56-143" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-144"><a href="#cb56-144" aria-hidden="true" tabindex="-1"></a>    rate <span class="op">=</span> numpyro.sample(</span>
<span id="cb56-145"><a href="#cb56-145" aria-hidden="true" tabindex="-1"></a>        <span class="st">"rate"</span>,</span>
<span id="cb56-146"><a href="#cb56-146" aria-hidden="true" tabindex="-1"></a>        prior_rate,</span>
<span id="cb56-147"><a href="#cb56-147" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-148"><a href="#cb56-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-149"><a href="#cb56-149" aria-hidden="true" tabindex="-1"></a>    obs <span class="op">=</span> numpyro.sample(</span>
<span id="cb56-150"><a href="#cb56-150" aria-hidden="true" tabindex="-1"></a>        <span class="st">"obs"</span>,</span>
<span id="cb56-151"><a href="#cb56-151" aria-hidden="true" tabindex="-1"></a>        ZeroInflatedDistribution(</span>
<span id="cb56-152"><a href="#cb56-152" aria-hidden="true" tabindex="-1"></a>            base_dist<span class="op">=</span>NegativeBinomial2(mean, rate),</span>
<span id="cb56-153"><a href="#cb56-153" aria-hidden="true" tabindex="-1"></a>            gate<span class="op">=</span>gate,</span>
<span id="cb56-154"><a href="#cb56-154" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb56-155"><a href="#cb56-155" aria-hidden="true" tabindex="-1"></a>        obs<span class="op">=</span>target,</span>
<span id="cb56-156"><a href="#cb56-156" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-157"><a href="#cb56-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-158"><a href="#cb56-158" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> target <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb56-159"><a href="#cb56-159" aria-hidden="true" tabindex="-1"></a>        numpyro.deterministic(</span>
<span id="cb56-160"><a href="#cb56-160" aria-hidden="true" tabindex="-1"></a>            <span class="st">"log_likelihood"</span>,</span>
<span id="cb56-161"><a href="#cb56-161" aria-hidden="true" tabindex="-1"></a>            ZeroInflatedDistribution(</span>
<span id="cb56-162"><a href="#cb56-162" aria-hidden="true" tabindex="-1"></a>                base_dist<span class="op">=</span>NegativeBinomial2(mean, rate),</span>
<span id="cb56-163"><a href="#cb56-163" aria-hidden="true" tabindex="-1"></a>                gate<span class="op">=</span>gate,</span>
<span id="cb56-164"><a href="#cb56-164" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb56-165"><a href="#cb56-165" aria-hidden="true" tabindex="-1"></a>            .log_prob(target)</span>
<span id="cb56-166"><a href="#cb56-166" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb56-167"><a href="#cb56-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-168"><a href="#cb56-168" aria-hidden="true" tabindex="-1"></a>hierarchical_zero_inflated_regression_parameters <span class="op">=</span> [</span>
<span id="cb56-169"><a href="#cb56-169" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rate"</span>,</span>
<span id="cb56-170"><a href="#cb56-170" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mean"</span>,</span>
<span id="cb56-171"><a href="#cb56-171" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gate"</span>,</span>
<span id="cb56-172"><a href="#cb56-172" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mu_alpha_gate"</span>,</span>
<span id="cb56-173"><a href="#cb56-173" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sigma_alpha_gate"</span>,</span>
<span id="cb56-174"><a href="#cb56-174" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mu_alpha_mean"</span>,</span>
<span id="cb56-175"><a href="#cb56-175" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sigma_alpha_mean"</span>,</span>
<span id="cb56-176"><a href="#cb56-176" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_gate"</span>,</span>
<span id="cb56-177"><a href="#cb56-177" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spatial_component_mean"</span>,</span>
<span id="cb56-178"><a href="#cb56-178" aria-hidden="true" tabindex="-1"></a>    <span class="st">"spatial_component_gate"</span>,</span>
<span id="cb56-179"><a href="#cb56-179" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alpha_mean"</span>,</span>
<span id="cb56-180"><a href="#cb56-180" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_year_mean"</span>,</span>
<span id="cb56-181"><a href="#cb56-181" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_month_mean"</span>,</span>
<span id="cb56-182"><a href="#cb56-182" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_hour_mean"</span>,</span>
<span id="cb56-183"><a href="#cb56-183" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_year_gate"</span>,</span>
<span id="cb56-184"><a href="#cb56-184" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_month_gate"</span>,</span>
<span id="cb56-185"><a href="#cb56-185" aria-hidden="true" tabindex="-1"></a>    <span class="st">"beta_hour_gate"</span>,</span>
<span id="cb56-186"><a href="#cb56-186" aria-hidden="true" tabindex="-1"></a>    <span class="st">"obs"</span>,</span>
<span id="cb56-187"><a href="#cb56-187" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb56-188"><a href="#cb56-188" aria-hidden="true" tabindex="-1"></a>hierarchical_zero_inflated_regression_kwargs <span class="op">=</span> {</span>
<span id="cb56-189"><a href="#cb56-189" aria-hidden="true" tabindex="-1"></a>    <span class="st">"covariates"</span>: zero_inflated_regression_covariates,</span>
<span id="cb56-190"><a href="#cb56-190" aria-hidden="true" tabindex="-1"></a>    <span class="st">"target"</span>: zero_inflated_regression_target,</span>
<span id="cb56-191"><a href="#cb56-191" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_rate"</span>: InverseGamma(<span class="fl">0.4</span>, <span class="fl">0.3</span>),</span>
<span id="cb56-192"><a href="#cb56-192" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_mu_alpha_gate"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb56-193"><a href="#cb56-193" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_sigma_alpha_gate"</span>: HalfCauchy(<span class="dv">5</span>),</span>
<span id="cb56-194"><a href="#cb56-194" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_mu_alpha_mean"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb56-195"><a href="#cb56-195" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_sigma_alpha_mean"</span>: HalfCauchy(<span class="dv">5</span>),</span>
<span id="cb56-196"><a href="#cb56-196" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_year_gate"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb56-197"><a href="#cb56-197" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_month_gate"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb56-198"><a href="#cb56-198" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_hour_gate"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb56-199"><a href="#cb56-199" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_year_mean"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb56-200"><a href="#cb56-200" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_month_mean"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb56-201"><a href="#cb56-201" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prior_beta_hour_mean"</span>: Normal(loc<span class="op">=</span><span class="fl">0.0</span>, scale<span class="op">=</span><span class="dv">1</span>),</span>
<span id="cb56-202"><a href="#cb56-202" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-203"><a href="#cb56-203" aria-hidden="true" tabindex="-1"></a>numpyro.render_model(</span>
<span id="cb56-204"><a href="#cb56-204" aria-hidden="true" tabindex="-1"></a>    hierarchical_zero_inflated_negative_binomial_regression,</span>
<span id="cb56-205"><a href="#cb56-205" aria-hidden="true" tabindex="-1"></a>    model_kwargs<span class="op">=</span>hierarchical_zero_inflated_regression_kwargs,</span>
<span id="cb56-206"><a href="#cb56-206" aria-hidden="true" tabindex="-1"></a>    render_distributions<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb56-207"><a href="#cb56-207" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-47-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="8f8e1b95" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    svi_hierarchical_zero_inflated_regression_parameters,</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    svi_hierarchical_zero_inflated_regression_guide,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">=</span> sample_using_svi(</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    rng_key<span class="op">=</span>RNG_KEY,</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>hierarchical_zero_inflated_negative_binomial_regression,</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    model_kwargs<span class="op">=</span>hierarchical_zero_inflated_regression_kwargs,</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    autoguide<span class="op">=</span>AutoLowRankMultivariateNormal,</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    guide_kwargs<span class="op">=</span>{},</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    optimizer_kwargs<span class="op">=</span>{<span class="st">"step_size"</span>: <span class="fl">1e-4</span>, <span class="st">"clip_norm"</span>: <span class="dv">5</span>},</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    num_steps<span class="op">=</span>NUMBER_ITERATIONS,</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    num_particles<span class="op">=</span>NUMBER_PARTICLES,</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>  0%|          | 0/100 [00:00&lt;?, ?it/s]  1%|          | 1/100 [00:00&lt;01:18,  1.27it/s]  9%|▉         | 9/100 [00:00&lt;00:06, 13.31it/s, init loss: 35326.1836, avg. loss [1-5]: 39163.5781] 18%|█▊        | 18/100 [00:00&lt;00:03, 26.89it/s, init loss: 35326.1836, avg. loss [11-15]: 39138.2695] 27%|██▋       | 27/100 [00:01&lt;00:01, 39.43it/s, init loss: 35326.1836, avg. loss [21-25]: 36557.6445] 36%|███▌      | 36/100 [00:01&lt;00:01, 50.22it/s, init loss: 35326.1836, avg. loss [31-35]: 37389.9453] 45%|████▌     | 45/100 [00:01&lt;00:00, 59.31it/s, init loss: 35326.1836, avg. loss [41-45]: 38235.6836] 54%|█████▍    | 54/100 [00:01&lt;00:00, 66.32it/s, init loss: 35326.1836, avg. loss [46-50]: 36664.7383] 63%|██████▎   | 63/100 [00:01&lt;00:00, 71.98it/s, init loss: 35326.1836, avg. loss [56-60]: 36305.8047] 72%|███████▏  | 72/100 [00:01&lt;00:00, 76.32it/s, init loss: 35326.1836, avg. loss [66-70]: 38509.9609] 81%|████████  | 81/100 [00:01&lt;00:00, 79.57it/s, init loss: 35326.1836, avg. loss [76-80]: 35461.6250] 90%|█████████ | 90/100 [00:01&lt;00:00, 81.88it/s, init loss: 35326.1836, avg. loss [86-90]: 38346.7344] 99%|█████████▉| 99/100 [00:01&lt;00:00, 83.04it/s, init loss: 35326.1836, avg. loss [91-95]: 36974.0664]100%|██████████| 100/100 [00:01&lt;00:00, 51.59it/s, init loss: 35326.1836, avg. loss [96-100]: 37281.2969]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-48-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="e93aa830" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>posterior_hierarchical_zero_inflated_regression_svi <span class="op">=</span> sample_posterior_predictive_svi(</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    rng_key<span class="op">=</span>RNG_KEY,</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span>hierarchical_zero_inflated_negative_binomial_regression,</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    guide<span class="op">=</span>svi_hierarchical_zero_inflated_regression_guide,</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    covariates_hat<span class="op">=</span>zero_inflated_regression_covariates_hat,</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    svi_result<span class="op">=</span>svi_hierarchical_zero_inflated_regression_parameters,</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    num_samples<span class="op">=</span><span class="dv">2000</span>,</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    model_kwargs<span class="op">=</span>hierarchical_zero_inflated_regression_kwargs,</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    return_sites<span class="op">=</span>hierarchical_zero_inflated_regression_parameters,</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d7b902f5" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>visualize_geo_regression(</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    covariates_hat_df<span class="op">=</span>zero_inflated_regression_covariates_hat_df,</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    posterior<span class="op">=</span>posterior_hierarchical_zero_inflated_regression_svi,</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    parameter<span class="op">=</span><span class="st">"spatial_component_gate"</span>,</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-50-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="633be085" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>visualize_geo_regression(</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    covariates_hat_df<span class="op">=</span>zero_inflated_regression_covariates_hat_df,</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    posterior<span class="op">=</span>posterior_hierarchical_zero_inflated_regression_svi,</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    parameter<span class="op">=</span><span class="st">"spatial_component_mean"</span>,</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-51-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="ba1e6668" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> visualize_temporal_components(</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    temporal_components<span class="op">=</span>generate_temporal_components(</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>        posterior<span class="op">=</span>posterior_hierarchical_zero_inflated_regression_svi,</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>        transformers<span class="op">=</span>zero_inflated_regression_transformers,</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>        years<span class="op">=</span>count_state_modelling_df[YEAR_COVARIATES].unique(),</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>        suffix<span class="op">=</span><span class="st">"_gate"</span>,</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-52-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="eb6bf5af" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> visualize_temporal_components(</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    temporal_components<span class="op">=</span>generate_temporal_components(</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>        posterior<span class="op">=</span>posterior_hierarchical_zero_inflated_regression_svi,</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>        transformers<span class="op">=</span>zero_inflated_regression_transformers,</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>        years<span class="op">=</span>count_state_modelling_df[YEAR_COVARIATES].unique(),</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>        suffix<span class="op">=</span><span class="st">"_mean"</span>,</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="hail_risk_estimation_files/figure-html/cell-53-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>